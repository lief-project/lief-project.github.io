<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="lang:clipboard.copy" content="Copy to clipboard">
  <meta name="lang:clipboard.copied" content="Copied to clipboard">
  <meta name="lang:search.language" content="en">
  <meta name="lang:search.pipeline.stopwords" content="True">
  <meta name="lang:search.pipeline.trimmer" content="True">
  <meta name="lang:search.result.none" content="No matching documents">
  <meta name="lang:search.result.one" content="1 matching document">
  <meta name="lang:search.result.other" content="# matching documents">
  <meta name="lang:search.tokenizer" content="[\s\-]+">
  <meta name="Description" content="LIEF Documentation">

  
    <link href="https://fonts.gstatic.com/" rel="preconnect" crossorigin>
  

  <script src="../_static/javascripts/vendor.min.js"></script>

  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
  
  
    <link rel="apple-touch-icon" href="../_static/favicon.ico"/>
  
  
  
    <title>08 - Transforming an ELF executable into a library &#8212; LIEF Documentation</title>
  <link rel="stylesheet" href="../_static/fonts/material-icons.css"/>
  <link rel="stylesheet" href="../_static/stylesheets/vendor.min.css"/>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=3d3fbe02" />
    <link rel="stylesheet" type="text/css" href="../_static/basic.css?v=fb9458d3" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=fd3f3429" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css?v=411c5307" />
    <script src="../_static/documentation_options.js?v=0c3dd48d"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="09 - How to use frida on a non-rooted device" href="09_frida_lief.html" />
    <link rel="prev" title="07 - PE Resources" href="07_pe_resource.html" />
   
  <link rel="stylesheet" href="../_static/stylesheets/theme.css"/>

  </head>
  <body dir=ltr
        data-md-color-primary=blue data-md-color-accent=cyan>
  <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom fixed-top" role="navigation">
  <a href="../index.html" class="navbar-brand">LIEF Documentation</a>
  <button class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse justify-content-center mt-2 mt-lg-0" id="navbar-collapse">
    <ul class="navbar-nav position-relative px-lg-6 px-xl-8">
          
          <li class="nav-item">
              <a class="nav-link" href="https://lief.re">
                <i class="fa-solid fa-house mr-3"></i>Home
              </a>
          </li>
          
          <li class="nav-item">
              <a class="nav-link" href="https://lief.re/blog">
                <i class="fa-solid fa-rss mr-3"></i>Blog
              </a>
          </li>
          
          <li class="nav-item">
              <a class="nav-link" href="https://lief.re/download">
                <i class="fa-solid fa-download mr-3"></i>Download
              </a>
          </li>
        <li class="nav-item dropdown">

            <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-expanded="false">
                <i class="fa-solid fa-book mr-3"></i>Documentation
            </a>
            <div class="dropdown-menu" role="menu">
             <a class="dropdown-item" href="https://lief.re/doc/latest/doxygen">Doxygen</a>
            </div>
          </li>
        
          
          <li class="nav-item">
              <a class="nav-link" href="https://lief.re/about">
                <i class="fa-solid fa-bars-staggered mr-3"></i>About
              </a>
          </li>
        <li class="nav-item ml-lg-3 mt-3 mt-lg-0">
          <a class="hover-lift-light mt-1" href="https://discord.gg/jGQtyAYChJ" target="_blank">
            <i class="fab fa-2x fa-discord text-darkblue  mr-3"></i>
          </a>
        </li>
        <li class="nav-item">
          <a href="https://github.com/sponsors/lief-project" class="btn btn-outline-pink"
            target="_blank">
            <i class="fa-solid fa-heart mr-3"></i>
            Sponsor
          </a>
        </li>
    </ul>
  </div>
</nav>



  <div class="container-fluid container-docs">
    <div class="row">
      
<div class="col-12 col-lg-3 col-xl-2 border-lg-right py-lg-5 pl-lg-4 docs-sidebar docs-sidebar-left">
  <div class="collapse d-lg-block mb-6 mb-lg-0" id="sidebar-collapse">
    <form action="../search.html" method="GET" name="search">
      <input type="text" class="form-control" placeholder="Search" autocapitalize="off" autocomplete="off" spellcheck="false"
             data-md-component="query" data-md-state="active" name="q">
    </form>

    

      
        <ul class="list-unstyled mt-3">
          <li><a href="../intro.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-solid fa-door-open"></em> Introduction</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../installation.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-solid fa-gears"></em> Installation and Integration</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../compilation.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-solid fa-laptop-code"></em> Compilation</a></li>
          
        </ul>
      

      
        <div class="text-darkblue text-uppercase font-size-normal font-weight-bolder mt-4 pt-2 mb-2">
          <span class="caption-text"><i class="fa-solid fa-sitemap"> </i>Formats</span>
        </div>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../formats/elf/index.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-brands fa-linux"></em> ELF</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../formats/macho/index.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-brands fa-apple"></em>  Mach-O</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../formats/pe/index.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-brands fa-windows"></em>  PE</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../formats/android/index.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-brands fa-android"></em> Android</a></li>
          
        </ul>
      

      
        <div class="text-darkblue text-uppercase font-size-normal font-weight-bolder mt-4 pt-2 mb-2">
          <span class="caption-text"><i class="fa-solid fa-code"> </i>API</span>
        </div>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../api/binary_abstraction/index.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-brands fa-uncharted"></em> Binary Abstraction</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../api/utilities/index.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-solid fa-hand-holding-hand"></em> Utilities</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../api/error_handling/index.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-solid fa-triangle-exclamation"></em> Error Handling</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../api/logging/index.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-regular fa-rectangle-list"></em> Logging</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../api/cpp/index.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-regular fa-file-code"></em> C++</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../api/rust/index.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-brands fa-rust"></em> Rust</a></li>
          
        </ul>
      

      
        <div class="text-darkblue text-uppercase font-size-normal font-weight-bolder mt-4 pt-2 mb-2">
          <span class="caption-text"><i class="fa-solid fa-hat-wizard"> </i>LIEF Extended</span>
        </div>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../extended/intro.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-cubes"></em> What is LIEF Extended?</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../extended/debug_info/index.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-solid fa-magnifying-glass"></em> Debug Info</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../extended/dwarf/index.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-solid fa-bars-staggered"></em> DWARF</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../extended/pdb/index.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-brands fa-windows"></em> PDB</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../extended/objc/index.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-brands fa-apple"></em> Objective-C</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../extended/dsc/index.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-solid fa-diagram-predecessor"></em> Dyld Shared Cache</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../extended/disassembler/index.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-solid fa-dna"></em> Disassembler</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../extended/assembler/index.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-solid fa-user-secret"></em> Assembler</a></li>
          
        </ul>
      

      
        <div class="text-darkblue text-uppercase font-size-normal font-weight-bolder mt-4 pt-2 mb-2">
          <span class="caption-text"><i class="fa-solid fa-layer-group"> </i>Tutorials</span>
        </div>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="01_play_with_formats.html" class="text-darkblue font-size-sm d-block mb-2">01 - Parse and manipulate formats</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="02_pe_from_scratch.html" class="text-darkblue font-size-sm d-block mb-2">02 - Create a PE from scratch (Deprecated)</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="03_elf_change_symbols.html" class="text-darkblue font-size-sm d-block mb-2">03 - Play with ELF symbols</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="04_elf_hooking.html" class="text-darkblue font-size-sm d-block mb-2">04 - ELF Hooking</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="05_elf_infect_plt_got.html" class="text-darkblue font-size-sm d-block mb-2">05 - Infecting the plt/got</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="06_pe_hooking.html" class="text-darkblue font-size-sm d-block mb-2">06 - PE Hooking (Deprecated)</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="07_pe_resource.html" class="text-darkblue font-size-sm d-block mb-2">07 - PE Resources</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="#" class="text-darkblue font-size-sm d-block mb-2">08 - Transforming an ELF executable into a library</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="09_frida_lief.html" class="text-darkblue font-size-sm d-block mb-2">09 - How to use frida on a non-rooted device</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="10_android_formats.html" class="text-darkblue font-size-sm d-block mb-2">10 - Android formats</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="11_macho_modification.html" class="text-darkblue font-size-sm d-block mb-2">11 - Mach-O Modification</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="12_elf_coredump.html" class="text-darkblue font-size-sm d-block mb-2">12 - ELF Coredump</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="13_pe_authenticode.html" class="text-darkblue font-size-sm d-block mb-2">13 - PE Authenticode</a></li>
          
        </ul>
      

      
        <div class="text-darkblue text-uppercase font-size-normal font-weight-bolder mt-4 pt-2 mb-2">
          <span class="caption-text"><i class="fa-brands fa-space-awesome"> </i>Extra Information</span>
        </div>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../references.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-fa-solid fa-book-bookmark"></em> References</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../changelog.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-solid fa-code-compare"></em> Changelog</a></li>
          
        </ul>
      
  </div>
  <hr />
  <span class="svg-icon text-purple mr-1 relative-top--1">
  <svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><title>ionicons-v5-d</title><circle cx="160" cy="96" r="48" style="fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px"></circle><circle cx="160" cy="416" r="48" style="fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px"></circle><line x1="160" y1="368" x2="160" y2="144" style="fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px"></line><circle cx="352" cy="160" r="48" style="fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px"></circle><path d="M352,208c0,128-192,48-192,160" style="fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px"></path></svg>
  </span>
  <a href="https://github.com/lief-project/LIEF/commits/dd291ae1" class="text-darkblue">0.17.0 (dd291ae1)</a>
    <br>
    Updated on 23/02/2025, 12:10:07.
</div>



      <div class="col-12 col-lg-9 col-xl-8 offset-lg-3 offset-xl-2 py-lg-5 px-lg-6 mb-8">
        
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            
            <li class="breadcrumb-item">
              <a href="../index.html" aria-label="Home"><i class="fa-solid fa-home"></i></a>
            </li>
            <li class="breadcrumb-item active" aria-current="page"><a href="#">08 - Transforming an ELF executable into a library</a></li>
          </ol>
        </nav>
        
        
  <section id="transforming-an-elf-executable-into-a-library">
<span id="tuto-elf-bin2lib"></span><h1 id="tutorials-08-elf-bin2lib--page-root">08 - Transforming an ELF executable into a library<a class="headerlink" href="#tutorials-08-elf-bin2lib--page-root" title="Link to this heading">¶</a></h1>
<p>In this tutorial, we will see how to convert a <strong>PIE</strong> executable into a library</p>
<p>Scripts and materials are available here: <a class="reference external" href="https://github.com/lief-project/tutorials/tree/master/08_ELF_bin2lib">materials</a></p>
<p>By Romain Thomas - <a class="reference external" href="https://twitter.com/rh0main">@rh0main</a> , updated by Adrien Guinet - <a class="reference external" href="https://twitter.com/adriengnt">@adriengnt</a></p>
<hr class="docutils"/>
<section id="introduction">
<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Link to this heading">¶</a></h2>
<p>Actually, if we look at the header of a ELF PIE executable one can notice that it has the same type as a shared object (i.e. library)</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>readelf<span class="w"> </span>-h<span class="w"> </span>/usr/bin/ssh<span class="p">|</span>grep<span class="w"> </span>Type
<span class="go">Type:  DYN (Shared object file)</span>

<span class="gp">$ </span>readelf<span class="w"> </span>-h<span class="w"> </span>/usr/lib/libm.so<span class="p">|</span>grep<span class="w"> </span>Type
<span class="go">Type:  DYN (Shared object file)</span>
</pre></div>
</div>
<p>Using LIEF we can access this information through the <a class="reference internal" href="../formats/elf/python.html#lief.ELF.Header.file_type" title="lief.ELF.Header.file_type"><code class="xref py py-attr docutils literal notranslate"><span class="pre">file_type</span></code></a> attribute</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">libm</span> <span class="o">=</span> <span class="n">lief</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">"/usr/lib/libm.so.6"</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">libm</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">file_type</span><span class="p">)</span>
<span class="go">E_TYPE.DYNAMIC</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">ssh</span> <span class="o">=</span> <span class="n">lief</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">"/usr/bin/ssh"</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">ss</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">file_type</span><span class="p">)</span>
<span class="go">E_TYPE.DYNAMIC</span>
</pre></div>
</div>
<p>The main difference between a PIE binaries and a shared libraries is how symbols are exported.</p>
<p>A shared library aims to expose functions so that executable can bind to it whereas executables shouldn’t not expose functions <a class="footnote-reference brackets" href="#id4" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a></p>
<p>It’s confirmed with the number of exported functions in the two different objects:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">libm</span><span class="o">.</span><span class="n">exported_functions</span><span class="p">))</span>
<span class="go">572</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ssh</span><span class="o">.</span><span class="n">exported_functions</span><span class="p">))</span>
<span class="go">10</span>
</pre></div>
</div>
<p>In this tutorial we will see how we can transform raw function addresses into exported functions associated with a symbol,
thus thus exposing internal functions of the executable.</p>
</section>
<section id="exporting-functions">
<h2 id="exporting-functions">Exporting functions<a class="headerlink" href="#exporting-functions" title="Link to this heading">¶</a></h2>
<p>Such transformation can be useful if we found a function at a given address and want to instrument it (using <code class="docutils literal notranslate"><span class="pre">dlopen</span></code>/<code class="docutils literal notranslate"><span class="pre">dlsym</span></code> for example).
Once the target function is exported we can link it as we would do for a <em>normal</em> library.</p>
<p>For example in a fuzzing scenario if one identifies a function that is a parser, we can export it and then we can feed its inputs with AFL. Thus we cut the path from the normal entrypoint to reach the function.</p>
<p>Let’s see how it works on a basic <em>crackme</em>:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span>

<span class="cp">#define NOINLINE __attribute__ ((noinline))</span>

<span class="n">NOINLINE</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">check_found</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="s">"easy"</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">**</span><span class="w"> </span><span class="n">argv</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">"Usage: %s flag</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">    </span><span class="n">exit</span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">check_found</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">"Well done!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">"Wrong!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This code takes a string as input and call the <code class="docutils literal notranslate"><span class="pre">check_found</span></code> function on this
string, then it returns <code class="docutils literal notranslate"><span class="pre">1</span></code> if the input is <code class="docutils literal notranslate"><span class="pre">easy</span></code>. <code class="docutils literal notranslate"><span class="pre">0</span></code> otherwise.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">__attribute__</span> <span class="pre">((noinline))</span></code> is used to make sure the <code class="docutils literal notranslate"><span class="pre">check_found</span></code>
function won’t be inlined by the compiler.  Indeed, if the function check is
inlined, there won’t be an address associated to this function.</p>
<p>This figure sump-up the execution flow:</p>
<figure class="align-center">
<img alt="../_images/bin2lib_a.png" src="../_images/bin2lib_a.png"/>
</figure>
<p>The <em>crackme</em> can be compiled with:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>gcc<span class="w"> </span>crackme101.c<span class="w"> </span>-O0<span class="w"> </span>-fPIE<span class="w"> </span>-pie<span class="w"> </span>-Wl,-strip-all,--hash-style<span class="o">=</span>sysv<span class="w"> </span>-o<span class="w"> </span>crackme101.bin<span class="w"> </span>-fvisibility<span class="o">=</span>hidden
<span class="gp">$ </span>./crackme101.bin<span class="w"> </span>foo
<span class="go">Wrong!</span>
<span class="gp">$ </span>./crackme101.bin<span class="w"> </span>easy
<span class="go">Well done!</span>
</pre></div>
</div>
<p>Note the usage of the <code class="docutils literal notranslate"><span class="pre">-fvisibility=hidden</span></code> flag. It makes the compiler not
automatically export functions, like the <code class="docutils literal notranslate"><span class="pre">check_found</span></code> one. By opening
<code class="docutils literal notranslate"><span class="pre">crackme101.bin</span></code> with LIEF, we can check that no functions are exported:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">lief</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">crackme101</span> <span class="o">=</span> <span class="n">lief</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">"./crackme101.bin"</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">crackme101</span><span class="o">.</span><span class="n">exported_functions</span><span class="p">))</span>
<span class="go">0</span>
</pre></div>
</div>
<p>Using a disassembler we can quickly identify the check function address:</p>
<figure class="align-center">
<img alt="../_images/crackme101_ida.png" src="../_images/crackme101_ida.png"/>
</figure>
<p>In this case, the <strong>check</strong> function is located at the address: <code class="docutils literal notranslate"><span class="pre">0x72A</span></code> <a class="footnote-reference brackets" href="#id5" id="id2" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a></p>
<p>Now that we identified the address we can export it as a named function: <code class="docutils literal notranslate"><span class="pre">check_found</span></code></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">crackme101</span><span class="o">.</span><span class="n">add_exported_function</span><span class="p">(</span><span class="mh">0x72A</span><span class="p">,</span> <span class="s2">"check_found"</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">crackme101</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"libcrackme101.so"</span><span class="p">)</span>
</pre></div>
</div>
<p>And that all!</p>
<p><code class="docutils literal notranslate"><span class="pre">libcrackme101.so</span></code> is now a <strong>library</strong> that export one function: <code class="docutils literal notranslate"><span class="pre">check_found</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">lief</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">libcrackme101</span> <span class="o">=</span> <span class="n">lief</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">"./libcrackme101.so"</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">crackme101</span><span class="o">.</span><span class="n">exported_functions</span><span class="p">))</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">crackme101</span><span class="o">.</span><span class="n">exported_functions</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="go">check_found</span>
</pre></div>
</div>
<p>It turns out that <code class="docutils literal notranslate"><span class="pre">libcrackme101.so</span></code> is still an executable:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>./libcrackme101.so<span class="w"> </span>foo
<span class="go">Wrong!</span>
<span class="gp">$ </span>./libcrackme101.so<span class="w"> </span>easy
<span class="go">Well done!</span>
</pre></div>
</div>
<p>Since we have exported a function we can now use <code class="docutils literal notranslate"><span class="pre">dlopen</span></code> on <code class="docutils literal notranslate"><span class="pre">libcrackme101.so</span></code> and
<code class="docutils literal notranslate"><span class="pre">dlsym</span></code> on <code class="docutils literal notranslate"><span class="pre">check_found</span></code></p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;dlfcn.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>

<span class="k">typedef</span><span class="w"> </span><span class="kt">int</span><span class="p">(</span><span class="o">*</span><span class="n">check_t</span><span class="p">)(</span><span class="kt">char</span><span class="o">*</span><span class="p">);</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">**</span><span class="w"> </span><span class="n">argv</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="hll"><span class="w">  </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dlopen</span><span class="p">(</span><span class="s">"./libcrackme101.so"</span><span class="p">,</span><span class="w"> </span><span class="n">RTLD_LAZY</span><span class="p">);</span>
</span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">handler</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">"dlopen error: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">dlerror</span><span class="p">());</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="hll"><span class="w">  </span><span class="n">check_t</span><span class="w"> </span><span class="n">check_found</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">check_t</span><span class="p">)</span><span class="n">dlsym</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span><span class="w"> </span><span class="s">"check_found"</span><span class="p">);</span>
</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">check_found</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

<span class="w">  </span><span class="n">printf</span><span class="p">(</span><span class="s">"Output of check_found('%s'): %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">output</span><span class="p">);</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Running the code above should give a similar output:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>gcc<span class="w"> </span>instrument.c<span class="w"> </span>-O0<span class="w"> </span>-fPIE<span class="w"> </span>-pie<span class="w"> </span>-o<span class="w"> </span>instrument.bin<span class="w"> </span>-ldl
<span class="gp">$ </span>./instrument.bin<span class="w"> </span><span class="nb">test</span>
<span class="go">Output of check('test'): 0</span>
<span class="gp">$ </span>./instrument.bin<span class="w"> </span>easy
<span class="go">Output of check('easy'): 1</span>
</pre></div>
</div>
<p>If <code class="docutils literal notranslate"><span class="pre">dlopen</span></code> returns an error, please read <a class="reference external" href="#glibc229">the following section about glibc &gt;= 2.29</a>.</p>
<p>The transformation of the execution flow can be represented as follow:</p>
<figure class="align-center">
<img alt="../_images/bin2lib_b.png" src="../_images/bin2lib_b.png"/>
</figure>
</section>
<section id="warning-for-glibc-2-29-users">
<span id="glic229"></span><h2 id="warning-for-glibc-2-29-users">Warning for glibc &gt;= 2.29 users<a class="headerlink" href="#warning-for-glibc-2-29-users" title="Link to this heading">¶</a></h2>
<p>If you are using <code class="docutils literal notranslate"><span class="pre">glibc</span> <span class="pre">&gt;=</span> <span class="pre">2.29</span></code> (or a close version depending on your Linux
distribution), you might have encountered this error while using the <cite>dlopen</cite>
function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dlopen</span> <span class="n">error</span><span class="p">:</span> <span class="n">cannot</span> <span class="n">dynamically</span> <span class="n">load</span> <span class="n">position</span><span class="o">-</span><span class="n">independent</span> <span class="n">executable</span>
</pre></div>
</div>
<p>Loading PIE binaries as shared libraries wasn’t indeed really an intended use
case for <code class="docutils literal notranslate"><span class="pre">dlopen</span></code>, and it used to work without really being properly
supported.  One of the reasons is that it <a class="reference external" href="https://sourceware.org/bugzilla/show_bug.cgi?id=11754">does not seem that trivial to
support</a> all the
possible use cases (issues with some relocations and ELF constructors).</p>
<p>These glibc versions now <a class="reference external" href="https://patchwork.ozlabs.org/project/glibc/patch/20190312130235.8E82C89CE49C@oldenburg2.str.redhat.com/">implements a check</a>
to deny calls to <code class="docutils literal notranslate"><span class="pre">dlopen</span></code> with PIE binaries. This is done by verifying the
<code class="docutils literal notranslate"><span class="pre">DF_1_PIE</span></code> flag isn’t present in the list of dynamic information flags.</p>
<p>In order to circumvent this test, LIEF can be used to remove this <code class="docutils literal notranslate"><span class="pre">DF_1_PIE</span></code> flag:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">lief</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">path</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">bin_</span> <span class="o">=</span> <span class="n">lief</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="hll"><span class="n">bin_</span><span class="p">[</span><span class="n">lief</span><span class="o">.</span><span class="n">ELF</span><span class="o">.</span><span class="n">DynamicEntry</span><span class="o">.</span><span class="n">TAG</span><span class="o">.</span><span class="n">FLAGS_1</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">lief</span><span class="o">.</span><span class="n">ELF</span><span class="o">.</span><span class="n">DynamicEntryFlags</span><span class="o">.</span><span class="n">FLAG</span><span class="o">.</span><span class="n">PIE</span><span class="p">)</span>
</span><span class="n">bin_</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s2">".patched"</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="conclusion">
<h2 id="conclusion">Conclusion<a class="headerlink" href="#conclusion" title="Link to this heading">¶</a></h2>
<p>Because PIE executables aim to be mapped at a random base address, they globally behave as a library. We only need to export the <em>interesting</em> functions.</p>
<p>For non-PIE executables such transformation would be very difficult because it requires to transform first
the executable into a <em>relocatable</em> executable. It means creating relocations, patching absolute <em>jump</em>, …</p>
<p>LIEF only support this transformation for ELF and we need to investigate the PE and Mach-O cases <a class="footnote-reference brackets" href="#id6" id="id3" role="doc-noteref"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></a>.</p>
<p class="rubric">Notes</p>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="id4" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a href="#id1" role="doc-backlink">1</a><span class="fn-bracket">]</span></span>
<p>Some functions can be exported by the linker such as <code class="docutils literal notranslate"><span class="pre">_init</span></code></p>
</aside>
<aside class="footnote brackets" id="id5" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a href="#id2" role="doc-backlink">2</a><span class="fn-bracket">]</span></span>
<p>The mapped virtual address will be <code class="docutils literal notranslate"><span class="pre">BASE</span> <span class="pre">+</span> <span class="pre">0x72A</span></code> where <code class="docutils literal notranslate"><span class="pre">BASE</span></code> is randomly choosed by the ASLR</p>
</aside>
<aside class="footnote brackets" id="id6" role="doc-footnote">
<span class="label"><span class="fn-bracket">[</span><a href="#id3" role="doc-backlink">3</a><span class="fn-bracket">]</span></span>
<p>In OSX all executables are compiled with the PIE flag.</p>
</aside>
</aside>
<dl class="field-list simple">
<dt class="field-odd">API<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><a class="reference internal" href="../formats/elf/python.html#lief.ELF.Binary.add_exported_function" title="lief.ELF.Binary.add_exported_function"><code class="xref py py-meth docutils literal notranslate"><span class="pre">lief.ELF.Binary.add_exported_function()</span></code></a></p></li>
<li><p><a class="reference internal" href="../formats/elf/python.html#lief.ELF.Binary.export_symbol" title="lief.ELF.Binary.export_symbol"><code class="xref py py-meth docutils literal notranslate"><span class="pre">lief.ELF.Binary.export_symbol()</span></code></a></p></li>
<li><p><a class="reference internal" href="../formats/elf/python.html#lief.ELF.Symbol.visibility" title="lief.ELF.Symbol.visibility"><code class="xref py py-attr docutils literal notranslate"><span class="pre">lief.ELF.Symbol.visibility</span></code></a></p></li>
<li><p><code class="xref py py-attr docutils literal notranslate"><span class="pre">lief.ELF.Symbol.name</span></code></p></li>
<li><p><a class="reference internal" href="../formats/elf/python.html#lief.ELF.Symbol.value" title="lief.ELF.Symbol.value"><code class="xref py py-attr docutils literal notranslate"><span class="pre">lief.ELF.Symbol.value</span></code></a></p></li>
</ul>
</dd>
</dl>
</section>
</section>


      </div>
      

<div class="col-xl-2 d-none d-xl-block px-0 py-5 docs-sidebar docs-sidebar-right">
  <aside class="border-left pl-5 py-3">
    <span class="text-uppercase text-muted font-size-sm d-block mb-3">
      On this page:
    </span>
        <a href="#introduction" class="d-block my-2" data-toggle="scroll">Introduction</a>
        <a href="#exporting-functions" class="d-block my-2" data-toggle="scroll">Exporting functions</a>
        <a href="#warning-for-glibc-2-29-users" class="d-block my-2" data-toggle="scroll">Warning for glibc >= 2.29 users</a>
        <a href="#conclusion" class="d-block my-2" data-toggle="scroll">Conclusion</a>

  </aside>
</div>
    </div>
  </div>
  </body>
</html>