<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="lang:clipboard.copy" content="Copy to clipboard">
  <meta name="lang:clipboard.copied" content="Copied to clipboard">
  <meta name="lang:search.language" content="en">
  <meta name="lang:search.pipeline.stopwords" content="True">
  <meta name="lang:search.pipeline.trimmer" content="True">
  <meta name="lang:search.result.none" content="No matching documents">
  <meta name="lang:search.result.one" content="1 matching document">
  <meta name="lang:search.result.other" content="# matching documents">
  <meta name="lang:search.tokenizer" content="[\s\-]+">
  <meta name="Description" content="LIEF Documentation">

  
    <link href="https://fonts.gstatic.com/" rel="preconnect" crossorigin>
  

  <script src="../../../_static/javascripts/vendor.min.js"></script>

  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css">
  
  
    <link rel="apple-touch-icon" href="../../../_static/favicon.ico"/>
  
  
  
    <title>Imports Modification &#8212; LIEF Documentation</title>
  <link rel="stylesheet" href="../../../_static/fonts/material-icons.css"/>
  <link rel="stylesheet" href="../../../_static/stylesheets/vendor.min.css"/>
  <script defer src="https://cdn.jsdelivr.net/npm/img-comparison-slider@8/dist/index.js" ></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/img-comparison-slider@8/dist/styles.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=d8a2add5" />
    <link rel="stylesheet" type="text/css" href="../../../_static/basic.css?v=29da98fa" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css?v=968db012" />
    <link rel="stylesheet" type="text/css" href="../../../_static/tabs.css?v=a5c4661c" />
    <script src="../../../_static/documentation_options.js?v=a8455094"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/tabs.js?v=3030b3cb"></script>
    <link rel="icon" href="../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="Resources Modification" href="resources.html" />
    <link rel="prev" title="Rust" href="../rust.html" />
   
  <link rel="stylesheet" href="../../../_static/stylesheets/theme.css"/>

  </head>
  <body dir=ltr
        data-md-color-primary=blue data-md-color-accent=cyan>
  <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom fixed-top" role="navigation">
  <a href="../../../index.html" class="navbar-brand">LIEF Documentation</a>
  <button class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse justify-content-center mt-2 mt-lg-0" id="navbar-collapse">
    <ul class="navbar-nav position-relative px-lg-6 px-xl-8">
          
          <li class="nav-item">
              <a class="nav-link" href="https://lief.re">
                <i class="fa-solid fa-house mr-3"></i>Home
              </a>
          </li>
          
          <li class="nav-item">
              <a class="nav-link" href="https://lief.re/blog">
                <i class="fa-solid fa-rss mr-3"></i>Blog
              </a>
          </li>
          
          <li class="nav-item">
              <a class="nav-link" href="https://lief.re/download">
                <i class="fa-solid fa-download mr-3"></i>Download
              </a>
          </li>
        <li class="nav-item dropdown">

            <a class="nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-expanded="false">
                <i class="fa-solid fa-book mr-3"></i>Documentation
            </a>
            <div class="dropdown-menu" role="menu">
             <a class="dropdown-item" href="https://lief.re/doc/stable/doxygen">Doxygen</a>
            </div>
          </li>
        
          
          <li class="nav-item">
              <a class="nav-link" href="https://lief.re/about">
                <i class="fa-solid fa-bars-staggered mr-3"></i>About
              </a>
          </li>
        <li class="nav-item ml-lg-3 mt-3 mt-lg-0">
          <a class="hover-lift-light mt-1" href="https://discord.gg/jGQtyAYChJ" target="_blank">
            <i class="fab fa-2x fa-discord text-darkblue  mr-3"></i>
          </a>
        </li>
        <li class="nav-item">
          <a href="https://github.com/sponsors/lief-project" class="btn btn-outline-pink"
            target="_blank">
            <i class="fa-solid fa-heart mr-3"></i>
            Sponsor
          </a>
        </li>
    </ul>
  </div>
</nav>



  <div class="container-fluid container-docs">
    <div class="row">
      
<div class="col-12 col-lg-3 col-xl-2 border-lg-right py-lg-5 pl-lg-4 docs-sidebar docs-sidebar-left">
  <div class="collapse d-lg-block mb-6 mb-lg-0" id="sidebar-collapse">
    <form action="../../../search.html" method="GET" name="search">
      <input type="text" class="form-control" placeholder="Search" autocapitalize="off" autocomplete="off" spellcheck="false"
             data-md-component="query" data-md-state="active" name="q">
    </form>

    

      
        <ul class="list-unstyled mt-3">
          <li><a href="../../../intro.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-solid fa-door-open"></em> Introduction</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../../../installation.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-solid fa-gears"></em> Installation and Integration</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../../../compilation.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-solid fa-laptop-code"></em> Compilation</a></li>
          
        </ul>
      

      
        <div class="text-darkblue text-uppercase font-size-normal font-weight-bolder mt-4 pt-2 mb-2">
          <span class="caption-text"><i class="fa-solid fa-sitemap"> </i>Formats</span>
        </div>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../../elf/index.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-brands fa-linux"></em> ELF</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../../macho/index.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-brands fa-apple"></em>  Mach-O</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../index.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-brands fa-windows"></em>  PE</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../../coff/index.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-brands fa-windows"></em>  COFF</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../../android/index.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-brands fa-android"></em> Android</a></li>
          
        </ul>
      

      
        <div class="text-darkblue text-uppercase font-size-normal font-weight-bolder mt-4 pt-2 mb-2">
          <span class="caption-text"><i class="fa-solid fa-code"> </i>API</span>
        </div>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../../../api/binary_abstraction/index.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-brands fa-uncharted"></em> Binary Abstraction</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../../../api/utilities/index.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-solid fa-hand-holding-hand"></em> Utilities</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../../../api/error_handling/index.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-solid fa-triangle-exclamation"></em> Error Handling</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../../../api/logging/index.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-regular fa-rectangle-list"></em> Logging</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../../../api/cpp/index.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-regular fa-file-code"></em> C++</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../../../api/rust/index.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-brands fa-rust"></em> Rust</a></li>
          
        </ul>
      

      
        <div class="text-darkblue text-uppercase font-size-normal font-weight-bolder mt-4 pt-2 mb-2">
          <span class="caption-text"><i class="fa-solid fa-hat-wizard"> </i>LIEF Extended</span>
        </div>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../../../extended/intro.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-cubes"></em> What is LIEF Extended?</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../../../extended/debug_info/index.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-solid fa-magnifying-glass"></em> Debug Info</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../../../extended/dwarf/index.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-solid fa-bars-staggered"></em> DWARF</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../../../extended/pdb/index.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-brands fa-windows"></em> PDB</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../../../extended/objc/index.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-brands fa-apple"></em> Objective-C</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../../../extended/dsc/index.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-solid fa-diagram-predecessor"></em> Dyld Shared Cache</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../../../extended/disassembler/index.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-solid fa-dna"></em> Disassembler</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../../../extended/assembler/index.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-solid fa-user-secret"></em> Assembler</a></li>
          
        </ul>
      

      
        <div class="text-darkblue text-uppercase font-size-normal font-weight-bolder mt-4 pt-2 mb-2">
          <span class="caption-text"><i class="fa-solid fa-puzzle-piece"> </i>Plugins</span>
        </div>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../../../plugins/ghidra/index.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-solid fa-dragon"></em> Ghidra</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../../../plugins/binaryninja/index.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-solid fa-user-ninja"></em> BinaryNinja</a></li>
          
        </ul>
      

      
        <div class="text-darkblue text-uppercase font-size-normal font-weight-bolder mt-4 pt-2 mb-2">
          <span class="caption-text"><i class="fa-solid fa-toolbox"> </i>Tools</span>
        </div>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../../../tools/lief-patchelf/index.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-solid fa-screwdriver-wrench"></em> lief-patchelf</a></li>
          
        </ul>
      

      
        <div class="text-darkblue text-uppercase font-size-normal font-weight-bolder mt-4 pt-2 mb-2">
          <span class="caption-text"><i class="fa-solid fa-layer-group"> </i>Tutorials</span>
        </div>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../../../tutorials/01_play_with_formats.html" class="text-darkblue font-size-sm d-block mb-2">01 - Parse and manipulate formats</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../../../tutorials/02_pe_from_scratch.html" class="text-darkblue font-size-sm d-block mb-2">02 - Create a PE from scratch (Deprecated)</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../../../tutorials/03_elf_change_symbols.html" class="text-darkblue font-size-sm d-block mb-2">03 - Play with ELF symbols</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../../../tutorials/04_elf_hooking.html" class="text-darkblue font-size-sm d-block mb-2">04 - ELF Hooking</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../../../tutorials/05_elf_infect_plt_got.html" class="text-darkblue font-size-sm d-block mb-2">05 - Infecting the plt/got</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../../../tutorials/06_pe_hooking.html" class="text-darkblue font-size-sm d-block mb-2">06 - PE Hooking (Deprecated)</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../../../tutorials/07_pe_resource.html" class="text-darkblue font-size-sm d-block mb-2">07 - PE Resources</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../../../tutorials/08_elf_bin2lib.html" class="text-darkblue font-size-sm d-block mb-2">08 - Transforming an ELF executable into a library</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../../../tutorials/09_frida_lief.html" class="text-darkblue font-size-sm d-block mb-2">09 - How to use frida on a non-rooted device</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../../../tutorials/10_android_formats.html" class="text-darkblue font-size-sm d-block mb-2">10 - Android formats</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../../../tutorials/11_macho_modification.html" class="text-darkblue font-size-sm d-block mb-2">11 - Mach-O Modification</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../../../tutorials/12_elf_coredump.html" class="text-darkblue font-size-sm d-block mb-2">12 - ELF Coredump</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../../../tutorials/13_pe_authenticode.html" class="text-darkblue font-size-sm d-block mb-2">13 - PE Authenticode</a></li>
          
        </ul>
      

      
        <div class="text-darkblue text-uppercase font-size-normal font-weight-bolder mt-4 pt-2 mb-2">
          <span class="caption-text"><i class="fa-brands fa-space-awesome"> </i>Extra Information</span>
        </div>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../../../references.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-fa-solid fa-book-bookmark"></em> References</a></li>
          
        </ul>
      

      
        <ul class="list-unstyled mt-3">
          <li><a href="../../../changelog.html" class="text-darkblue font-size-sm d-block mb-2"><em class="fa fa-solid fa-code-compare"></em> Changelog</a></li>
          
        </ul>
      
  </div>
  <hr />
  <span class="svg-icon text-purple mr-1 relative-top--1">
  <svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><title>ionicons-v5-d</title><circle cx="160" cy="96" r="48" style="fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px"></circle><circle cx="160" cy="416" r="48" style="fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px"></circle><line x1="160" y1="368" x2="160" y2="144" style="fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px"></line><circle cx="352" cy="160" r="48" style="fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px"></circle><path d="M352,208c0,128-192,48-192,160" style="fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px"></path></svg>
  </span>
  <a href="https://github.com/lief-project/LIEF/commits/fe54643f" class="text-darkblue">0.17.1 (fe54643f)</a>
    <br>
    Updated on 25/10/2025, 12:49:42.
</div>



      <div class="col-12 col-lg-9 col-xl-8 offset-lg-3 offset-xl-2 py-lg-5 px-lg-6 mb-8">
        
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
            
            <li class="breadcrumb-item">
              <a href="../../../index.html" aria-label="Home"><i class="fa-solid fa-home"></i></a>
            </li>
                
                <li class="breadcrumb-item"><a href="../index.html"><em class="fa fa-brands fa-windows"></em>  PE</a></li>
                
            <li class="breadcrumb-item active" aria-current="page"><a href="#"><em class="fa fa-solid fa-gears"></em> Imports Modification</a></li>
          </ol>
        </nav>
        
        
  <section id="imports-modification">
<h1 id="formats-pe-modifications-imports--page-root"><em class="fa fa-solid fa-gears"></em> Imports Modification<a class="headerlink" href="#formats-pe-modifications-imports--page-root" title="Link to this heading">¶</a></h1>
<p>This section describes the different operations supported by LIEF to modify the
PE import table. Please note that any operation not mentioned in this
page can be considered as not supported or might lead to a corrupted
binary.</p>
<table>
<thead>
<tr class="row-odd"><th class="head"><p>Operation</p></th>
<th class="head"><p>Supported</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><a class="reference internal" href="#ref-add-imp"><span class="std std-ref">Add new import</span></a></p></td>
<td><p><b class="fa-solid fa-check text-success me-1"></b></p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="#ref-add-imp-func"><span class="std std-ref">Add an imported function</span></a></p></td>
<td><p><b class="fa-solid fa-check text-success me-1"></b></p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="#ref-remove-import"><span class="std std-ref">Remove an import</span></a></p></td>
<td><p><b class="fa-solid fa-check text-success me-1"></b></p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="#ref-remove-import-entry"><span class="std std-ref">Remove an imported function</span></a></p></td>
<td><p><b class="fa-solid fa-check text-success me-1"></b></p></td>
</tr>
<tr class="row-even"><td><p>Extend original IAT</p></td>
<td><p><b class="fa-solid fa-xmark text-danger me-1"></b></p></td>
</tr>
<tr class="row-odd"><td><p>Extend original ILT</p></td>
<td><p><b class="fa-solid fa-check text-success me-1"></b></p></td>
</tr>
</tbody>
</table>
<div class="note admonition">
<p class="admonition-title">Implementation Update</p>
<p>Compared to the previous of LIEF, the import table modification has been
completely redesigned to be more reliable when modifying or rebuilding
a PE binary.</p>
</div>
<section id="introduction">
<span id="ref-imp-mod-intro"></span><h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Link to this heading">¶</a></h2>
<p>Modifying the PE import table generically and reliably can be challenging
due to its flexible layout and strong dependency on the assembly
code.
To better understand these challenges and how they are addressed in LIEF,
let’s start with the layout of the import table generated by the MSVC linker
(<code class="docutils literal notranslate"><span class="pre">link.exe</span></code>):</p>
<figure class="align-default" id="id1">
<span id="fig-msvc-layout"></span><a class="reference internal image-reference" href="../../../_images/msvc_layout.webp"><img alt="Import Table (MSVC Layout)" src="../../../_images/msvc_layout.webp" style="width: 913.0px; height: 520.5px;"/>
</a>
<figcaption>
<p><span class="caption-text">Import Table Layout (<code class="docutils literal notranslate"><span class="pre">MSVC/link.exe</span></code>)</span><a class="headerlink" href="#id1" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<div class="fixed-paragraph">
First off, the import table is referenced by the <div class="dropdown" style="display:inline;">
<a aria-expanded="false" aria-haspopup="true" data-toggle="dropdown" href="#" id="lief-api-lief-PE-DataDirectory" role="button">
<code><span class="pre">lief.PE.DataDirectory</span></code></a><div aria-labelledby="lief-api-lief-PE-DataDirectory" class="dropdown-menu"><a class="dropdown-item" href="https://lief.re/doc/stable/rust/lief/pe/struct.DataDirectory.html">
<code class="xref rust rust-struct"><span class="pre"><i class="fa fa-brands fa-rust"></i> lief::pe::DataDirectory</span></code>
</a><a class="dropdown-item" href="../python.html#lief.PE.DataDirectory">
<code class="xref py py-class"><span class="pre"><i class="fa fa-brands fa-python"></i> lief.PE.DataDirectory</span></code>
</a><a class="dropdown-item" href="../cpp.html#_CPPv4N4LIEF2PE13DataDirectoryE">
<code class="xref cpp cpp-class"><span class="pre"><i class="fa fa-regular fa-file-code"></i> LIEF::PE::DataDirectory</span></code>
</a></div></div>
indexed by the <code class="docutils literal notranslate"><span class="pre">IMPORT_TABLE</span></code> value.
The RVA of this data directory points to the beginning of the raw structure
describing the import table while the data directory’s size provides the length
of this table.
For each imported library (e.g. <code class="docutils literal notranslate"><span class="pre">kernel32.dll</span></code>), the import header references
3 locations:</div><ol class="arabic simple">
<li><p>Address (RVA) of the import <strong>lookup</strong> table (<strong>ILT</strong>)</p></li>
<li><p>RVA of the imported library name (e.g. RVA of the string <code class="docutils literal notranslate"><span class="pre">kernel32.dll</span></code>)</p></li>
<li><p>Address (RVA) of the import <strong>address</strong> table (<strong>IAT</strong>)</p></li>
</ol>
<p>The IAT and the ILT point to an array of integers (pointer width) ending with a
zero. In the on-disk PE binary, both tables are filled with an RVA referencing
the imported function name (or an ordinal value).</p>
<p>For instance, if the binary imports <code class="docutils literal notranslate"><span class="pre">kernel32.dll!GetCurrentProcess</span></code> and
<code class="docutils literal notranslate"><span class="pre">kernel32.dll!TerminateProcess</span></code> then we would have the following ILT/IAT:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">uintptr_t</span><span class="w"> </span><span class="n">IAT</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="n">RVA</span><span class="p">(</span><span class="s">"GetCurrentProcess"</span><span class="p">),</span>
<span class="w">   </span><span class="n">RVA</span><span class="p">(</span><span class="s">"TerminateProcess"</span><span class="p">),</span>
<span class="w">   </span><span class="mi">0</span>
<span class="p">};</span>

<span class="kt">uintptr_t</span><span class="w"> </span><span class="n">ILT</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="n">RVA</span><span class="p">(</span><span class="s">"GetCurrentProcess"</span><span class="p">),</span>
<span class="w">   </span><span class="n">RVA</span><span class="p">(</span><span class="s">"TerminateProcess"</span><span class="p">),</span>
<span class="w">   </span><span class="mi">0</span>
<span class="p">};</span>
</pre></div>
</div>
<p>When Windows loads the binary and resolves its imports, it fills the <strong>IAT</strong>
with the <strong>resolved address</strong> of the imported functions:</p>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span><span class="w"> </span> uintptr_t IAT[3] = {
<span class="gd">-   RVA("GetCurrentProcess"),</span>
<span class="gd">-   RVA("TerminateProcess"),</span>
<span class="gi">+   0x7ff7bfdb3f00, // GetCurrentProcess resolved address</span>
<span class="gi">+   0x7ff7ceab4f00, // TerminateProcess resolved address</span>
<span class="w"> </span>   0
<span class="w"> </span> };
</pre></div>
</div>
<p>On the other hand, the ILT is kept unchanged when the binary is loaded
(according to the Microsoft documentation).
The import header references three RVA but the PE format (and the Windows loader)
do not enforce any specific ordering between them. This means that you can have
the ILT before the IAT or vice versa.</p>
<p>The figure <a class="reference internal" href="#fig-msvc-layout"><span class="std std-ref">Import Table Layout (MSVC/link.exe)</span></a> depicts the layout when linking a PE binary
with MSVC’s <code class="docutils literal notranslate"><span class="pre">link.exe</span></code>. From this figure, we can notice that the IATs come first,
then we have the import headers that are followed by the ILT, and finally,
the strings (DLL names, imported function names).</p>
<p>This layout can change with the linker used to generate the final PE file.
In the figure <a class="reference internal" href="#fig-llvm-layout"><span class="std std-ref">Import Table Layout (LLVM/ld-link.exe)</span></a>, we can observe that the IAT follows the ILT
which is the default order for PE binary generated by LLVM ld-link.exe.</p>
<figure class="align-default" id="id2">
<span id="fig-llvm-layout"></span><a class="reference internal image-reference" href="../../../_images/llvm-link-layout.webp"><img alt="Import Table (LLVM Layout)" src="../../../_images/llvm-link-layout.webp" style="width: 913.0px; height: 499.5px;"/>
</a>
<figcaption>
<p><span class="caption-text">Import Table Layout (<code class="docutils literal notranslate"><span class="pre">LLVM/ld-link.exe</span></code>)</span><a class="headerlink" href="#id2" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p>Since we can’t assume any predefined layout or ordering of the import table
elements, we can’t safely recreate a new table at the same locations as the
original one without risking overriding important data.
In addition, if we add new imports or imported functions, the modified import
table would no longer fit in the original location.</p>
<p>To address these constraints, a generic solution consists of relocating the import
table elsewhere in the binary.</p>
<div class="warning admonition">
<p class="admonition-title">Builder Config</p>
<div class="fixed-paragraph">
As this modification is not conservative (i.e. it impacts the layout of the
binary, even if nothing changed in the import table), it needs to be
explicitly enabled with the Builder’s config attribute: <div class="dropdown" style="display:inline;">
<a aria-expanded="false" aria-haspopup="true" data-toggle="dropdown" href="#" id="lief-api-lief-PE-Builder-config_t-imports" role="button">
<code><span class="pre">lief.PE.Builder.config_t.imports</span></code></a><div aria-labelledby="lief-api-lief-PE-Builder-config_t-imports" class="dropdown-menu"><a class="dropdown-item" href="https://lief.re/doc/stable/rust/lief/pe/builder/struct.Config.html#structfield.imports">
<code class="xref rust rust-member"><span class="pre"><i class="fa fa-brands fa-rust"></i> lief::pe::builder::Config::imports</span></code>
</a><a class="dropdown-item" href="../python.html#lief.PE.Builder.config_t.imports">
<code class="xref py py-attr"><span class="pre"><i class="fa fa-brands fa-python"></i> lief.PE.Builder.config_t.imports</span></code>
</a><a class="dropdown-item" href="../cpp.html#_CPPv4N4LIEF2PE7Builder8config_t7importsE">
<code class="xref cpp cpp-member"><span class="pre"><i class="fa fa-regular fa-file-code"></i> LIEF::PE::Builder::config_t::imports</span></code>
</a></div></div></div></div>
<p>We can relocate the import headers, the ILTs and the strings (DLL names and import names),
but we <strong>can’t</strong> relocate the IAT arbitrarily in the binary.
The import table is used to inform the Windows loader about the functions
required by the program to correctly execute its code.
When the loader resolves an imported function, its address is written in the IAT and
the assembly code accesses this IAT with the following stubbing instructions:</p>
<div class="highlight-nasm notranslate"><div class="highlight"><pre><span></span><span class="nf">jmp</span><span class="w"> </span><span class="p">[</span><span class="nv">rip</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="c1">#IAT_FIXUP];  // e.g. jmp *IAT[3];</span>
</pre></div>
</div>
<p>or</p>
<div class="highlight-nasm notranslate"><div class="highlight"><pre><span></span><span class="nf">mov</span><span class="w"> </span><span class="nb">rax</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nv">rip</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="c1">#IAT_FIXUP];</span>
<span class="nf">call</span><span class="w"> </span><span class="nb">rax</span><span class="c1">;</span>
</pre></div>
</div>
<p>If we relocate the IAT elsewhere in the binary (without other considerations),
then the instructions referencing the IAT are no longer valid.</p>
<p>There are solutions to address this problem and one of them consists of creating
trampolines between the original IAT and the new IAT location. This approach has
been used in the <strong>former implementation</strong> of LIEF and you can read this blog
post <a class="reference external" href="https://blog.washi.dev/posts/import-patching/">Washi’s Injecting Code using Imported Functions into Native PE Files</a>
for more details.</p>
<p>The new approach used by LIEF relocates all the elements of the import table:
headers, ILT, and strings but it keeps the original IATs <strong>at the same</strong>.</p>
<figure class="align-default" id="id3">
<span id="fig-lief-import-table-relocation"></span><a class="reference internal image-reference" href="../../../_images/lief-mod.webp"><img alt="LIEF Import Table Relocation" src="../../../_images/lief-mod.webp" style="width: 868.5px; height: 662.0px;"/>
</a>
<figcaption>
<p><span class="caption-text">LIEF import table relocation</span><a class="headerlink" href="#id3" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p>By keeping the original IATs in the same place, we avoid creating trampolines
that require generating assembly.
On the other hand, this approach introduces constraints on the way the
imports can be modified. Especially, we need to make sure that the untouched IAT
is still consistent with the assembly code that uses it.</p>
</section>
<section id="removing-import">
<span id="ref-remove-import"></span><h2 id="removing-import">Removing Import<a class="headerlink" href="#removing-import" title="Link to this heading">¶</a></h2>
<div class="fixed-paragraph">
One can remove an imported library using the <div class="dropdown" style="display:inline;">
<a aria-expanded="false" aria-haspopup="true" data-toggle="dropdown" href="#" id="lief-api-lief-PE-Binary-remove_import" role="button">
<code><span class="pre">lief.PE.Binary.remove_import()</span></code></a><div aria-labelledby="lief-api-lief-PE-Binary-remove_import" class="dropdown-menu"><a class="dropdown-item" href="https://lief.re/doc/stable/rust/lief/pe/struct.Binary.html#method.remove_import">
<code class="xref rust rust-method"><span class="pre"><i class="fa fa-brands fa-rust"></i> lief::pe::Binary::remove_import</span></code>
</a><a class="dropdown-item" href="../python.html#lief.PE.Binary.remove_import">
<code class="xref py py-func"><span class="pre"><i class="fa fa-brands fa-python"></i> lief.PE.Binary.remove_import()</span></code>
</a><a class="dropdown-item" href="../cpp.html#_CPPv4N4LIEF2PE6Binary13remove_importERKNSt6stringE">
<code class="xref cpp cpp-func"><span class="pre"><i class="fa fa-regular fa-file-code"></i> LIEF::PE::Binary::remove_import()</span></code>
</a></div></div>
function or <div class="dropdown" style="display:inline;">
<a aria-expanded="false" aria-haspopup="true" data-toggle="dropdown" href="#" id="lief-api-lief-PE-Binary-remove_all_imports" role="button">
<code><span class="pre">lief.PE.Binary.remove_all_imports()</span></code></a><div aria-labelledby="lief-api-lief-PE-Binary-remove_all_imports" class="dropdown-menu"><a class="dropdown-item" href="https://lief.re/doc/stable/rust/lief/pe/struct.Binary.html#method.remove_all_imports">
<code class="xref rust rust-method"><span class="pre"><i class="fa fa-brands fa-rust"></i> lief::pe::Binary::remove_all_imports</span></code>
</a><a class="dropdown-item" href="../python.html#lief.PE.Binary.remove_all_imports">
<code class="xref py py-func"><span class="pre"><i class="fa fa-brands fa-python"></i> lief.PE.Binary.remove_all_imports()</span></code>
</a><a class="dropdown-item" href="../cpp.html#_CPPv4N4LIEF2PE6Binary18remove_all_importsEv">
<code class="xref cpp cpp-func"><span class="pre"><i class="fa fa-regular fa-file-code"></i> LIEF::PE::Binary::remove_all_imports()</span></code>
</a></div></div> to remove all libraries:</div><div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-0-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-0-0-0" name="0-0" role="tab" tabindex="0"><em class="fa fa-brands fa-python"></em> Python</button><button aria-controls="panel-0-0-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-0-0-1" name="0-1" role="tab" tabindex="-1"><em class="fa fa-regular fa-file-code"></em> C++</button><button aria-controls="panel-0-0-2" aria-selected="false" class="sphinx-tabs-tab" id="tab-0-0-2" name="0-2" role="tab" tabindex="-1"><em class="fa fa-brands fa-rust"></em> Rust</button></div><div aria-labelledby="tab-0-0-0" class="sphinx-tabs-panel" id="panel-0-0-0" name="0-0" role="tabpanel" tabindex="0"><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">lief</span>

<span class="n">pe</span><span class="p">:</span> <span class="n">lief</span><span class="o">.</span><span class="n">PE</span><span class="o">.</span><span class="n">Binary</span> <span class="o">=</span> <span class="o">...</span>

<span class="n">pe</span><span class="o">.</span><span class="n">remove_import</span><span class="p">(</span><span class="s2">"kernel32.dll"</span><span class="p">)</span>

<span class="n">config</span> <span class="o">=</span> <span class="n">lief</span><span class="o">.</span><span class="n">PE</span><span class="o">.</span><span class="n">Builder</span><span class="o">.</span><span class="n">config_t</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">imports</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">pe</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"new.exe"</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-0-0-1" class="sphinx-tabs-panel" hidden="true" id="panel-0-0-1" name="0-1" role="tabpanel" tabindex="0"><div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;LIEF/PE.hpp&gt;</span>

<span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">LIEF</span><span class="o">::</span><span class="n">PE</span><span class="o">::</span><span class="n">Binary</span><span class="o">&gt;</span><span class="w"> </span><span class="n">pe</span><span class="p">;</span>

<span class="n">pe</span><span class="o">-&gt;</span><span class="n">remove_import</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">);</span>

<span class="n">LIEF</span><span class="o">::</span><span class="n">PE</span><span class="o">::</span><span class="n">Builder</span><span class="o">::</span><span class="n">config_t</span><span class="w"> </span><span class="n">config</span><span class="p">;</span>
<span class="n">config</span><span class="p">.</span><span class="n">imports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>

<span class="n">pe</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="s">"new.exe"</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">);</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-0-0-2" class="sphinx-tabs-panel" hidden="true" id="panel-0-0-2" name="0-2" role="tabpanel" tabindex="0"><div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">pe</span><span class="p">:</span><span class="w"> </span><span class="nc">lief</span><span class="p">::</span><span class="n">pe</span><span class="p">::</span><span class="n">Binary</span><span class="p">;</span>

<span class="n">pe</span><span class="p">.</span><span class="n">remove_import</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">);</span>

<span class="kd">let</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lief</span><span class="p">::</span><span class="n">pe</span><span class="p">::</span><span class="n">builder</span><span class="p">::</span><span class="n">Config</span><span class="p">::</span><span class="n">default</span><span class="p">();</span>
<span class="n">config</span><span class="p">.</span><span class="n">imports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>

<span class="n">pe</span><span class="p">.</span><span class="n">write_with_config</span><span class="p">(</span><span class="s">"new.exe"</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">);</span>
</pre></div>
</div>
</div></div>
</section>
<section id="removing-an-imported-function">
<span id="ref-remove-import-entry"></span><h2 id="removing-an-imported-function">Removing an imported function<a class="headerlink" href="#removing-an-imported-function" title="Link to this heading">¶</a></h2>
<div class="fixed-paragraph">
To remove an imported function, one can use <div class="dropdown" style="display:inline;">
<a aria-expanded="false" aria-haspopup="true" data-toggle="dropdown" href="#" id="lief-api-lief-PE-Import-remove_entry" role="button">
<code><span class="pre">lief.PE.Import.remove_entry</span></code></a><div aria-labelledby="lief-api-lief-PE-Import-remove_entry" class="dropdown-menu"><a class="dropdown-item" href="https://lief.re/doc/stable/rust/lief/pe/import/struct.Import.html#method.remove_entry_by_name">
<code class="xref rust rust-method"><span class="pre"><i class="fa fa-brands fa-rust"></i> lief::pe::import::Import::remove_entry_by_name</span></code>
</a><a class="dropdown-item" href="https://lief.re/doc/stable/rust/lief/pe/import/struct.Import.html#method.remove_entry_by_ordinal">
<code class="xref rust rust-method"><span class="pre"><i class="fa fa-brands fa-rust"></i> lief::pe::import::Import::remove_entry_by_ordinal</span></code>
</a><a class="dropdown-item" href="../python.html#lief.PE.Import.remove_entry">
<code class="xref py py-func"><span class="pre"><i class="fa fa-brands fa-python"></i> lief.PE.Import.remove_entry()</span></code>
</a><a class="dropdown-item" href="../cpp.html#_CPPv4N4LIEF2PE6Import12remove_entryERKNSt6stringE">
<code class="xref cpp cpp-func"><span class="pre"><i class="fa fa-regular fa-file-code"></i> LIEF::PE::Import::remove_entry()</span></code>
</a></div></div> on an
<div class="dropdown" style="display:inline;">
<a aria-expanded="false" aria-haspopup="true" data-toggle="dropdown" href="#" id="lief-api-lief-PE-Import" role="button">
<code><span class="pre">lief.PE.Import</span></code></a><div aria-labelledby="lief-api-lief-PE-Import" class="dropdown-menu"><a class="dropdown-item" href="https://lief.re/doc/stable/rust/lief/pe/import/struct.Import.html">
<code class="xref rust rust-struct"><span class="pre"><i class="fa fa-brands fa-rust"></i> lief::pe::import::Import</span></code>
</a><a class="dropdown-item" href="../python.html#lief.PE.Import">
<code class="xref py py-class"><span class="pre"><i class="fa fa-brands fa-python"></i> lief.PE.Import</span></code>
</a><a class="dropdown-item" href="../cpp.html#_CPPv4N4LIEF2PE6ImportE">
<code class="xref cpp cpp-class"><span class="pre"><i class="fa fa-regular fa-file-code"></i> LIEF::PE::Import</span></code>
</a></div></div> instance.</div><div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-1-1-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-1-1-0" name="1-0" role="tab" tabindex="0"><em class="fa fa-brands fa-python"></em> Python</button><button aria-controls="panel-1-1-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-1-1-1" name="1-1" role="tab" tabindex="-1"><em class="fa fa-regular fa-file-code"></em> C++</button><button aria-controls="panel-1-1-2" aria-selected="false" class="sphinx-tabs-tab" id="tab-1-1-2" name="1-2" role="tab" tabindex="-1"><em class="fa fa-brands fa-rust"></em> Rust</button></div><div aria-labelledby="tab-1-1-0" class="sphinx-tabs-panel" id="panel-1-1-0" name="1-0" role="tabpanel" tabindex="0"><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">lief</span>

<span class="n">pe</span><span class="p">:</span> <span class="n">lief</span><span class="o">.</span><span class="n">PE</span><span class="o">.</span><span class="n">Binary</span> <span class="o">=</span> <span class="o">...</span>

<span class="n">kernel32</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">get_import</span><span class="p">(</span><span class="s2">"kernel32.dll"</span><span class="p">)</span>
<span class="n">kernel32</span><span class="o">.</span><span class="n">remove_entry</span><span class="p">(</span><span class="s2">"IsDebuggerPresent"</span><span class="p">)</span>

<span class="n">config</span> <span class="o">=</span> <span class="n">lief</span><span class="o">.</span><span class="n">PE</span><span class="o">.</span><span class="n">Builder</span><span class="o">.</span><span class="n">config_t</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">imports</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">pe</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"new.exe"</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-1-1-1" class="sphinx-tabs-panel" hidden="true" id="panel-1-1-1" name="1-1" role="tabpanel" tabindex="0"><div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;LIEF/PE.hpp&gt;</span>

<span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">LIEF</span><span class="o">::</span><span class="n">PE</span><span class="o">::</span><span class="n">Binary</span><span class="o">&gt;</span><span class="w"> </span><span class="n">pe</span><span class="p">;</span>

<span class="n">LIEF</span><span class="o">::</span><span class="n">PE</span><span class="o">::</span><span class="n">Import</span><span class="o">*</span><span class="w"> </span><span class="n">kernel32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pe</span><span class="o">-&gt;</span><span class="n">get_import</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">);</span>
<span class="n">kernel32</span><span class="o">-&gt;</span><span class="n">remove_entry</span><span class="p">(</span><span class="s">"IsDebuggerPresent"</span><span class="p">);</span>

<span class="n">LIEF</span><span class="o">::</span><span class="n">PE</span><span class="o">::</span><span class="n">Builder</span><span class="o">::</span><span class="n">config_t</span><span class="w"> </span><span class="n">config</span><span class="p">;</span>
<span class="n">config</span><span class="p">.</span><span class="n">imports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>

<span class="n">pe</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="s">"new.exe"</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">);</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-1-1-2" class="sphinx-tabs-panel" hidden="true" id="panel-1-1-2" name="1-2" role="tabpanel" tabindex="0"><div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">pe</span><span class="p">:</span><span class="w"> </span><span class="nc">lief</span><span class="p">::</span><span class="n">pe</span><span class="p">::</span><span class="n">Binary</span><span class="p">;</span>

<span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">kernel32</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pe</span><span class="p">.</span><span class="n">import_by_name</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">kernel32</span><span class="p">.</span><span class="n">remove_entry_by_name</span><span class="p">(</span><span class="s">"IsDebuggerPresent"</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">let</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lief</span><span class="p">::</span><span class="n">pe</span><span class="p">::</span><span class="n">builder</span><span class="p">::</span><span class="n">Config</span><span class="p">::</span><span class="n">default</span><span class="p">();</span>
<span class="n">config</span><span class="p">.</span><span class="n">imports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>

<span class="n">pe</span><span class="p">.</span><span class="n">write_with_config</span><span class="p">(</span><span class="s">"new.exe"</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">);</span>
</pre></div>
</div>
</div></div>
<p>Since this operation drops an entry from IAT but we can’t shrink the
table without patching the assembly (or making trampolines), the workaround
consists of replacing the removed entry with (any) other previous entry.
For instance, if we remove <code class="docutils literal notranslate"><span class="pre">IsDebuggerPresent</span></code> from <code class="docutils literal notranslate"><span class="pre">Kernel32.dll</span></code>, the IAT
changes as follows:</p>
<dl class="field-list">
<dt class="field-odd">Before<span class="colon">:</span></dt>
<dd class="field-odd"><div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Import Address Table of Kernel32.dll</span>
<span class="kt">uintptr_t</span><span class="w"> </span><span class="n">IAT</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="n">RVA</span><span class="p">(</span><span class="s">"GetCurrentProcess"</span><span class="p">),</span>
<span class="w">   </span><span class="n">RVA</span><span class="p">(</span><span class="s">"IsDebuggerPresent"</span><span class="p">),</span>
<span class="w">   </span><span class="n">RVA</span><span class="p">(</span><span class="s">"TerminateProcess"</span><span class="p">),</span>
<span class="w">   </span><span class="mi">0</span>
<span class="p">};</span>
</pre></div>
</div>
</dd>
<dt class="field-even">After<span class="colon">:</span></dt>
<dd class="field-even"><div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// Import Address Table of Kernel32.dll</span>
<span class="kt">uintptr_t</span><span class="w"> </span><span class="n">IAT</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">   </span><span class="n">RVA</span><span class="p">(</span><span class="s">"GetCurrentProcess"</span><span class="p">),</span>
<span class="w">   </span><span class="n">RVA</span><span class="p">(</span><span class="s">"GetCurrentProcess"</span><span class="p">),</span>
<span class="w">   </span><span class="n">RVA</span><span class="p">(</span><span class="s">"TerminateProcess"</span><span class="p">),</span>
<span class="w">   </span><span class="mi">0</span>
<span class="p">};</span>
</pre></div>
</div>
</dd>
</dl>
<div class="tip admonition">
<p class="admonition-title">Implicit Operation</p>
<p>LIEF is <strong>implicitly</strong> doing this padding during the build process.</p>
</div>
<p>This works because we can reuse the IAT entry associated with the deleted entry
as a placeholder for any other imported function. Windows allows duplicated
symbols for a given import so it’s perfectly correct to duplicate an import and
thus, keep the same length for the IAT.</p>
</section>
<section id="creating-a-new-import">
<span id="ref-add-imp"></span><h2 id="creating-a-new-import">Creating a new import<a class="headerlink" href="#creating-a-new-import" title="Link to this heading">¶</a></h2>
<div class="fixed-paragraph">
LIEF allows to create and add new imports through the <div class="dropdown" style="display:inline;">
<a aria-expanded="false" aria-haspopup="true" data-toggle="dropdown" href="#" id="lief-api-lief-PE-Binary-add_import" role="button">
<code><span class="pre">lief.PE.Binary.add_import()</span></code></a><div aria-labelledby="lief-api-lief-PE-Binary-add_import" class="dropdown-menu"><a class="dropdown-item" href="https://lief.re/doc/stable/rust/lief/pe/struct.Binary.html#method.add_import">
<code class="xref rust rust-method"><span class="pre"><i class="fa fa-brands fa-rust"></i> lief::pe::Binary::add_import</span></code>
</a><a class="dropdown-item" href="../python.html#lief.PE.Binary.add_import">
<code class="xref py py-func"><span class="pre"><i class="fa fa-brands fa-python"></i> lief.PE.Binary.add_import()</span></code>
</a><a class="dropdown-item" href="../cpp.html#_CPPv4N4LIEF2PE6Binary10add_importERKNSt6stringE">
<code class="xref cpp cpp-func"><span class="pre"><i class="fa fa-regular fa-file-code"></i> LIEF::PE::Binary::add_import()</span></code>
</a></div></div>
function and the <div class="dropdown" style="display:inline;">
<a aria-expanded="false" aria-haspopup="true" data-toggle="dropdown" href="#" id="lief-api-lief-PE-Import-add_entry" role="button">
<code><span class="pre">lief.PE.Import.add_entry()</span></code></a><div aria-labelledby="lief-api-lief-PE-Import-add_entry" class="dropdown-menu"><a class="dropdown-item" href="https://lief.re/doc/stable/rust/lief/pe/import/struct.Import.html#method.add_entry_by_name">
<code class="xref rust rust-method"><span class="pre"><i class="fa fa-brands fa-rust"></i> lief::pe::import::Import::add_entry_by_name</span></code>
</a><a class="dropdown-item" href="../python.html#lief.PE.Import.add_entry">
<code class="xref py py-func"><span class="pre"><i class="fa fa-brands fa-python"></i> lief.PE.Import.add_entry()</span></code>
</a><a class="dropdown-item" href="../cpp.html#_CPPv4N4LIEF2PE6Import9add_entryE11ImportEntry">
<code class="xref cpp cpp-func"><span class="pre"><i class="fa fa-regular fa-file-code"></i> LIEF::PE::Import::add_entry()</span></code>
</a></div></div> function:</div><div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-2-2-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-2-2-0" name="2-0" role="tab" tabindex="0"><em class="fa fa-brands fa-python"></em> Python</button><button aria-controls="panel-2-2-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-2-2-1" name="2-1" role="tab" tabindex="-1"><em class="fa fa-regular fa-file-code"></em> C++</button><button aria-controls="panel-2-2-2" aria-selected="false" class="sphinx-tabs-tab" id="tab-2-2-2" name="2-2" role="tab" tabindex="-1"><em class="fa fa-brands fa-rust"></em> Rust</button></div><div aria-labelledby="tab-2-2-0" class="sphinx-tabs-panel" id="panel-2-2-0" name="2-0" role="tabpanel" tabindex="0"><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">lief</span>

<span class="n">pe</span><span class="p">:</span> <span class="n">lief</span><span class="o">.</span><span class="n">PE</span><span class="o">.</span><span class="n">Binary</span> <span class="o">=</span> <span class="o">...</span>

<span class="n">stdio</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">add_import</span><span class="p">(</span><span class="s2">"api-ms-win-crt-stdio-l1-1-0.dll"</span><span class="p">)</span>
<span class="n">stdio</span><span class="o">.</span><span class="n">add_entry</span><span class="p">(</span><span class="s2">"puts"</span><span class="p">)</span>

<span class="n">config</span> <span class="o">=</span> <span class="n">lief</span><span class="o">.</span><span class="n">PE</span><span class="o">.</span><span class="n">Builder</span><span class="o">.</span><span class="n">config_t</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">imports</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">pe</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"new.exe"</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-2-2-1" class="sphinx-tabs-panel" hidden="true" id="panel-2-2-1" name="2-1" role="tabpanel" tabindex="0"><div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;LIEF/PE.hpp&gt;</span>

<span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">LIEF</span><span class="o">::</span><span class="n">PE</span><span class="o">::</span><span class="n">Binary</span><span class="o">&gt;</span><span class="w"> </span><span class="n">pe</span><span class="p">;</span>

<span class="n">LIEF</span><span class="o">::</span><span class="n">PE</span><span class="o">::</span><span class="n">Import</span><span class="o">&amp;</span><span class="w"> </span><span class="n">stdio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pe</span><span class="o">-&gt;</span><span class="n">add_import</span><span class="p">(</span><span class="s">"api-ms-win-crt-stdio-l1-1-0.dll"</span><span class="p">);</span>
<span class="n">LIEF</span><span class="o">::</span><span class="n">PE</span><span class="o">::</span><span class="n">ImportEntry</span><span class="o">&amp;</span><span class="w"> </span><span class="n">_puts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stdio</span><span class="p">.</span><span class="n">add_entry</span><span class="p">(</span><span class="s">"puts"</span><span class="p">);</span>

<span class="n">LIEF</span><span class="o">::</span><span class="n">PE</span><span class="o">::</span><span class="n">Builder</span><span class="o">::</span><span class="n">config_t</span><span class="w"> </span><span class="n">config</span><span class="p">;</span>
<span class="n">config</span><span class="p">.</span><span class="n">imports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>

<span class="n">pe</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="s">"new.exe"</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">);</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-2-2-2" class="sphinx-tabs-panel" hidden="true" id="panel-2-2-2" name="2-2" role="tabpanel" tabindex="0"><div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">pe</span><span class="p">:</span><span class="w"> </span><span class="nc">lief</span><span class="p">::</span><span class="n">pe</span><span class="p">::</span><span class="n">Binary</span><span class="p">;</span>

<span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">stdio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pe</span><span class="p">.</span><span class="n">add_import</span><span class="p">(</span><span class="s">"api-ms-win-crt-stdio-l1-1-0.dll"</span><span class="p">);</span>
<span class="kd">let</span><span class="w"> </span><span class="n">_puts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stdio</span><span class="p">.</span><span class="n">add_entry_by_name</span><span class="p">(</span><span class="s">"puts"</span><span class="p">);</span>

<span class="kd">let</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lief</span><span class="p">::</span><span class="n">pe</span><span class="p">::</span><span class="n">builder</span><span class="p">::</span><span class="n">Config</span><span class="p">::</span><span class="n">default</span><span class="p">();</span>
<span class="n">config</span><span class="p">.</span><span class="n">imports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>

<span class="n">pe</span><span class="p">.</span><span class="n">write_with_config</span><span class="p">(</span><span class="s">"new.exe"</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">);</span>
</pre></div>
</div>
</div></div>
<p>As depicted in the figure <a class="reference internal" href="#fig-lief-import-table-relocation"><span class="std std-ref">LIEF import table relocation</span></a>, this
modification introduces a new IAT located close to the relocated import table.
This new IAT contains values for the newly imported functions (in this example <code class="docutils literal notranslate"><span class="pre">puts</span></code>).
Hence, it is in this table that imported functions are resolved by the
Windows loader.</p>
<div class="fixed-paragraph">
When crafting new imports and adding imported functions, we can be interested in
determining the IAT address (<div class="dropdown" style="display:inline;">
<a aria-expanded="false" aria-haspopup="true" data-toggle="dropdown" href="#" id="lief-api-lief-PE-ImportEntry-iat_address" role="button">
<code><span class="pre">lief.PE.ImportEntry.iat_address()</span></code></a><div aria-labelledby="lief-api-lief-PE-ImportEntry-iat_address" class="dropdown-menu"><a class="dropdown-item" href="https://lief.re/doc/stable/rust/lief/pe/import/struct.ImportEntry.html#method.iat_address">
<code class="xref rust rust-method"><span class="pre"><i class="fa fa-brands fa-rust"></i> lief::pe::import::ImportEntry::iat_address</span></code>
</a><a class="dropdown-item" href="../python.html#lief.PE.ImportEntry.iat_address">
<code class="xref py py-attr"><span class="pre"><i class="fa fa-brands fa-python"></i> lief.PE.ImportEntry.iat_address</span></code>
</a><a class="dropdown-item" href="../cpp.html#_CPPv4NK4LIEF2PE11ImportEntry11iat_addressEv">
<code class="xref cpp cpp-func"><span class="pre"><i class="fa fa-regular fa-file-code"></i> LIEF::PE::ImportEntry::iat_address()</span></code>
</a></div></div>) associated with
these new functions.</div><p>The new IAT wrapping up user-created imports is generated during the LIEF’s
write operation. Especially, <strong>there is no reliable way to know the address
of the new IAT before the write operation</strong>.</p>
<div class="fixed-paragraph">
To address this limitation and to provide a way for the user to perform modification
after the creation of the new IAT, <div class="dropdown" style="display:inline;">
<a aria-expanded="false" aria-haspopup="true" data-toggle="dropdown" href="#" id="lief-api-lief-PE-Builder-config_t" role="button">
<code><span class="pre">lief.PE.Builder.config_t</span></code></a><div aria-labelledby="lief-api-lief-PE-Builder-config_t" class="dropdown-menu"><a class="dropdown-item" href="https://lief.re/doc/stable/rust/lief/pe//builder/struct.Config.html">
<code class="xref rust rust-struct"><span class="pre"><i class="fa fa-brands fa-rust"></i> lief::pe::::builder::Config</span></code>
</a><a class="dropdown-item" href="../python.html#lief.PE.Builder.config_t">
<code class="xref py py-class"><span class="pre"><i class="fa fa-brands fa-python"></i> lief.PE.Builder.config_t</span></code>
</a><a class="dropdown-item" href="../cpp.html#_CPPv4N4LIEF2PE7Builder8config_tE">
<code class="xref cpp cpp-class"><span class="pre"><i class="fa fa-regular fa-file-code"></i> LIEF::PE::Builder::config_t</span></code>
</a></div></div> accepts a callback
in its <div class="dropdown" style="display:inline;">
<a aria-expanded="false" aria-haspopup="true" data-toggle="dropdown" href="#" id="lief-api-lief-PE-Builder-config_t-resolved_iat_cbk" role="button">
<code><span class="pre">lief.PE.Builder.config_t.resolved_iat_cbk</span></code></a><div aria-labelledby="lief-api-lief-PE-Builder-config_t-resolved_iat_cbk" class="dropdown-menu"><a class="dropdown-item" href="../python.html#lief.PE.Builder.config_t.resolved_iat_cbk">
<code class="xref py py-attr"><span class="pre"><i class="fa fa-brands fa-python"></i> lief.PE.Builder.config_t.resolved_iat_cbk</span></code>
</a><a class="dropdown-item" href="../cpp.html#_CPPv4N4LIEF2PE7Builder8config_t16resolved_iat_cbkE">
<code class="xref cpp cpp-member"><span class="pre"><i class="fa fa-regular fa-file-code"></i> LIEF::PE::Builder::config_t::resolved_iat_cbk</span></code>
</a></div></div> attribute:</div><div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-3-3-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-3-3-0" name="3-0" role="tab" tabindex="0"><em class="fa fa-brands fa-python"></em> Python</button><button aria-controls="panel-3-3-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-3-3-1" name="3-1" role="tab" tabindex="-1"><em class="fa fa-regular fa-file-code"></em> C++</button></div><div aria-labelledby="tab-3-3-0" class="sphinx-tabs-panel" id="panel-3-3-0" name="3-0" role="tabpanel" tabindex="0"><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">lief</span>

<span class="hll"><span class="k">def</span><span class="w"> </span><span class="nf">iat_resolution_cbk</span><span class="p">(</span><span class="n">pe</span><span class="p">:</span> <span class="n">lief</span><span class="o">.</span><span class="n">PE</span><span class="o">.</span><span class="n">Binary</span><span class="p">,</span> <span class="n">imp</span><span class="p">:</span> <span class="n">lief</span><span class="o">.</span><span class="n">PE</span><span class="o">.</span><span class="n">Import</span><span class="p">,</span> <span class="n">entry</span><span class="p">:</span>
</span><span class="hll">                       <span class="n">lief</span><span class="o">.</span><span class="n">PE</span><span class="o">.</span><span class="n">ImportEntry</span><span class="p">,</span> <span class="n">rva</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span class="hll">    <span class="c1"># Process</span>
</span><span class="hll">    <span class="k">return</span>
</span>
<span class="n">pe</span><span class="p">:</span> <span class="n">lief</span><span class="o">.</span><span class="n">PE</span><span class="o">.</span><span class="n">Binary</span> <span class="o">=</span> <span class="o">...</span>

<span class="n">stdio</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">add_import</span><span class="p">(</span><span class="s2">"api-ms-win-crt-stdio-l1-1-0.dll"</span><span class="p">)</span>
<span class="n">stdio</span><span class="o">.</span><span class="n">add_entry</span><span class="p">(</span><span class="s2">"puts"</span><span class="p">)</span>

<span class="n">config</span> <span class="o">=</span> <span class="n">lief</span><span class="o">.</span><span class="n">PE</span><span class="o">.</span><span class="n">Builder</span><span class="o">.</span><span class="n">config_t</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">imports</span> <span class="o">=</span> <span class="kc">True</span>
<span class="hll"><span class="n">config</span><span class="o">.</span><span class="n">resolved_iat_cbk</span> <span class="o">=</span> <span class="n">iat_resolution_cbk</span>
</span>
<span class="n">pe</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"new.exe"</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-3-3-1" class="sphinx-tabs-panel" hidden="true" id="panel-3-3-1" name="3-1" role="tabpanel" tabindex="0"><div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;LIEF/PE.hpp&gt;</span>

<span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">LIEF</span><span class="o">::</span><span class="n">PE</span><span class="o">::</span><span class="n">Binary</span><span class="o">&gt;</span><span class="w"> </span><span class="n">pe</span><span class="p">;</span>

<span class="n">LIEF</span><span class="o">::</span><span class="n">PE</span><span class="o">::</span><span class="n">Import</span><span class="o">&amp;</span><span class="w"> </span><span class="n">stdio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pe</span><span class="o">-&gt;</span><span class="n">add_import</span><span class="p">(</span><span class="s">"api-ms-win-crt-stdio-l1-1-0.dll"</span><span class="p">);</span>
<span class="n">LIEF</span><span class="o">::</span><span class="n">PE</span><span class="o">::</span><span class="n">ImportEntry</span><span class="o">&amp;</span><span class="w"> </span><span class="n">_puts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stdio</span><span class="p">.</span><span class="n">add_entry</span><span class="p">(</span><span class="s">"puts"</span><span class="p">);</span>

<span class="n">LIEF</span><span class="o">::</span><span class="n">PE</span><span class="o">::</span><span class="n">Builder</span><span class="o">::</span><span class="n">config_t</span><span class="w"> </span><span class="n">config</span><span class="p">;</span>
<span class="n">config</span><span class="p">.</span><span class="n">imports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="hll"><span class="n">config</span><span class="p">.</span><span class="n">resolved_iat_cbk</span><span class="w"> </span><span class="o">=</span>
</span><span class="hll"><span class="w">  </span><span class="p">[]</span><span class="w"> </span><span class="p">(</span><span class="n">LIEF</span><span class="o">::</span><span class="n">PE</span><span class="o">::</span><span class="n">Binary</span><span class="o">&amp;</span><span class="w"> </span><span class="n">pe</span><span class="p">,</span><span class="w"> </span><span class="n">LIEF</span><span class="o">::</span><span class="n">PE</span><span class="o">::</span><span class="n">Import</span><span class="o">&amp;</span><span class="w"> </span><span class="n">imp</span><span class="p">,</span>
</span><span class="hll"><span class="w">      </span><span class="n">LIEF</span><span class="o">::</span><span class="n">PE</span><span class="o">::</span><span class="n">ImportEntry</span><span class="o">&amp;</span><span class="w"> </span><span class="n">entry</span><span class="p">,</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">RVA</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">void</span>
</span><span class="hll"><span class="w">  </span><span class="p">{</span>
</span><span class="hll"><span class="w">    </span><span class="c1">// Process</span>
</span><span class="hll"><span class="w">    </span><span class="k">return</span><span class="p">;</span>
</span><span class="hll"><span class="w">  </span><span class="p">}</span>
</span>
<span class="n">pe</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="s">"new.exe"</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">);</span>
</pre></div>
</div>
</div></div>
<div class="warning admonition">
<p class="admonition-title">Rust Bindings</p>
<p>This callback is not (yet) available in Rust.</p>
</div>
<div class="warning admonition">
<p class="admonition-title">Nanobind Leaks</p>
<p>Because of Python reference counting, you might experience Nanobind warnings
about leaked objects. You can turn off these warnings using <a class="reference internal" href="../../../api/utilities/index.html#lief.disable_leak_warning" title="lief.disable_leak_warning"><code class="xref py py-func docutils literal notranslate"><span class="pre">lief.disable_leak_warning()</span></code></a></p>
</div>
<div class="fixed-paragraph">
The fourth parameter of this callback: <code class="docutils literal notranslate"><span class="pre">uint64_t</span> <span class="pre">RVA</span></code> is the address in the
IAT where the address of the resolved function (<div class="dropdown" style="display:inline;">
<a aria-expanded="false" aria-haspopup="true" data-toggle="dropdown" href="#" id="lief-api-lief-PE-ImportEntry" role="button">
<code><span class="pre">lief.PE.ImportEntry</span></code></a><div aria-labelledby="lief-api-lief-PE-ImportEntry" class="dropdown-menu"><a class="dropdown-item" href="https://lief.re/doc/stable/rust/lief/pe/import/struct.ImportEntry.html">
<code class="xref rust rust-struct"><span class="pre"><i class="fa fa-brands fa-rust"></i> lief::pe::import::ImportEntry</span></code>
</a><a class="dropdown-item" href="../python.html#lief.PE.ImportEntry">
<code class="xref py py-class"><span class="pre"><i class="fa fa-brands fa-python"></i> lief.PE.ImportEntry</span></code>
</a><a class="dropdown-item" href="../cpp.html#_CPPv4N4LIEF2PE11ImportEntryE">
<code class="xref cpp cpp-class"><span class="pre"><i class="fa fa-regular fa-file-code"></i> LIEF::PE::ImportEntry</span></code>
</a></div></div>) is going
to be stored by the loader.</div><p>For instance, we can trace these addresses as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">iat_resolution_cbk</span><span class="p">(</span><span class="n">pe</span><span class="p">:</span> <span class="n">lief</span><span class="o">.</span><span class="n">PE</span><span class="o">.</span><span class="n">Binary</span><span class="p">,</span> <span class="n">imp</span><span class="p">:</span> <span class="n">lief</span><span class="o">.</span><span class="n">PE</span><span class="o">.</span><span class="n">Import</span><span class="p">,</span>
                       <span class="n">entry</span><span class="p">:</span> <span class="n">lief</span><span class="o">.</span><span class="n">PE</span><span class="o">.</span><span class="n">ImportEntry</span><span class="p">,</span> <span class="n">rva</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">imp</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">!</span><span class="si">{</span><span class="n">entry</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: 0x</span><span class="si">{</span><span class="n">rva</span><span class="si">:</span><span class="s2">010x</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># [...]</span>
<span class="n">stdio</span> <span class="o">=</span> <span class="n">dll</span><span class="o">.</span><span class="n">add_import</span><span class="p">(</span><span class="s2">"api-ms-win-crt-stdio-l1-1-0.dll"</span><span class="p">)</span>

<span class="n">stdio</span><span class="o">.</span><span class="n">add_entry</span><span class="p">(</span><span class="s2">"puts"</span><span class="p">)</span>
<span class="n">stdio</span><span class="o">.</span><span class="n">add_entry</span><span class="p">(</span><span class="s2">"__p__commode"</span><span class="p">)</span>
<span class="n">stdio</span><span class="o">.</span><span class="n">add_entry</span><span class="p">(</span><span class="s2">"_set_fmode"</span><span class="p">)</span>

<span class="c1"># [...]</span>
</pre></div>
</div>
<p>Which can results of the following output:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>api-ms-win-crt-stdio-l1-1-0.dll!puts:         0x000046c9e2
api-ms-win-crt-stdio-l1-1-0.dll!__p__commode: 0x000046c9ea
api-ms-win-crt-stdio-l1-1-0.dll!_set_fmode:   0x000046c9f2
</pre></div>
</div>
<p>Given this output, the IAT address of <code class="docutils literal notranslate"><span class="pre">puts</span></code> is located at the RVA <code class="docutils literal notranslate"><span class="pre">0x000046c9e2</span></code>.
This information can be used to patch sections that would need to know this
address:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">iat_resolution_cbk</span><span class="p">(</span><span class="n">pe</span><span class="p">:</span> <span class="n">lief</span><span class="o">.</span><span class="n">PE</span><span class="o">.</span><span class="n">Binary</span><span class="p">,</span> <span class="n">imp</span><span class="p">:</span> <span class="n">lief</span><span class="o">.</span><span class="n">PE</span><span class="o">.</span><span class="n">Import</span><span class="p">,</span>
                       <span class="n">entry</span><span class="p">:</span> <span class="n">lief</span><span class="o">.</span><span class="n">PE</span><span class="o">.</span><span class="n">ImportEntry</span><span class="p">,</span> <span class="n">rva</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
  <span class="n">code</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">get_section</span><span class="p">(</span><span class="s2">".injected"</span><span class="p">)</span>
  <span class="n">patch</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">rva</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="adding-a-new-imported-function">
<span id="ref-add-imp-func"></span><h2 id="adding-a-new-imported-function">Adding a new imported function<a class="headerlink" href="#adding-a-new-imported-function" title="Link to this heading">¶</a></h2>
<p>LIEF can also be used to add a function to an <strong>existing</strong> import, but it
needs to be done carefully to avoid corrupting the binary.</p>
<p>Since we can’t/don’t extend the original IAT of the import
in which we want the new function, the trick consists of adding a new import with
the <strong>same name</strong> as the existing import and adding this function to the
duplicated import.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>// Original Import
* kernel32.dll
  │
  ├── GetCurrentProcessId    IAT[0]
  │
  ├── GetCurrentThreadId     IAT[1]
  │
  └── GetModuleHandleW       IAT[2]

// Duplicated import
* kernel32.dll
  │
  └── GetStartupInfoW        NEW IAT[0]
       │
       └────────-&gt; New Import
</pre></div>
</div>
<p>So the code is really similar to <a class="reference internal" href="#ref-add-imp"><span class="std std-ref">Creating a new import</span></a>.</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-4-4-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-4-4-0" name="4-0" role="tab" tabindex="0"><em class="fa fa-brands fa-python"></em> Python</button><button aria-controls="panel-4-4-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-4-4-1" name="4-1" role="tab" tabindex="-1"><em class="fa fa-regular fa-file-code"></em> C++</button><button aria-controls="panel-4-4-2" aria-selected="false" class="sphinx-tabs-tab" id="tab-4-4-2" name="4-2" role="tab" tabindex="-1"><em class="fa fa-brands fa-rust"></em> Rust</button></div><div aria-labelledby="tab-4-4-0" class="sphinx-tabs-panel" id="panel-4-4-0" name="4-0" role="tabpanel" tabindex="0"><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">lief</span>

<span class="n">pe</span><span class="p">:</span> <span class="n">lief</span><span class="o">.</span><span class="n">PE</span><span class="o">.</span><span class="n">Binary</span> <span class="o">=</span> <span class="o">...</span>

<span class="n">kernel32</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">add_import</span><span class="p">(</span><span class="s2">"kernel32.dll"</span><span class="p">)</span>
<span class="n">kernel32</span><span class="o">.</span><span class="n">add_entry</span><span class="p">(</span><span class="s2">"GetStartupInfoW"</span><span class="p">)</span>

<span class="n">config</span> <span class="o">=</span> <span class="n">lief</span><span class="o">.</span><span class="n">PE</span><span class="o">.</span><span class="n">Builder</span><span class="o">.</span><span class="n">config_t</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">imports</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">config</span><span class="o">.</span><span class="n">resolved_iat_cbk</span> <span class="o">=</span> <span class="o">...</span>

<span class="n">pe</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"new.exe"</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-4-4-1" class="sphinx-tabs-panel" hidden="true" id="panel-4-4-1" name="4-1" role="tabpanel" tabindex="0"><div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;LIEF/PE.hpp&gt;</span>

<span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">LIEF</span><span class="o">::</span><span class="n">PE</span><span class="o">::</span><span class="n">Binary</span><span class="o">&gt;</span><span class="w"> </span><span class="n">pe</span><span class="p">;</span>

<span class="n">LIEF</span><span class="o">::</span><span class="n">PE</span><span class="o">::</span><span class="n">Import</span><span class="o">&amp;</span><span class="w"> </span><span class="n">kernel32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pe</span><span class="o">-&gt;</span><span class="n">add_import</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">);</span>
<span class="n">LIEF</span><span class="o">::</span><span class="n">PE</span><span class="o">::</span><span class="n">ImportEntry</span><span class="o">&amp;</span><span class="w"> </span><span class="n">_GetStartupInfoW</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kernel32</span><span class="p">.</span><span class="n">add_entry</span><span class="p">(</span><span class="s">"GetStartupInfoW"</span><span class="p">);</span>

<span class="n">LIEF</span><span class="o">::</span><span class="n">PE</span><span class="o">::</span><span class="n">Builder</span><span class="o">::</span><span class="n">config_t</span><span class="w"> </span><span class="n">config</span><span class="p">;</span>
<span class="n">config</span><span class="p">.</span><span class="n">imports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="n">config</span><span class="p">.</span><span class="n">resolved_iat_cbk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...;</span>

<span class="n">pe</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="s">"new.exe"</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">);</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-4-4-2" class="sphinx-tabs-panel" hidden="true" id="panel-4-4-2" name="4-2" role="tabpanel" tabindex="0"><div class="highlight-rust notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">pe</span><span class="p">:</span><span class="w"> </span><span class="nc">lief</span><span class="p">::</span><span class="n">pe</span><span class="p">::</span><span class="n">Binary</span><span class="p">;</span>

<span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">kernel32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pe</span><span class="p">.</span><span class="n">add_import</span><span class="p">(</span><span class="s">"kernel32.dll"</span><span class="p">);</span>
<span class="kd">let</span><span class="w"> </span><span class="n">_GetStartupInfoW</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kernel32</span><span class="p">.</span><span class="n">add_entry_by_name</span><span class="p">(</span><span class="s">"GetStartupInfoW"</span><span class="p">);</span>

<span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lief</span><span class="p">::</span><span class="n">pe</span><span class="p">::</span><span class="n">builder</span><span class="p">::</span><span class="n">Config</span><span class="p">::</span><span class="n">default</span><span class="p">();</span>
<span class="n">config</span><span class="p">.</span><span class="n">imports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>

<span class="n">pe</span><span class="p">.</span><span class="n">write_with_config</span><span class="p">(</span><span class="s">"new.exe"</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">);</span>
</pre></div>
</div>
</div></div>
</section>
</section>


      </div>
      

<div class="col-xl-2 d-none d-xl-block px-0 py-5 docs-sidebar docs-sidebar-right">
  <aside class="border-left pl-5 py-3">
    <span class="text-uppercase text-muted font-size-sm d-block mb-3">
      On this page:
    </span>
        <a href="#introduction" class="d-block my-2" data-toggle="scroll">Introduction</a>
        <a href="#removing-import" class="d-block my-2" data-toggle="scroll">Removing Import</a>
        <a href="#removing-an-imported-function" class="d-block my-2" data-toggle="scroll">Removing an imported function</a>
        <a href="#creating-a-new-import" class="d-block my-2" data-toggle="scroll">Creating a new import</a>
        <a href="#adding-a-new-imported-function" class="d-block my-2" data-toggle="scroll">Adding a new imported function</a>

  </aside>
</div>
    </div>
  </div>
  </body>
</html>