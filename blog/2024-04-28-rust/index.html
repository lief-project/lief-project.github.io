<!doctype html><html lang=en-us prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#"><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=description content><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=google-site-verification content="OcWjYs0PdsQZtqu1ms5QSr5FplDf_t5GEneU---wWzM"><meta name=description content="LIEF Rust Bindings"><meta name=keywords content><meta property="og:type" content="article"><meta property="og:description" content="LIEF Rust Bindings"><meta property="og:title" content="Rust bindings for LIEF"><meta property="og:site_name" content="LIEF"><meta property="og:image" content="https://lief.re/blog/2024-04-28-rust/featured.webp"><meta property="og:image:type" content="image/png"><meta property="og:image:width" content><meta property="og:image:height" content><meta property="og:url" content="https://lief.re/blog/2024-04-28-rust/"><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2024-04-28
"><meta property="article:modified_time" content="2024-04-28
"><meta name=twitter:card content="summary"><meta name=twitter:site content="@lief_project"><meta name=twitter:creator content="@lief_project"><meta name=twitter:title content="Rust bindings for LIEF | LIEF"><meta name=twitter:description content="LIEF Rust Bindings | LIEF"><meta property="twitter:image:src" content="https://lief.re/blog/2024-04-28-rust/featured.webp"><meta name=twitter:domain content="https://lief.re/blog/2024-04-28-rust/"><title>LIEF</title>
<link rel=canonical href=https://lief.re/blog/2024-04-28-rust/><link rel=stylesheet type=text/css href=https://lief.re//css/theme.min.css><link rel=stylesheet type=text/css href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css><link rel=stylesheet type=text/css href=https://lief.re//css/vendor.min.css><link rel=stylesheet type=text/css href=https://lief.re//css/termynal.css><link rel=stylesheet type=text/css href=https://lief.re//css/animate.css><link rel=apple-touch-icon href=https://lief.re//img/favicon.ico type=image/x-icon><link rel="shortcut icon" href=https://lief.re//img/favicon.ico type=image/x-icon><link rel=icon href=https://lief.re//img/favicon.ico type=image/x-icon><style></style></head><body class=bg-light><nav class="navbar navbar-expand-lg navbar-light bg-light position-absolute w-100 bg-white" role=navigation><div class="container position-relative"><a href=https://lief.re/ class=navbar-brand>LIEF</a>
<button class=navbar-toggler data-toggle=collapse data-target=#navbar-collapse>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse justify-content-end mt-2 mt-lg-0" id=navbar-collapse><ul class=navbar-nav><li class=nav-item><a class=nav-link href=https://lief.re/><i class="fa-solid fa-house mr-3"></i>
Home</a></li><li class=nav-item><a class=nav-link href=https://lief.re/blog><i class="fa-solid fa-rss mr-3"></i>
Blog</a></li><li class=nav-item><a class=nav-link href=https://lief.re/download><i class="fa-solid fa-download mr-3"></i>
Download</a></li><li class="nav-item dropdown"><a href=https://lief.re/doc/latest class="nav-link dropdown-toggle" data-toggle=dropdown><i class="fa-solid fa-book mr-3"></i>
Documentation</a><div class="dropdown-menu px-4" role=menu><a class="dropdown-item d-flex align-items-center border-bottom border-gray-100 p-2" href=https://lief.re/doc/latest/><span class="svg-icon text-purple mr-3"><svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><title>ionicons-v5-m</title><path d="M160 389a20.91 20.91.0 01-13.82-5.2l-128-112a21 21 0 010-31.6l128-112a21 21 0 0127.66 31.61L63.89 256l109.94 96.19A21 21 0 01160 389z"/><path d="M352 389a21 21 0 01-13.84-36.81L448.11 256 338.17 159.81a21 21 0 0127.66-31.61l128 112a21 21 0 010 31.6l-128 112A20.89 20.89.0 01352 389z"/></svg>
</span><span><p class=mb-0>API
<span class="badge badge-pastel-success font-weight-bold pt-2 ml-1">Latest</span></p><span class=text-secondary>Sphinx & Doxygen API documentation</span>
</span></a><a class="dropdown-item d-flex align-items-center border-bottom border-gray-100 p-2" href=https://lief.re/doc/stable/><span class="svg-icon text-purple mr-3"><svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><title>ionicons-v5-m</title><path d="M160 389a20.91 20.91.0 01-13.82-5.2l-128-112a21 21 0 010-31.6l128-112a21 21 0 0127.66 31.61L63.89 256l109.94 96.19A21 21 0 01160 389z"/><path d="M352 389a21 21 0 01-13.84-36.81L448.11 256 338.17 159.81a21 21 0 0127.66-31.61l128 112a21 21 0 010 31.6l-128 112A20.89 20.89.0 01352 389z"/></svg>
</span><span><p class=mb-0>API
<span class="badge badge-pastel-primary font-weight-bold pt-2 ml-1">Stable</span></p><span class=text-secondary>Sphinx & Doxygen API documentation</span>
</span></a><a class="dropdown-item d-flex align-items-center border-bottom border-gray-100 p-2" href=https://lief.re/doc/latest/changelog.html><span class="svg-icon text-purple mr-3"><svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><title>ionicons-v5-j</title><path d="M256 256s-48-96-126-96c-54.12.0-98 43-98 96s43.88 96 98 96c30 0 56.45-13.18 78-32" style="fill:none;stroke:#000;stroke-linecap:round;stroke-miterlimit:10;stroke-width:48px"/><path d="M256 256s48 96 126 96c54.12.0 98-43 98-96s-43.88-96-98-96c-29.37.0-56.66 13.75-78 32" style="fill:none;stroke:#000;stroke-linecap:round;stroke-miterlimit:10;stroke-width:48px"/></svg>
</span><span><p class=mb-0>Changelog</p><span class=text-secondary>See all updates</span></span></a></div></li><li class=nav-item><a class=nav-link href=https://lief.re/about><i class="fa-solid fa-bars-staggered mr-3"></i>
About</a></li><li class="nav-item ml-lg-3 mt-3 mt-lg-0"><a class="hover-lift-light mt-1" href=https://github.com/lief-project/LIEF target=_blank><i class="fab fa-2x fa-github text-darkblue"></i></a></li><li class="nav-item ml-lg-3 mt-3 mt-lg-0"><a href=https://github.com/sponsors/lief-project/ class="btn btn-outline-pink" target=_blank><i class="fa-solid fa-heart mr-3"></i> Sponsor</a></li></ul></div></div></nav><div class="h-200 h-md-250 bg-light"></div><section class="bg-light pb-8"><div class="container fx-fade-up"><div class="row justify-content-center"><div class="col-lg-12 bg-white shadow-light-lg rounded py-5 px-4 px-md-7 mt-n6"><div class="avatar d-block mx-auto mt-n6 relative-top--7"><a href=https://www.romainthomas.fr target=_blank><img src=https://lief.re/img/avatar/romain.png class="rounded-circle avatar-image shadow" alt=Avatar></a></div><h2 class="text-center font-weight-normal mt-4">Rust bindings for LIEF</h2><div class="text-center text-muted font-size-sm mt-3"><span class=mr-3><span class="svg-icon svg-icon-sm text-muted relative-top--1 mr-1"><svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><title>ionicons-v5-k</title><polygon points="364.13 125.25 87 403 64 448 108.99 425 386.75 147.87 364.13 125.25" style="fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px"/><path d="M420.69 68.69 398.07 91.31l22.62 22.63 22.62-22.63a16 16 0 000-22.62h0a16 16 0 00-22.62.0z" style="fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px"/></svg>
</span><a href=https://www.romainthomas.fr target=_blank>Romain Thomas </a></span><span class=ml-3><i class="far fa-calendar fa-xs mr-1 relative-top--1"></i>
April 28, 2024</span></div><img src=https://lief.re//img/waves.png class="d-block mx-auto mt-4 mb-5" alt=Wave><div class=text-dark><p>LIEF Rust bindings are now available. This blog post introduces these
bindings and the technical challenges behind this journey.</p><h1 id=tldr>tl;dr</h1><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>[package]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>name    = <span style=color:#d14>&#34;lief-demo&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>version = <span style=color:#d14>&#34;0.0.1&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>edition = <span style=color:#d14>&#34;2021&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>[dependencies]
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>lief = { git = <span style=color:#d14>&#34;https://github.com/lief-project/LIEF&#34;</span>, branch = <span style=color:#d14>&#34;main&#34;</span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#000;font-weight:700>use</span><span style=color:#bbb> </span>lief::Binary;<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>fn</span> <span style=color:#900;font-weight:700>main</span>()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#bbb>  </span><span style=color:#000;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>mut</span><span style=color:#bbb> </span>file<span style=color:#bbb> </span><span style=color:#000;font-weight:700>=</span><span style=color:#bbb> </span>File::open(path).expect(<span style=color:#d14>&#34;Can&#39;t open the file&#34;</span>);<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#bbb>  </span><span style=color:#000;font-weight:700>match</span><span style=color:#bbb> </span>Binary::from(<span style=color:#000;font-weight:700>&amp;</span><span style=color:#000;font-weight:700>mut</span><span style=color:#bbb> </span>file)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#bbb>          </span><span style=color:#0086b3>Some</span>(Binary::<span style=color:teal>ELF</span>(elf))<span style=color:#bbb> </span><span style=color:#000;font-weight:700>=&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#bbb>            </span><span style=color:#000;font-weight:700>for</span><span style=color:#bbb> </span>section<span style=color:#bbb> </span><span style=color:#000;font-weight:700>in</span><span style=color:#bbb> </span>elf.sections()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#bbb>              </span>println!(<span style=color:#d14>&#34;</span><span style=color:#d14>{}</span><span style=color:#d14>: 0x</span><span style=color:#d14>{:x}</span><span style=color:#d14>&#34;</span>,<span style=color:#bbb> </span>section.name(),<span style=color:#bbb> </span>section.virtual_address());<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#bbb>            </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#bbb>          </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#bbb>          </span><span style=color:#0086b3>Some</span>(Binary::<span style=color:teal>PE</span>(pe))<span style=color:#bbb> </span><span style=color:#000;font-weight:700>=&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#bbb>            </span><span style=color:#998;font-style:italic>// ...
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#998;font-style:italic></span><span style=color:#bbb>          </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#bbb>          </span><span style=color:#0086b3>Some</span>(Binary::MachO(macho))<span style=color:#bbb> </span><span style=color:#000;font-weight:700>=&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#bbb>            </span><span style=color:#998;font-style:italic>// ...
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#998;font-style:italic></span><span style=color:#bbb>          </span>},<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#bbb>          </span><span style=color:#0086b3>None</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>=&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#bbb>            </span><span style=color:#998;font-style:italic>// Parsing error
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#998;font-style:italic></span><span style=color:#bbb>          </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#bbb>      </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><p>Nightly documentation is available here: <a href=https://lief-rs.s3.fr-par.scw.cloud/doc/latest/lief/index.html>https://lief-rs.s3.fr-par.scw.cloud/doc/latest/lief/index.html</a>
and the package will be published on <a href=https://crates.io/crates/lief>https://crates.io/crates/lief</a> for the
<code>0.15.0</code> release.</p><h1 id=introduction>Introduction</h1><p>It has been a long journey to have Rust bindings for LIEF, and I&rsquo;m happy to announce
that these bindings are starting to be ready for public release.</p><p>I&rsquo;ll take this blog post as an opportunity to share the different challenges
that led me to the current design of the bindings. I&rsquo;m not a rust guru, so feel
free to share your feedback or suggestions!</p><h2 id=idiomacy>Idiomacy</h2><p>First off, I&rsquo;m attached to have bindings that are idiomatic in the language
they target. Reaching the current state of the Rust API took me most of the time
during the development. The Rust language introduces new concepts that do not
exactly match what we can find in object-oriented languages. You can get an idea
of the Rust API with these examples.</p><h4 id=iterate-over-elf-sections>Iterate over ELF sections</h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#000;font-weight:700>use</span><span style=color:#bbb> </span>lief::Binary;<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>use</span><span style=color:#bbb> </span>lief::generic::Section;<span style=color:#bbb> </span><span style=color:#998;font-style:italic>// for the &#34;abstract&#34; traits
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#998;font-style:italic></span><span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>let</span><span style=color:#bbb> </span>path<span style=color:#bbb> </span><span style=color:#000;font-weight:700>=</span><span style=color:#bbb> </span>std::env::args().last().unwrap();<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>if</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#0086b3>Some</span>(Binary::<span style=color:teal>ELF</span>(elf))<span style=color:#bbb> </span><span style=color:#000;font-weight:700>=</span><span style=color:#bbb> </span>Binary::parse(path.as_str())<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#bbb>    </span><span style=color:#000;font-weight:700>for</span><span style=color:#bbb> </span>section<span style=color:#bbb> </span><span style=color:#000;font-weight:700>in</span><span style=color:#bbb> </span>elf.sections()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#bbb>        </span>println!(<span style=color:#d14>&#34;</span><span style=color:#d14>{}</span><span style=color:#d14>&#34;</span>,<span style=color:#bbb> </span>section.name());<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9</span><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><h4 id=get-pe-pdb-path>Get PE PDB path</h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#000;font-weight:700>use</span><span style=color:#bbb> </span>lief::Binary;<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>use</span><span style=color:#bbb> </span>lief::pe::debug::Entries::CodeViewPDB;<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>if</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#0086b3>Some</span>(Binary::<span style=color:teal>PE</span>(pe))<span style=color:#bbb> </span><span style=color:#000;font-weight:700>=</span><span style=color:#bbb> </span>Binary::parse(path.as_str())<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#bbb>    </span><span style=color:#000;font-weight:700>for</span><span style=color:#bbb> </span>entry<span style=color:#bbb> </span><span style=color:#000;font-weight:700>in</span><span style=color:#bbb> </span>pe.debug()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#bbb>        </span><span style=color:#000;font-weight:700>if</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>let</span><span style=color:#bbb> </span>CodeViewPDB(pdb_view)<span style=color:#bbb> </span><span style=color:#000;font-weight:700>=</span><span style=color:#bbb> </span>entry<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#bbb>            </span>println!(<span style=color:#d14>&#34;</span><span style=color:#d14>{}</span><span style=color:#d14>&#34;</span>,<span style=color:#bbb> </span>pdb_view.filename());<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#bbb>        </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><h4 id=access-mach-o-dyld-info>Access Mach-O Dyld Info</h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#000;font-weight:700>use</span><span style=color:#bbb> </span>lief::Binary;<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>use</span><span style=color:#bbb> </span>lief::macho::commands::Commands;<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>use</span><span style=color:#bbb> </span>lief::macho::binding_info::BindingInfo;<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>if</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#0086b3>Some</span>(Binary::MachO(fat))<span style=color:#bbb> </span><span style=color:#000;font-weight:700>=</span><span style=color:#bbb> </span>Binary::parse(path.as_str())<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#bbb>    </span><span style=color:#000;font-weight:700>for</span><span style=color:#bbb> </span>macho<span style=color:#bbb> </span><span style=color:#000;font-weight:700>in</span><span style=color:#bbb> </span>fat.iter()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#bbb>        </span><span style=color:#998;font-style:italic>// First version, iterate over the commands
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#998;font-style:italic></span><span style=color:#bbb>        </span><span style=color:#000;font-weight:700>for</span><span style=color:#bbb> </span>cmd<span style=color:#bbb> </span><span style=color:#000;font-weight:700>in</span><span style=color:#bbb> </span>macho.commands()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#bbb>            </span><span style=color:#998;font-style:italic>// Alternative to `if let` pattern
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#998;font-style:italic></span><span style=color:#bbb>            </span><span style=color:#000;font-weight:700>match</span><span style=color:#bbb> </span>cmd<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#bbb>                </span>Commands::DyldInfo(dyld_info)<span style=color:#bbb> </span><span style=color:#000;font-weight:700>=&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#bbb>                    </span><span style=color:#000;font-weight:700>for</span><span style=color:#bbb> </span>binding<span style=color:#bbb> </span><span style=color:#000;font-weight:700>in</span><span style=color:#bbb> </span>dyld_info.bindings()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#bbb>                        </span><span style=color:#000;font-weight:700>if</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>let</span><span style=color:#bbb> </span>BindingInfo::Chained(chained)<span style=color:#bbb> </span><span style=color:#000;font-weight:700>=</span><span style=color:#bbb> </span>binding<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#bbb>                            </span>println!(<span style=color:#d14>&#34;Library: 0x</span><span style=color:#d14>{:x}</span><span style=color:#d14>&#34;</span>,<span style=color:#bbb> </span>chained.address());<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#bbb>                        </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#bbb>                    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#bbb>                </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#bbb>                </span>_<span style=color:#bbb> </span><span style=color:#000;font-weight:700>=&gt;</span><span style=color:#bbb> </span>{}<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#bbb>            </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#bbb>        </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#bbb>        </span><span style=color:#998;font-style:italic>// Second version, using the helper
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span><span style=color:#998;font-style:italic></span><span style=color:#bbb>        </span><span style=color:#000;font-weight:700>if</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>let</span><span style=color:#bbb> </span><span style=color:#0086b3>Some</span>(dyld_info)<span style=color:#bbb> </span><span style=color:#000;font-weight:700>=</span><span style=color:#bbb> </span>macho.dyld_info()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#bbb>            </span><span style=color:#000;font-weight:700>for</span><span style=color:#bbb> </span>binding<span style=color:#bbb> </span><span style=color:#000;font-weight:700>in</span><span style=color:#bbb> </span>dyld_info.bindings()<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#bbb>                </span><span style=color:#000;font-weight:700>if</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>let</span><span style=color:#bbb> </span>BindingInfo::Chained(chained)<span style=color:#bbb> </span><span style=color:#000;font-weight:700>=</span><span style=color:#bbb> </span>binding<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#bbb>                    </span>println!(<span style=color:#d14>&#34;Library: 0x</span><span style=color:#d14>{:x}</span><span style=color:#d14>&#34;</span>,<span style=color:#bbb> </span>chained.address());<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#bbb>                </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:#bbb>            </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span><span style=color:#bbb>        </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><p>Given this idiomatic goal, there were some challenges in exposing C++ code to Rust.</p><h3 id=polymorphism--inheritance>Polymorphism & Inheritance</h3><p>How to idiomatically bind this C++ code in Rust?</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#000;font-weight:700>class</span> <span style=color:#458;font-weight:700>Base</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>  <span style=color:#000;font-weight:700>virtual</span> std<span style=color:#000;font-weight:700>::</span>string get_name() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    <span style=color:#000;font-weight:700>return</span> <span style=color:#d14>&#34;Base&#34;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>};
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#000;font-weight:700>class</span> <span style=color:#458;font-weight:700>Derived</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>public</span> Base {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>  <span style=color:#000;font-weight:700>virtual</span> std<span style=color:#000;font-weight:700>::</span>string get_name() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#000;font-weight:700>return</span> <span style=color:#d14>&#34;Derived&#34;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>};
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#000;font-weight:700>class</span> <span style=color:#458;font-weight:700>OtherDerived</span> <span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>public</span> Base {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>  <span style=color:#000;font-weight:700>virtual</span> std<span style=color:#000;font-weight:700>::</span>string get_name() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    <span style=color:#000;font-weight:700>return</span> <span style=color:#d14>&#34;OtherDerived&#34;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>};
</span></span></code></pre></div><p>For the inheritance relationship, the idea is to leverage Rust&rsquo;s <code>enum</code> structure
in which, all the <strong>leaves</strong> of the inheritance tree are an entry of the enum:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#000;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>enum</span> <span style=color:#458;font-weight:700>Inheritance</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#bbb>    </span>Derived(Derived),<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#bbb>    </span>OtherDerived(OtherDerived),<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><p>Secondly, all these objects inherit and share the <code>get_name()</code> virtual function. To provide
this shared <em>property</em> in Rust, we can leverage a Rust <code>trait</code> that would make
<code>get_name</code> available for the structures that implement this trait:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#000;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>trait</span><span style=color:#bbb> </span>AsBase<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#bbb>    </span><span style=color:#000;font-weight:700>fn</span> <span style=color:#900;font-weight:700>get_name</span>(<span style=color:#000;font-weight:700>&amp;</span><span style=color:#999>self</span>)<span style=color:#bbb> </span>-&gt; <span style=color:#0086b3>String</span>;<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>impl</span><span style=color:#bbb> </span>AsBase<span style=color:#bbb> </span><span style=color:#000;font-weight:700>for</span><span style=color:#bbb> </span>Derived<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#bbb>    </span><span style=color:#000;font-weight:700>fn</span> <span style=color:#900;font-weight:700>get_name</span>(<span style=color:#000;font-weight:700>&amp;</span><span style=color:#999>self</span>)<span style=color:#bbb> </span>-&gt; <span style=color:#0086b3>String</span> {<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#bbb>        </span><span style=color:#000;font-weight:700>..</span>.<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>impl</span><span style=color:#bbb> </span>AsBase<span style=color:#bbb> </span><span style=color:#000;font-weight:700>for</span><span style=color:#bbb> </span>OtherDerived<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#bbb>    </span><span style=color:#000;font-weight:700>fn</span> <span style=color:#900;font-weight:700>get_name</span>(<span style=color:#000;font-weight:700>&amp;</span><span style=color:#999>self</span>)<span style=color:#bbb> </span>-&gt; <span style=color:#0086b3>String</span> {<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#bbb>        </span><span style=color:#000;font-weight:700>..</span>.<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><p>One can also simplify the definition of the trait such as the derived objects
only have to provide the <code>FFI</code> reference to the base class:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>pub trait AsBase {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#000;background-color:#fdd>-    fn get_name(&amp;self) -&gt; String;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#000;background-color:#fdd></span><span style=color:#000;background-color:#dfd>+    fn as_base(&amp;self) -&gt; ffi::BaseImpl;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#000;background-color:#dfd>+
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#000;background-color:#dfd>+    fn get_name(&amp;self) -&gt; String {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#000;background-color:#dfd>+        self.as_base().get_name().to_string()
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#000;background-color:#dfd>+    }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#000;background-color:#dfd></span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>impl AsBase for Derived {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#000;background-color:#fdd>-    fn get_name(&amp;self) -&gt; String {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#000;background-color:#fdd></span><span style=color:#000;background-color:#dfd>+    fn as_base(&amp;self) -&gt; ffi::BaseImpl {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#000;background-color:#dfd></span>        ...
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>impl AsBase for OtherDerived {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    fn get_name(&amp;self) -&gt; String {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        ...
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>}
</span></span></code></pre></div><p>LIEF&rsquo;s Rust bindings highly rely on these patterns to expose classes with polymorphism
and inheritance properties.</p><h3 id=lifetime>Lifetime</h3><p>In C++, we don&rsquo;t have the concept of a lifetime for an object. For instance,
it&rsquo;s perfectly fine to write this code:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#458;font-weight:700>int</span> <span style=color:#900;font-weight:700>main</span>() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>  LIEF<span style=color:#000;font-weight:700>::</span>PE<span style=color:#000;font-weight:700>::</span>Binary<span style=color:#000;font-weight:700>*</span> pe <span style=color:#000;font-weight:700>=</span> <span style=color:#000;font-weight:700>nullptr</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>  {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    std<span style=color:#000;font-weight:700>::</span>unique_ptr<span style=color:#000;font-weight:700>&lt;</span>LIEF<span style=color:#000;font-weight:700>::</span>PE<span style=color:#000;font-weight:700>::</span>Binary<span style=color:#000;font-weight:700>&gt;</span> pe_unique <span style=color:#000;font-weight:700>=</span> LIEF<span style=color:#000;font-weight:700>::</span>PE<span style=color:#000;font-weight:700>::</span>Parser<span style=color:#000;font-weight:700>::</span>parse(<span style=color:#d14>&#34;...&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    pe <span style=color:#000;font-weight:700>=</span> pe_unique.get();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>  printf(<span style=color:#d14>&#34;%s</span><span style=color:#d14>\n</span><span style=color:#d14>&#34;</span>, pe<span style=color:#000;font-weight:700>-&gt;</span>get_section(<span style=color:#d14>&#34;.text&#34;</span>).name()); <span style=color:#998;font-style:italic>// Use-after-free
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span><span style=color:#998;font-style:italic></span>  <span style=color:#000;font-weight:700>return</span> <span style=color:#099>0</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9</span><span>}
</span></span></code></pre></div><p>Nevertheless, the <code>pe</code> pointer used in <code>printf</code> is no longer valid because of the
scope of the <code>std::unique_ptr</code>.</p><p>In Python, Nanobind and Pybind11 provide helpers to define the lifetime of
an object according to its parent or its scope:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>nb<span style=color:#000;font-weight:700>::</span><span style=color:#000;font-weight:700>class</span><span style=color:#a61717;background-color:#e3d2d2>&lt;</span><span style=color:#458;font-weight:700>LIEF</span><span style=color:#000;font-weight:700>::</span>PE<span style=color:#000;font-weight:700>::</span>Binary<span style=color:#000;font-weight:700>&gt;</span>(m, <span style=color:#d14>&#34;Binary&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    .def_prop_ro(<span style=color:#d14>&#34;sections&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>        nb<span style=color:#000;font-weight:700>::</span>overload_cast<span style=color:#000;font-weight:700>&lt;&gt;</span>(<span style=color:#000;font-weight:700>&amp;</span>Binary<span style=color:#000;font-weight:700>::</span>sections),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>        nb<span style=color:#000;font-weight:700>::</span>keep_alive<span style=color:#000;font-weight:700>&lt;</span><span style=color:#099>0</span>, <span style=color:#099>1</span><span style=color:#000;font-weight:700>&gt;</span>())
</span></span></code></pre></div><p>With <code>nb::keep_alive</code>, we indicate that the lifetime of the PE section iterator
must be at least as long as the lifetime of the PE Binary instance.</p><p>In Rust, we could express this lifetime with something like:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#000;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>struct</span> <span style=color:#0086b3>Iterator</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:teal>&#39;a</span><span style=color:#000;font-weight:700>&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#bbb>    </span><span style=color:#000;font-weight:700>pub</span><span style=color:#bbb> </span>it: <span style=color:#458;font-weight:700>ffi</span>::Impl,<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>impl</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:teal>&#39;a</span><span style=color:#000;font-weight:700>&gt;</span><span style=color:#bbb> </span><span style=color:#0086b3>Iterator</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:teal>&#39;a</span><span style=color:#000;font-weight:700>&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#bbb>    </span><span style=color:#000;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>fn</span> <span style=color:#900;font-weight:700>new</span>(it: <span style=color:#458;font-weight:700>ffi</span>::Impl)<span style=color:#bbb> </span>-&gt; <span style=color:#458;font-weight:700>Self</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#bbb>        </span><span style=color:#999>Self</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#bbb>            </span>it,<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#bbb>        </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#bbb></span><span style=color:#000;font-weight:700>impl</span><span style=color:#bbb> </span>Binary<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#bbb>    </span><span style=color:#000;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>fn</span> <span style=color:#900;font-weight:700>get_iterator</span>(<span style=color:#000;font-weight:700>&amp;</span><span style=color:teal>&#39;a</span><span style=color:#bbb> </span><span style=color:#999>self</span>)<span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#bbb>        </span><span style=color:#0086b3>Iterator</span>::new(<span style=color:#999>self</span>.get_ffi_impl())<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#bbb>    </span>}<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><p>But this code is not correct since the lifetime <code>&lt;'a></code>
of the <code>Iterator</code> structure is not bound to an attribute in the structure.
For technical-ffi reasons, we can&rsquo;t bind this lifetime to <code>ffi::Impl</code>.</p><p>One solution consists of using <a href=https://doc.rust-lang.org/std/marker/struct.PhantomData.html>PhantomData</a>
to provide the lifetime semantic:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#000;font-weight:700>pub</span><span style=color:#bbb> </span><span style=color:#000;font-weight:700>struct</span> <span style=color:#0086b3>Iterator</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:teal>&#39;a</span><span style=color:#000;font-weight:700>&gt;</span><span style=color:#bbb> </span>{<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#bbb>    </span><span style=color:#000;font-weight:700>pub</span><span style=color:#bbb> </span>it: <span style=color:#458;font-weight:700>ffi</span>::Impl,<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#bbb>    </span>_owner: <span style=color:#458;font-weight:700>PhantomData</span><span style=color:#000;font-weight:700>&lt;&amp;</span><span style=color:teal>&#39;a</span><span style=color:#bbb> </span>ffi::PE_Binary<span style=color:#000;font-weight:700>&gt;</span>,<span style=color:#bbb>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#bbb></span>}<span style=color:#bbb>
</span></span></span></code></pre></div><h2 id=safety-first>Safety First!</h2><p>LIEF is developed in what we could say, an &ldquo;unsafe&rdquo; language (i.e. C++). On the
other hand, Rust provides strong guarantees about memory, concurrency, &mldr;</p><p>Even though LIEF&rsquo;s core can&rsquo;t provide the safety guarantees that Rust is giving,
I tried to provide <em>some</em> guarantees about the bindings.</p><h3 id=coverage>Coverage</h3><p>65% of the functions exposed by the Rust binding are covered by the test suite and
you can access the coverage report here: <a href=https://lief-rs.s3.fr-par.scw.cloud/coverage/index.html>https://lief-rs.s3.fr-par.scw.cloud/coverage/index.html</a> (nightly generated).</p><div class="admonition warning"><p class=admonition-title>Coverage</p><p>By covered I mean: <i>"the function that bridges from C++ to Rust <b>is executed</b> in the test suite"</i>.</div><h3 id=asan>ASAN</h3><p>Regarding memory safety, Rust allows to compile packages with ASAN thanks to compiler options:</p><pre tabindex=0><code>export RUSTFLAGS=&#34;-Z sanitizer=address -Clink-args=-fsanitize=address&#34;
export TARGET_CXXFLAGS=&#34;-fsanitize=address -fno-omit-frame-pointer -O1&#34;
...
</code></pre><p>Thus, we also leverage this option to compile <strong>both</strong>: LIEF core and the Rust binding
with ASAN.</p><p>Given the fact that 65% of the functions and 70% of the lines are test-covered,
running these tests with ASAN gives us some confidence about the fact that the bindings do
not introduce leaks or memory issues.</p><p>I don&rsquo;t pretend that the code is free of bugs but at least these mechanisms are
in place in the development cycle of the project.</p><h2 id=compilation>Compilation</h2><p>The bindings rely on <a href=https://google.github.io/autocxx/>autocxx</a> to automatically
generate rust FFI code from existing C++ include file. Autocxx is powerful but it
can fail to process complex headers like <code>LIEF/ELF/Binary.hpp</code>. Thus, I had to create
some kind of wrapper over the existing <code>LIEF/*.hpp</code> header files such as autocxx
can process them. These wrappers are available in the directory <code>api/rust/include/</code></p><p><img src=./design.webp alt=overview></p><p>The time to generate the Rust FFI code for the different C++ headers
is significant: about ~50s with the current bindings. This generation time can be
problematic for the end user especially if LIEF is indirectly imported from other
dependencies.
On the other hand, for fixed versions of LIEF, cxxgen and, autocxx, the code generated
by cxxgen and autocxx is <em>always</em> the same. Thus, we can pregenerate and precompile these
files to save time during the pure-rust compilation step.</p><h2 id=docker>Docker</h2><p>All the different steps mentioned in the previous parts: pre-compilation, ASAN,
and code coverage are CI-compiled and <strong>fully Dockerized</strong>.</p><p>It might also be worth mentioning that the pre-compiled FFI artifacts are also
compiled and <strong>cross-compiled</strong> with Docker. Yes, cross-compiled.</p><h3 id=cross-compilation--ci>Cross-Compilation & CI</h3><div class="admonition note"><p class=admonition-title>Digression</p><p>Feel free to skip this part which is not strictly related to LIEF & Rust.</div><p>LIEF uses <a href=https://github.com/lief-project/LIEF/tree/main/.github/workflows>Github Actions</a>
for the CI and from my experience, macOS and Windows runners are <em>less</em> available
than Linux runners (i.e. you wait more for these runners). In addition,
if you use these runners for a private repository (which is not the case for LIEF),
you have a pool of 2000 minutes for the CI of the private repo. Depending
on the runner you are using, these minutes are counted with a multiplier<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>:</p><table><thead><tr><th>Operating system</th><th>Minute multiplier</th></tr></thead><tbody><tr><td>Linux</td><td>1</td></tr><tr><td>Windows</td><td>2</td></tr><tr><td>OSX</td><td>10</td></tr></tbody></table><p><strong>1 minute</strong> spent on a <strong>macOS runner</strong> is equivalent to <strong>10 minutes</strong> spent
on a Linux runner. Hence, if your private project is exclusively using the macOS
runner, you don&rsquo;t have 2000 minutes (~33h) but 200 minutes (~3h).</p><p>And then, after this pool of 2000 minutes, 1 minute on a macOS 6 vCPU is priced
at <strong><code>0.16$</code></strong> while the same minute on a Linux 8 vCPU is priced at <strong><code>0.032$</code></strong>.</p><p>Given those facts, cross-compiling for macOS and Windows can be interesting.
LLVM provides all the facilities to perform this cross-compilation<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> and since
we are only generating static libraries, we don&rsquo;t even need the libraries for
these platforms.</p><p><strong>So yes, LIEF core and the Rust FFI library are cross-compiled for Windows(MT/MD CRT) and OSX(aarch64, x86_64)
with a Docker container running on Linux :)</strong></p><p>The Windows and OSX runners are only used for testing that the cross-compilation worked well
(i.e. <code>ld64</code> can <code>link.exe</code> can link the cross-compiled libraries) and that the test suite
is also working.</p><p>Long story short, we save resources and CI minutes by cross-compiling for Windows
and OSX in a Docker running on a Linux runner. As a side effect, we also get fully
reproducible builds. The whole pipeline (LIEF core compilation, ASAN, coverage, S3 upload) takes
less than 15 minutes (with cache optimizations).</p><h2 id=other-projects>Other Projects</h2><p>LIEF Rust bindings might not be suitable for all the projects. Especially,
if you are looking for a pure-safety-rust library or a <code>#![no_std]</code> context,
please consider using these alternatives which are the standards libraries
in Rust:</p><ul><li>Goblin: <a href=https://github.com/m4b/goblin>https://github.com/m4b/goblin</a></li><li>gimli-rs - object: <a href=https://github.com/gimli-rs/object>https://github.com/gimli-rs/object</a></li></ul><h1 id=acknowledgement>Acknowledgement</h1><p>Thank you to Erynian for the initial introduction of autocxx, back in the days
I was working at Quarkslab &#x1f609;</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://docs.github.com/en/billing/managing-billing-for-github-actions/about-billing-for-github-actions#minute-multipliers>https://docs.github.com/en/billing/managing-billing-for-github-actions/about-billing-for-github-actions#minute-multipliers</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>Including the generation of an ad-hoc signature for the Apple Silicon binaries (c.f <a href=https://github.com/llvm/llvm-project/blob/llvmorg-18.1.0-rc4/lld/MachO/SyntheticSections.cpp>ld/MachO/SyntheticSections.cpp</a>)&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><div class="d-flex flex-column flex-sm-row align-items-center border-top border-gray-200 mt-6 py-5"><div class=media><div class="avatar mr-4"><img src=https://lief.re/img/avatar/romain.png class="avatar-image rounded-circle" alt=Avatar></div><div class=media-body><span class="text-darkblue text-uppercase-xs font-weight-bolder"><a href=https://www.romainthomas.fr target=_blank>Romain Thomas
</a></span><span class="text-muted font-size-sm d-block">Posted on April 28, 2024</span></div></div></div></div></div></div></section><footer class="footer footer-dark bg-dark"><div class="container text-center"><div class=row><div class="col-12 col-md"><h6 class="footer-header mb-4 pb-md-2">LIEF</h6><a href=https://github.com/lief-project/LIEF class=footer-link>Github
</a><a href=https://lief.re//download class="footer-link mt-2">Download
</a><a href=https://lief.re//doc/latest class="footer-link mt-2">Documentation</a></div><div class="col-12 col-md mt-5 mt-md-0"><h6 class="footer-header mb-4 pb-md-2">Quarkslab</h6><a href=https://blog.quarkslab.com/ class=footer-link>Blog
</a><a href=https://quarkslab.com/ class="footer-link mt-2">Website</a></div><div class="col-12 col-md mt-5 mt-md-0"><h6 class="footer-header mb-4 pb-md-2">Other Tools</h6><a href=https://qbdi.quarkslab.com/ class=footer-link>QBDI
</a><a href=https://triton.quarkslab.com/ class="footer-link mt-2">Triton</a></div></div><div class="d-flex justify-content-center mt-6"><a href=https://twitter.com/lief_project class="hover-lift-light text-decoration-none mx-2"><span class="icon-circle footer-social-icon"><i class="fab fa-twitter fa-lg"></i>
</span></a><a href=https://pypi.org/project/lief/ class="hover-lift-light text-decoration-none mx-2"><span class="icon-circle footer-social-icon"><i class="fab fa-python fa-lg"></i>
</span></a><a href=https://github.com/lief-project/LIEF class="hover-lift-light text-decoration-none mx-2"><span class="icon-circle footer-social-icon"><i class="fab fa-github fa-lg"></i>
</span></a><a href=https://discord.gg/7hRFGWYedu class="hover-lift-light text-decoration-none mx-2"><span class="icon-circle footer-social-icon"><i class="fab fa-discord fa-lg"></i>
</span></a><a href=https://lief.re//index.xml class="hover-lift-light text-decoration-none mx-2"><span class="icon-circle footer-social-icon"><i class="fas fa-rss-square fa-lg"></i></span></a></div></div></footer><script src=https://lief.re//js/vendor.min.js></script><script src=https://lief.re//js/theme.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js></script><script>$("#copy").tooltip({trigger:"click",placement:"bottom"});function setTooltip(e){$("#copy").tooltip("hide").attr("data-original-title",e).tooltip("show")}function hideTooltip(){setTimeout(function(){$("#copy").tooltip("hide")},1e3)}var clipboard=new ClipboardJS("#copy");clipboard.on("success",function(){setTooltip("Copied!"),hideTooltip()}),clipboard.on("error",function(){setTooltip("Failed!"),hideTooltip()})</script></body></html>