<!doctype html><html lang=en-us prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#"><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=description content><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=google-site-verification content="OcWjYs0PdsQZtqu1ms5QSr5FplDf_t5GEneU---wWzM"><meta name=description content="This blog post introduces a new technique to profile C/C++ code with Frida"><meta name=keywords content><meta property="og:type" content="article"><meta property="og:description" content="This blog post introduces a new technique to profile C/C++ code with Frida"><meta property="og:title" content="Profiling C++ code with Frida"><meta property="og:site_name" content="LIEF"><meta property="og:image" content="https://lief.re/blog/2021-03-10-profiling-cpp-code-with-frida/featured.png"><meta property="og:image:type" content="image/png"><meta property="og:image:width" content><meta property="og:image:height" content><meta property="og:url" content="https://lief.re/blog/2021-03-10-profiling-cpp-code-with-frida/"><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2021-03-10
"><meta property="article:modified_time" content="2021-03-10
"><meta name=twitter:card content="summary"><meta name=twitter:site content="@lief_project"><meta name=twitter:creator content="@lief_project"><meta name=twitter:title content="Profiling C++ code with Frida | LIEF"><meta name=twitter:description content="This blog post introduces a new technique to profile C/C++ code with Frida | LIEF"><meta property="twitter:image:src" content="https://lief.re/blog/2021-03-10-profiling-cpp-code-with-frida/featured.png"><meta name=twitter:domain content="https://lief.re/blog/2021-03-10-profiling-cpp-code-with-frida/"><title>LIEF</title>
<link rel=canonical href=https://lief.re/blog/2021-03-10-profiling-cpp-code-with-frida/><link rel=stylesheet type=text/css href=https://lief.re//css/theme.min.css><link rel=stylesheet type=text/css href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css><link rel=stylesheet type=text/css href=https://lief.re//css/vendor.min.css><link rel=stylesheet type=text/css href=https://lief.re//css/termynal.css><link rel=stylesheet type=text/css href=https://lief.re//css/animate.css><link rel=apple-touch-icon href=https://lief.re//img/favicon.ico type=image/x-icon><link rel="shortcut icon" href=https://lief.re//img/favicon.ico type=image/x-icon><link rel=icon href=https://lief.re//img/favicon.ico type=image/x-icon><style></style></head><body class=bg-light><nav class="navbar navbar-expand-lg navbar-light bg-light position-absolute w-100 bg-white" role=navigation><div class="container position-relative"><a href=https://lief.re/ class=navbar-brand>LIEF</a>
<button class=navbar-toggler data-toggle=collapse data-target=#navbar-collapse>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse justify-content-end mt-2 mt-lg-0" id=navbar-collapse><ul class=navbar-nav><li class=nav-item><a class=nav-link href=https://lief.re/><i class="fa-solid fa-house mr-3"></i>
Home</a></li><li class=nav-item><a class=nav-link href=https://lief.re/blog><i class="fa-solid fa-rss mr-3"></i>
Blog</a></li><li class=nav-item><a class=nav-link href=https://lief.re/download><i class="fa-solid fa-download mr-3"></i>
Download</a></li><li class="nav-item dropdown"><a href=https://lief.re/doc/latest class="nav-link dropdown-toggle" data-toggle=dropdown><i class="fa-solid fa-book mr-3"></i>
Documentation</a><div class="dropdown-menu px-4" role=menu><a class="dropdown-item d-flex align-items-center border-bottom border-gray-100 p-2" href=https://lief.re/doc/latest/><span class="svg-icon text-purple mr-3"><svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><title>ionicons-v5-m</title><path d="M160 389a20.91 20.91.0 01-13.82-5.2l-128-112a21 21 0 010-31.6l128-112a21 21 0 0127.66 31.61L63.89 256l109.94 96.19A21 21 0 01160 389z"/><path d="M352 389a21 21 0 01-13.84-36.81L448.11 256 338.17 159.81a21 21 0 0127.66-31.61l128 112a21 21 0 010 31.6l-128 112A20.89 20.89.0 01352 389z"/></svg>
</span><span><p class=mb-0>API
<span class="badge badge-pastel-success font-weight-bold pt-2 ml-1">Latest</span></p><span class=text-secondary>Sphinx & Doxygen API documentation</span>
</span></a><a class="dropdown-item d-flex align-items-center border-bottom border-gray-100 p-2" href=https://lief.re/doc/stable/><span class="svg-icon text-purple mr-3"><svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><title>ionicons-v5-m</title><path d="M160 389a20.91 20.91.0 01-13.82-5.2l-128-112a21 21 0 010-31.6l128-112a21 21 0 0127.66 31.61L63.89 256l109.94 96.19A21 21 0 01160 389z"/><path d="M352 389a21 21 0 01-13.84-36.81L448.11 256 338.17 159.81a21 21 0 0127.66-31.61l128 112a21 21 0 010 31.6l-128 112A20.89 20.89.0 01352 389z"/></svg>
</span><span><p class=mb-0>API
<span class="badge badge-pastel-primary font-weight-bold pt-2 ml-1">Stable</span></p><span class=text-secondary>Sphinx & Doxygen API documentation</span>
</span></a><a class="dropdown-item d-flex align-items-center border-bottom border-gray-100 p-2" href=https://lief.re/doc/latest/changelog.html><span class="svg-icon text-purple mr-3"><svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><title>ionicons-v5-j</title><path d="M256 256s-48-96-126-96c-54.12.0-98 43-98 96s43.88 96 98 96c30 0 56.45-13.18 78-32" style="fill:none;stroke:#000;stroke-linecap:round;stroke-miterlimit:10;stroke-width:48px"/><path d="M256 256s48 96 126 96c54.12.0 98-43 98-96s-43.88-96-98-96c-29.37.0-56.66 13.75-78 32" style="fill:none;stroke:#000;stroke-linecap:round;stroke-miterlimit:10;stroke-width:48px"/></svg>
</span><span><p class=mb-0>Changelog</p><span class=text-secondary>See all updates</span></span></a></div></li><li class=nav-item><a class=nav-link href=https://lief.re/about><i class="fa-solid fa-bars-staggered mr-3"></i>
About</a></li><li class="nav-item ml-lg-3 mt-3 mt-lg-0"><a class="hover-lift-light mt-1" href=https://github.com/lief-project/LIEF target=_blank><i class="fab fa-2x fa-github text-darkblue"></i></a></li><li class="nav-item ml-lg-3 mt-3 mt-lg-0"><a href=https://github.com/sponsors/lief-project/ class="btn btn-outline-pink" target=_blank><i class="fa-solid fa-heart mr-3"></i> Sponsor</a></li></ul></div></div></nav><div class="h-200 h-md-250 bg-light"></div><section class="bg-light pb-8"><div class="container fx-fade-up"><div class="row justify-content-center"><div class="col-lg-12 bg-white shadow-light-lg rounded py-5 px-4 px-md-7 mt-n6"><div class="avatar d-block mx-auto mt-n6 relative-top--7"><a href=https://www.romainthomas.fr target=_blank><img src=https://lief.re/img/avatar/romain.png class="rounded-circle avatar-image shadow" alt=Avatar></a></div><h2 class="text-center font-weight-normal mt-4">Profiling C++ code with Frida</h2><div class="text-center text-muted font-size-sm mt-3"><span class=mr-3><span class="svg-icon svg-icon-sm text-muted relative-top--1 mr-1"><svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><title>ionicons-v5-k</title><polygon points="364.13 125.25 87 403 64 448 108.99 425 386.75 147.87 364.13 125.25" style="fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px"/><path d="M420.69 68.69 398.07 91.31l22.62 22.63 22.62-22.63a16 16 0 000-22.62h0a16 16 0 00-22.62.0z" style="fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px"/></svg>
</span><a href=https://www.romainthomas.fr target=_blank>Romain Thomas </a></span><span class=ml-3><i class="far fa-calendar fa-xs mr-1 relative-top--1"></i>
March 10, 2021</span></div><img src=https://lief.re//img/waves.png class="d-block mx-auto mt-4 mb-5" alt=Wave><div class=text-dark><p>Frida is a well-known reverse engineering framework that enables (along with other functionalities) to
hook functions on closed-source binaries. While hooking is generally used to get dynamic information
about functions for which we don&rsquo;t have the source code, this blog post introduces another use case to
profile C/C++ code.</p><h3 id=code-profiling>Code Profiling</h3><p>LIEF starts to be quite mature but there are still some concerns regarding:</p><ol><li>The speed (especially when rebuilding large ELF binaries)</li><li>The memory consumption</li><li>Compilation time</li></ol><p>These limitations are &ldquo;quite&rdquo; acceptable on modern computers but when
we target embedded systems like iPhone or Android devices, it starts to reach the limits.
Since (spoiler) I started to implement a parser for the Dyld shared cache and
for parsing in-memory Mach-O files, I faced some of these issues.</p><p>To address these problems, we must identify where are the bottleneck and ideally, without modifying too
much the source code.
To profile memory consumption, <code>valgrind --tool=massif</code> does the job pretty well out of the box:
we don&rsquo;t need to pass extra compilation flags nor modifying the source code.
Regarding the code execution, we can profile it with:</p><ol><li>Valgrind (or QBDI?)</li><li>Inserting log functions in the source code</li><li>Using compiler instrumentation: <code>-finstrument-functions</code></li></ol><p>In the context of profiling LIEF, I&rsquo;m mostly interested in profiling the code at the functions level:
&ldquo;How long does a function take to be executed?&rdquo;</p><p>Valgrind provides CPU cycles that are somehow correlated to the execution time but
it requires an extra processing step to identify the function&rsquo;s overhead.
Moreover, since Valgrind instruments the code, it can take time to profile
a large codebase.</p><p>On the other hand, inserting log messages in the code is the easiest way
to get the execution time of functions. I was not completely convinced with this solution
since it adds log messages that are not always needed.</p><p>Finally, Clang and GCC enable to
instrument the source code through the <code>-finstrument-functions</code> compilation flag.
This flag basically inserts the <code>__cyg_profile_func_enter</code> and <code>__cyg_profile_func_exit</code>
functions at the beginning and at the end of the original functions.</p><p>Frida works on compiled code and provides a mechanism (hook) to insert a callback before
a given function and after the execution of the function. It is very similar to the <code>-finstrument-functions</code>,
except that it is done post-compilation.</p><p>To setup a hook, we only have to provide a pointer to the function that aims at being hooked. In the context of profiling
execution time, the callback at the beginning of the function can initialize a <code>std::chrono</code> object
and the callback at the end of the function can print the time spent since the initialization of the <code>std::chrono</code>.</p><p>Let&rsquo;s take a simple example to explain what Frida does. If we have the following function:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#458;font-weight:700>void</span> <span style=color:#900;font-weight:700>heavy_function</span>() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>  <span style=color:#000;font-weight:700>for</span> (size_t i <span style=color:#000;font-weight:700>=</span> <span style=color:#099>0</span>; i <span style=color:#000;font-weight:700>&lt;</span> <span style=color:#099>1000000</span>; <span style=color:#000;font-weight:700>++</span>i) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    <span style=color:#998;font-style:italic>// Code that takes time ...
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#998;font-style:italic></span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>}
</span></span></code></pre></div><p>Frida enables (from a logical point of view) to have:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#458;font-weight:700>void</span> <span style=color:#900;font-weight:700>heavy_function</span>() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>  frida_on_enter();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>  <span style=color:#000;font-weight:700>for</span> (size_t i <span style=color:#000;font-weight:700>=</span> <span style=color:#099>0</span>; i <span style=color:#000;font-weight:700>&lt;</span> <span style=color:#099>1000000</span>; <span style=color:#000;font-weight:700>++</span>i) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    <span style=color:#998;font-style:italic>// Code that takes time ...
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span><span style=color:#998;font-style:italic></span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>  frida_on_leave();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9</span><span>}
</span></span></code></pre></div><p>&mldr; without tweaking the compilation flags :)</p><h2 id=frida-bootstrap>Frida Bootstrap</h2><p>Most of the documentation and the blog posts that we can find on the internet about Frida are based on
the JavaScript API but Frida also provides in the first place the frida-gum SDK <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> that exposes a C API
over the hook engine. This SDK comes with the <code>frida-gum-example.c</code> file that shows how to
setup the hook engine.</p><p>Regarding the API of our profiler, we would like to have :</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#999;font-weight:700;font-style:italic>#include</span> <span style=color:#999;font-weight:700;font-style:italic>&lt;LIEF/ELF.hpp&gt;</span><span style=color:#999;font-weight:700;font-style:italic>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#999;font-weight:700;font-style:italic></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#998;font-style:italic>// Functions to profile
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#998;font-style:italic></span>profile(<span style=color:#000;font-weight:700>&amp;</span>LIEF<span style=color:#000;font-weight:700>::</span>ELF<span style=color:#000;font-weight:700>::</span>Parser<span style=color:#000;font-weight:700>::</span>parse_symbol_version);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>profile(<span style=color:#000;font-weight:700>&amp;</span>LIEF<span style=color:#000;font-weight:700>::</span>ELF<span style=color:#000;font-weight:700>::</span>Parser<span style=color:#000;font-weight:700>::</span>parse_segments<span style=color:#000;font-weight:700>&lt;</span>LIEF<span style=color:#000;font-weight:700>::</span>ELF<span style=color:#000;font-weight:700>::</span>ELF64<span style=color:#000;font-weight:700>&gt;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>LIEF<span style=color:#000;font-weight:700>::</span>ELF<span style=color:#000;font-weight:700>::</span>Parser<span style=color:#000;font-weight:700>::</span>parse(<span style=color:#d14>&#34;./sample.bin&#34;</span>);
</span></span></code></pre></div><p>And an output like:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>$ ./run
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>LIEF::ELF::Parser::parse_symbol_version<span style=color:#000;font-weight:700>()</span> took 39ms
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>LIEF::ELF::Parser::parse_segments<span style=color:#000;font-weight:700>()</span> took 109ms
</span></span></code></pre></div><p>I won&rsquo;t go through all the details of the implementation of the profiler since the source code is on
<a href=https://github.com/lief-project/frida-profiler>Github</a> but the next section covers some tricky parts.</p><p>Firstly, and as mentioned previous section, Frida takes a <strong>void* pointer</strong> on the function to hook. Therefore,
we have to cast <code>&amp;LIEF::ELF::Parser::parse_symbol_version</code> into a <code>void*</code>. One might want to do
<code>reinterpret_cast&lt;void*>()</code> on the function pointer but it does not work. The trick here is to use a union
to get the <code>void*</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#000;font-weight:700>template</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#000;font-weight:700>typename</span> Func<span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#000;font-weight:700>inline</span> <span style=color:#458;font-weight:700>void</span><span style=color:#000;font-weight:700>*</span> cast_func(Func f) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>  <span style=color:#000;font-weight:700>union</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    Func func;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    <span style=color:#458;font-weight:700>void</span><span style=color:#000;font-weight:700>*</span> p;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>  };
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>  func <span style=color:#000;font-weight:700>=</span> f;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>  <span style=color:#000;font-weight:700>return</span> p;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9</span><span>}
</span></span></code></pre></div><p>Secondly, the example <code>frida-gum-example.c</code> uses an enum to identify the function being hooked:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#000;font-weight:700>typedef</span> <span style=color:#000;font-weight:700>enum</span> <span style=color:#458;font-weight:700>_ExampleHookId</span> ExampleHookId;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#000;font-weight:700>enum</span> <span style=color:#458;font-weight:700>_ExampleHookId</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>  EXAMPLE_HOOK_OPEN,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>  EXAMPLE_HOOK_CLOSE
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>};
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>...
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>gum_interceptor_attach (interceptor,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    GSIZE_TO_POINTER (gum_module_find_export_by_name (<span style=color:#0086b3>NULL</span>, <span style=color:#d14>&#34;open&#34;</span>)),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    listener,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    GSIZE_TO_POINTER (EXAMPLE_HOOK_OPEN));
</span></span></code></pre></div><p>In our case, we don&rsquo;t know beforehand which functions will be hooked or profiled by the user.
Consequently, instead of using an enum we use the function&rsquo;s absolute address and we register its name in a
map:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#000;font-weight:700>template</span><span style=color:#000;font-weight:700>&lt;</span><span style=color:#000;font-weight:700>typename</span> Func<span style=color:#000;font-weight:700>&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#458;font-weight:700>void</span> profile_func(Func func, std<span style=color:#000;font-weight:700>::</span>string name) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>  <span style=color:#458;font-weight:700>void</span><span style=color:#000;font-weight:700>*</span> addr <span style=color:#000;font-weight:700>=</span> cast_func(func);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>  funcs[<span style=color:#000;font-weight:700>reinterpret_cast</span><span style=color:#000;font-weight:700>&lt;</span>uintptr_t<span style=color:#000;font-weight:700>&gt;</span>(addr)] <span style=color:#000;font-weight:700>=</span> std<span style=color:#000;font-weight:700>::</span>move(name);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>  gum_interceptor_begin_transaction(ctx_<span style=color:#000;font-weight:700>-&gt;</span>interceptor);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>  gum_interceptor_attach(ctx_<span style=color:#000;font-weight:700>-&gt;</span>interceptor,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>      <span style=color:#998;font-style:italic>/* Target */</span> <span style=color:#000;font-weight:700>reinterpret_cast</span><span style=color:#000;font-weight:700>&lt;</span>gpointer<span style=color:#000;font-weight:700>&gt;</span>(addr),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>      <span style=color:#998;font-style:italic>/* Param  */</span> <span style=color:#000;font-weight:700>reinterpret_cast</span><span style=color:#000;font-weight:700>&lt;</span>GumInvocationListener<span style=color:#000;font-weight:700>*&gt;</span>(ctx_),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>      <span style=color:#998;font-style:italic>/* id     */</span> <span style=color:#000;font-weight:700>reinterpret_cast</span><span style=color:#000;font-weight:700>&lt;</span>gpointer<span style=color:#000;font-weight:700>&gt;</span>(addr));
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>  gum_interceptor_end_transaction(ctx_<span style=color:#000;font-weight:700>-&gt;</span>interceptor);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>}
</span></span></code></pre></div><p>Last but not least, we might want to profile private or protected functions.
To enable the access to the Profiler to protected/private members we can <em>friend</em> an
opaque Profile structure:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#000;font-weight:700>struct</span> <span style=color:#458;font-weight:700>Profiler</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#000;font-weight:700>namespace</span> LIEF {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#000;font-weight:700>class</span> <span style=color:#458;font-weight:700>LIEF_API</span> <span style=color:#900;font-weight:700>Parser</span> : <span style=color:#000;font-weight:700>public</span> LIEF<span style=color:#000;font-weight:700>::</span>Parser {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>  <span style=color:#000;font-weight:700>public</span><span style=color:#000;font-weight:700>:</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>  <span style=color:#000;font-weight:700>friend</span> <span style=color:#000;font-weight:700>struct</span> <span style=color:#a61717;background-color:#e3d2d2>::</span><span style=color:#458;font-weight:700>Profiler</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>  ...
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>};
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9</span><span>}
</span></span></code></pre></div><h2 id=conclusion>Conclusion</h2><p>Through this blog post, we have shown that Frida also has some applications in the field of software
engineering not only for reverse-engineering :)</p><p>This approach can be quite convenient to isolate the profiling process
from the compilation process. It also enables to quickly switch from a given SDK version
to another as long as the profiled functions still exist.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>$ clang++ <span style=color:#000;font-weight:700>[</span>-other-flags<span style=color:#000;font-weight:700>]</span> LIEF-0.9.0/lib/libLIEF.a profile.cpp
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>$ clang++ <span style=color:#000;font-weight:700>[</span>-other-flags<span style=color:#000;font-weight:700>]</span> LIEF-0.12.0/lib/libLIEF.a profile.cpp
</span></span></code></pre></div><p>The source code used in this blog post is available on Github: <a href=https://github.com/lief-project/frida-profiler>lief-project/frida-profiler</a></p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>See <code>frida-gum-devkit-14.2.13-linux-x86_64.tar.xz</code> on <a href=https://github.com/frida/frida/releases>https://github.com/frida/frida/releases</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><div class="d-flex flex-column flex-sm-row align-items-center border-top border-gray-200 mt-6 py-5"><div class=media><div class="avatar mr-4"><img src=https://lief.re/img/avatar/romain.png class="avatar-image rounded-circle" alt=Avatar></div><div class=media-body><span class="text-darkblue text-uppercase-xs font-weight-bolder"><a href=https://www.romainthomas.fr target=_blank>Romain Thomas
</a></span><span class="text-muted font-size-sm d-block">Posted on March 10, 2021</span></div></div></div></div></div></div></section><footer class="footer footer-dark bg-dark"><div class="container text-center"><div class=row><div class="col-12 col-md"><h6 class="footer-header mb-4 pb-md-2">LIEF</h6><a href=https://github.com/lief-project/LIEF class=footer-link>Github
</a><a href=https://lief.re//download class="footer-link mt-2">Download
</a><a href=https://lief.re//doc/latest class="footer-link mt-2">Documentation</a></div><div class="col-12 col-md mt-5 mt-md-0"><h6 class="footer-header mb-4 pb-md-2">Quarkslab</h6><a href=https://blog.quarkslab.com/ class=footer-link>Blog
</a><a href=https://quarkslab.com/ class="footer-link mt-2">Website</a></div><div class="col-12 col-md mt-5 mt-md-0"><h6 class="footer-header mb-4 pb-md-2">Other Tools</h6><a href=https://qbdi.quarkslab.com/ class=footer-link>QBDI
</a><a href=https://triton.quarkslab.com/ class="footer-link mt-2">Triton</a></div></div><div class="d-flex justify-content-center mt-6"><a href=https://twitter.com/lief_project class="hover-lift-light text-decoration-none mx-2"><span class="icon-circle footer-social-icon"><i class="fab fa-twitter fa-lg"></i>
</span></a><a href=https://pypi.org/project/lief/ class="hover-lift-light text-decoration-none mx-2"><span class="icon-circle footer-social-icon"><i class="fab fa-python fa-lg"></i>
</span></a><a href=https://github.com/lief-project/LIEF class="hover-lift-light text-decoration-none mx-2"><span class="icon-circle footer-social-icon"><i class="fab fa-github fa-lg"></i>
</span></a><a href=https://discord.gg/7hRFGWYedu class="hover-lift-light text-decoration-none mx-2"><span class="icon-circle footer-social-icon"><i class="fab fa-discord fa-lg"></i>
</span></a><a href=https://lief.re//index.xml class="hover-lift-light text-decoration-none mx-2"><span class="icon-circle footer-social-icon"><i class="fas fa-rss-square fa-lg"></i></span></a></div></div></footer><script src=https://lief.re//js/vendor.min.js></script><script src=https://lief.re//js/theme.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js></script><script>$("#copy").tooltip({trigger:"click",placement:"bottom"});function setTooltip(e){$("#copy").tooltip("hide").attr("data-original-title",e).tooltip("show")}function hideTooltip(){setTimeout(function(){$("#copy").tooltip("hide")},1e3)}var clipboard=new ClipboardJS("#copy");clipboard.on("success",function(){setTooltip("Copied!"),hideTooltip()}),clipboard.on("error",function(){setTooltip("Failed!"),hideTooltip()})</script></body></html>