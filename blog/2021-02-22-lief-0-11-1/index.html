<!doctype html><html lang=en-us prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#"><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=description content><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=google-site-verification content="OcWjYs0PdsQZtqu1ms5QSr5FplDf_t5GEneU---wWzM"><meta name=description content="This blog post outlines the fixes made in LIEF 0.11.1"><meta name=keywords content><meta property="og:type" content="article"><meta property="og:description" content="This blog post outlines the fixes made in LIEF 0.11.1"><meta property="og:title" content="LIEF - Release 0.11.1"><meta property="og:site_name" content="LIEF"><meta property="og:image" content="https://lief.re/blog/2021-02-22-lief-0-11-1/featured.png"><meta property="og:image:type" content="image/png"><meta property="og:image:width" content><meta property="og:image:height" content><meta property="og:url" content="https://lief.re/blog/2021-02-22-lief-0-11-1/"><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2021-02-22
"><meta property="article:modified_time" content="2021-02-22
"><meta name=twitter:card content="summary"><meta name=twitter:site content="@lief_project"><meta name=twitter:creator content="@lief_project"><meta name=twitter:title content="LIEF - Release 0.11.1 | LIEF"><meta name=twitter:description content="This blog post outlines the fixes made in LIEF 0.11.1 | LIEF"><meta property="twitter:image:src" content="https://lief.re/blog/2021-02-22-lief-0-11-1/featured.png"><meta name=twitter:domain content="https://lief.re/blog/2021-02-22-lief-0-11-1/"><title>LIEF</title>
<link rel=canonical href=https://lief.re/blog/2021-02-22-lief-0-11-1/><link rel=stylesheet type=text/css href=https://lief.re//css/theme.min.css><link rel=stylesheet type=text/css href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css><link rel=stylesheet type=text/css href=https://lief.re//css/vendor.min.css><link rel=stylesheet type=text/css href=https://lief.re//css/termynal.css><link rel=stylesheet type=text/css href=https://lief.re//css/animate.css><link rel=apple-touch-icon href=https://lief.re//img/favicon.ico type=image/x-icon><link rel="shortcut icon" href=https://lief.re//img/favicon.ico type=image/x-icon><link rel=icon href=https://lief.re//img/favicon.ico type=image/x-icon><style></style></head><body class=bg-light><nav class="navbar navbar-expand-lg navbar-light bg-light position-absolute w-100 bg-white" role=navigation><div class="container position-relative"><a href=https://lief.re/ class=navbar-brand>LIEF</a>
<button class=navbar-toggler data-toggle=collapse data-target=#navbar-collapse>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse justify-content-end mt-2 mt-lg-0" id=navbar-collapse><ul class=navbar-nav><li class=nav-item><a class=nav-link href=https://lief.re/><i class="fa-solid fa-house mr-3"></i>
Home</a></li><li class=nav-item><a class=nav-link href=https://lief.re/blog><i class="fa-solid fa-rss mr-3"></i>
Blog</a></li><li class=nav-item><a class=nav-link href=https://lief.re/download><i class="fa-solid fa-download mr-3"></i>
Download</a></li><li class="nav-item dropdown"><a href=https://lief.re/doc/latest class="nav-link dropdown-toggle" data-toggle=dropdown><i class="fa-solid fa-book mr-3"></i>
Documentation</a><div class="dropdown-menu px-4" role=menu><a class="dropdown-item d-flex align-items-center border-bottom border-gray-100 p-2" href=https://lief.re/doc/latest/><span class="svg-icon text-purple mr-3"><svg width="512" height="512" viewBox="0 0 512 512"><title>ionicons-v5-m</title><path d="M160 389a20.91 20.91.0 01-13.82-5.2l-128-112a21 21 0 010-31.6l128-112a21 21 0 0127.66 31.61L63.89 256l109.94 96.19A21 21 0 01160 389z"/><path d="M352 389a21 21 0 01-13.84-36.81L448.11 256 338.17 159.81a21 21 0 0127.66-31.61l128 112a21 21 0 010 31.6l-128 112A20.89 20.89.0 01352 389z"/></svg>
</span><span><p class=mb-0>API
<span class="badge badge-pastel-success font-weight-bold pt-2 ml-1">Latest</span></p><span class=text-secondary>Sphinx & Doxygen API documentation</span>
</span></a><a class="dropdown-item d-flex align-items-center border-bottom border-gray-100 p-2" href=https://lief.re/doc/stable/><span class="svg-icon text-purple mr-3"><svg width="512" height="512" viewBox="0 0 512 512"><title>ionicons-v5-m</title><path d="M160 389a20.91 20.91.0 01-13.82-5.2l-128-112a21 21 0 010-31.6l128-112a21 21 0 0127.66 31.61L63.89 256l109.94 96.19A21 21 0 01160 389z"/><path d="M352 389a21 21 0 01-13.84-36.81L448.11 256 338.17 159.81a21 21 0 0127.66-31.61l128 112a21 21 0 010 31.6l-128 112A20.89 20.89.0 01352 389z"/></svg>
</span><span><p class=mb-0>API
<span class="badge badge-pastel-primary font-weight-bold pt-2 ml-1">Stable</span></p><span class=text-secondary>Sphinx & Doxygen API documentation</span>
</span></a><a class="dropdown-item d-flex align-items-center border-bottom border-gray-100 p-2" href=https://lief.re/doc/latest/changelog.html><span class="svg-icon text-purple mr-3"><svg width="512" height="512" viewBox="0 0 512 512"><title>ionicons-v5-j</title><path d="M256 256s-48-96-126-96c-54.12.0-98 43-98 96s43.88 96 98 96c30 0 56.45-13.18 78-32" style="fill:none;stroke:#000;stroke-linecap:round;stroke-miterlimit:10;stroke-width:48px"/><path d="M256 256s48 96 126 96c54.12.0 98-43 98-96s-43.88-96-98-96c-29.37.0-56.66 13.75-78 32" style="fill:none;stroke:#000;stroke-linecap:round;stroke-miterlimit:10;stroke-width:48px"/></svg>
</span><span><p class=mb-0>Changelog</p><span class=text-secondary>See all updates</span></span></a></div></li><li class=nav-item><a class=nav-link href=https://lief.re/about><i class="fa-solid fa-bars-staggered mr-3"></i>
About</a></li><li class="nav-item ml-lg-3 mt-3 mt-lg-0"><a class="hover-lift-light mt-1" href=https://github.com/lief-project/LIEF target=_blank><i class="fab fa-2x fa-github text-darkblue"></i></a></li><li class="nav-item ml-lg-3 mt-3 mt-lg-0"><a class="hover-lift-light mt-1" href=https://discord.gg/jGQtyAYChJ target=_blank><i class="fab fa-2x fa-discord text-darkblue mr-3"></i></a></li><li class="nav-item ml-lg-3 mt-3 mt-lg-0"><a href=https://github.com/sponsors/lief-project/ class="btn btn-outline-pink" target=_blank><i class="fa-solid fa-heart mr-3"></i> Sponsor</a></li></ul></div></div></nav><div class="h-200 h-md-250 bg-light"></div><section class="bg-light pb-8"><div class="container fx-fade-up"><div class="row justify-content-center"><div class="col-lg-12 bg-white shadow-light-lg rounded py-5 px-4 px-md-7 mt-n6"><div class="avatar d-block mx-auto mt-n6 relative-top--7"><a href=https://www.romainthomas.fr target=_blank><img src=https://lief.re/img/avatar/romain.png class="rounded-circle avatar-image shadow" alt=Avatar></a></div><h2 class="text-center font-weight-normal mt-4">LIEF - Release 0.11.1</h2><div class="text-center text-muted font-size-sm mt-3"><span class=mr-3><span class="svg-icon svg-icon-sm text-muted relative-top--1 mr-1"><svg width="512" height="512" viewBox="0 0 512 512"><title>ionicons-v5-k</title><polygon points="364.13 125.25 87 403 64 448 108.99 425 386.75 147.87 364.13 125.25" style="fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px"/><path d="M420.69 68.69 398.07 91.31l22.62 22.63 22.62-22.63a16 16 0 000-22.62h0a16 16 0 00-22.62.0z" style="fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px"/></svg>
</span><a href=https://www.romainthomas.fr target=_blank>Romain Thomas </a></span><span class=ml-3><i class="far fa-calendar fa-xs mr-1 relative-top--1"></i>
February 22, 2021</span></div><img src=https://lief.re//img/waves.png class="d-block mx-auto mt-4 mb-5" alt=Wave><div class=text-dark><div class="admonition abstract"><p class=admonition-title>Tl;DR</p>LIEF v0.11.1 fixes some issues related to PE Authentihash computation. The new packages are available on PyPI and
the SDKs can be downloaded on the official <a href=https://lief.quarkslab.com/download/>website</a>.<p>Enjoy!</p></div><p>LIEF 0.11.0 missed handling some cases in the processing of the PE Authentihash. This new release addresses
these issues and the following blog post explains the cases we did not handle.</p><h3 id=section-name>Section name</h3><p>PE section&rsquo;s names are stored in a <strong>fixed</strong> char array (8 bytes) which means that a section&rsquo;s name can
contain trailing bytes after the null char:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>pe_section</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>  <span style=color:#cf222e>char</span>     name<span style=color:#1f2328>[</span><span style=color:#0550ae>8</span><span style=color:#1f2328>];</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>  <span style=color:#cf222e>uint32_t</span> RVA<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>  <span style=color:#57606a>// ...
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#57606a></span><span style=color:#1f2328>};</span>
</span></span></code></pre></div><p>Before v0.11.1, LIEF didn&rsquo;t take into account the trailing bytes and stopped to read the section&rsquo;s name
on the first null char:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#cf222e>this</span><span style=color:#0550ae>-&gt;</span>name_ <span style=color:#0550ae>=</span> std<span style=color:#0550ae>::</span>string<span style=color:#1f2328>(</span>header<span style=color:#0550ae>-&gt;</span>name<span style=color:#1f2328>,</span> <span style=color:#cf222e>sizeof</span><span style=color:#1f2328>(</span>header<span style=color:#0550ae>-&gt;</span>name<span style=color:#1f2328>)).</span>c_str<span style=color:#1f2328>();</span>
</span></span></code></pre></div><p>This implementation has two drawbacks. First, we lose information since we don&rsquo;t store the extra trailing bytes.
Regular binaries have zero trailing bytes after the first null char but some of them might use this spot to
hide data.</p><p><img src=section_table_e.png alt="Section name with trailing bytes"></p><p>Secondly, the <strong>full</strong> section name (i.e the whole 8 bytes) is used to compute the Authentihash.
Therefore, if the first null char is followed by trailing bytes different from zero, the computed hash
is inconsistent.</p><h3 id=data-directory>Data directory</h3><p>According to the PE specifications <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> the last entry of the data directory table must
contain a null entry (i.e. an entry with an RVA and size set to 0).</p><center><img src=pe_doc_e.png alt="PE specifications require a last zero entry"></center><p>It turns out that this requirement is
not enforced by the loader. In the case of the binary (<a href=https://www.virustotal.com/gui/file/bc203f2b6a928f1457e9ca99456747bcb7adbbfff789d1c47e9479aac11598af/detection>bc203f2b6a&mldr;</a>)
the last entry is set to <code>0x02b7bc68/0x01a7a0</code> (used for watermarking?).</p><p><img src=data_directory_e.png alt="Last data directory with non-zero entry"></p><p>In the previous versions of LIEF we assumed that the last entry of the data directory table
was always zero. Since the last entry is used to compute the Authentihash value, it led to a bad signature
while it was effectively correct.</p><p>This issue has been addressed in the commit <a href=https://github.com/lief-project/LIEF/commit/3c65ffe2d65f0c6fe63e683e6deef41de2f395b1>3c65ffe</a></p><h3 id=return-value-of-verify_signature>Return value of <code>verify_signature()</code></h3><p>As noticed by <a href=https://twitter.com/saidelike>Cedric Halbronn</a> in the issue <a href=https://github.com/lief-project/LIEF/issues/532>issues/532</a>,
the return value of <a href=https://github.com/lief-project/LIEF/blob/f58605f94c365b5aedf75081ae9b0aebafd5cece/include/LIEF/PE/Binary.hpp#L147-L167>LIEF::PE::Binary::verify_signature</a>
lacks of information when the verification failed. The return value was either
<code>VERIFICATION_FLAGS.OK</code> or <code>VERIFICATION_FLAGS.BAD_SIGNATURE</code> because of a <em>fail-fast</em> implementation
of the verification flag.</p><p>The function now returns flags as follows:</p><pre tabindex=0><code>VERIFICATION_FLAGS.BAD_DIGEST | VERIFICATION_FLAGS.BAD_SIGNATURE | VERIFICATION_FLAGS.CERT_EXPIRED
</code></pre><h3 id=other-issues>Other issues</h3><p>One of the critical issues raised by <a href=https://github.com/imidoriya>imidoriya</a> and fixed in the new version is
the processing of the overlay data when the &ldquo;data directory signature&rdquo; is located in this area (c.f. <a href=https://www.virustotal.com/gui/file/463bb0ec399af716b9ec984dbc96590e180921af073df414b85a2a3b7c27516a/detection>463bb0ec3&mldr;</a>).
This kind of layout triggers a memory error on this part of the
processing <a href=https://github.com/lief-project/LIEF/blob/f58605f94c365b5aedf75081ae9b0aebafd5cece/src/PE/Binary.cpp#L1174-L1187>Binary.cpp#L1174-L1187</a>.
It has been addressed in the commit <a href=https://github.com/lief-project/LIEF/commit/05103f55a6cb993cb20735da3c7a6333e4f600e3>05103f5</a></p><h3 id=acknowledgment>Acknowledgment</h3><p>Thanks to <a href=https://twitter.com/SmugYeti>Andrew Williams</a> for providing the different samples that raised some of these
errors! Thank you also to <a href>Cedric Halbronn</a> and the <a href=https://www.govcert.lu/en/>CERT Gouvernemental of Luxembourg</a>
for their feedback about the API.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://docs.microsoft.com/en-us/windows/win32/debug/pe-format#optional-header-data-directories-image-only>https://docs.microsoft.com/en-us/windows/win32/debug/pe-format#optional-header-data-directories-image-only</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><div class="d-flex flex-column flex-sm-row align-items-center border-top border-gray-200 mt-6 py-5"><div class=media><div class="avatar mr-4"><img src=https://lief.re/img/avatar/romain.png class="avatar-image rounded-circle" alt=Avatar></div><div class=media-body><span class="text-darkblue text-uppercase-xs font-weight-bolder"><a href=https://www.romainthomas.fr target=_blank>Romain Thomas
</a></span><span class="text-muted font-size-sm d-block">Posted on February 22, 2021</span></div></div></div></div></div></div></section><footer class="footer footer-dark bg-dark"><div class="container text-center"><div class=row><div class="col-12 col-md"><h6 class="footer-header mb-4 pb-md-2">LIEF</h6><a href=https://github.com/lief-project/LIEF class=footer-link>Github
</a><a href=https://lief.re//download class="footer-link mt-2">Download
</a><a href=https://lief.re//doc/latest class="footer-link mt-2">Documentation</a></div><div class="col-12 col-md mt-5 mt-md-0"><h6 class="footer-header mb-4 pb-md-2">Quarkslab</h6><a href=https://blog.quarkslab.com/ class=footer-link>Blog
</a><a href=https://quarkslab.com/ class="footer-link mt-2">Website</a></div><div class="col-12 col-md mt-5 mt-md-0"><h6 class="footer-header mb-4 pb-md-2">Other Tools</h6><a href=https://qbdi.quarkslab.com/ class=footer-link>QBDI
</a><a href=https://triton.quarkslab.com/ class="footer-link mt-2">Triton</a></div></div><div class="d-flex justify-content-center mt-6"><a href=https://infosec.exchange/@rh0main class="hover-lift-light text-decoration-none mx-2"><span class="icon-circle footer-social-icon"><i class="fab fa-mastodon fa-lg"></i>
</span></a><a href=https://x.com/lief_project class="hover-lift-light text-decoration-none mx-2"><span class="icon-circle footer-social-icon"><i class="fab fa-x-twitter fa-lg"></i>
</span></a><a href=https://crates.io/crates/lief class="hover-lift-light text-decoration-none mx-2"><span class="icon-circle footer-social-icon"><i class="fab fa-rust fa-lg"></i>
</span></a><a href=https://pypi.org/project/lief/ class="hover-lift-light text-decoration-none mx-2"><span class="icon-circle footer-social-icon"><i class="fab fa-python fa-lg"></i>
</span></a><a href=https://github.com/lief-project/LIEF class="hover-lift-light text-decoration-none mx-2"><span class="icon-circle footer-social-icon"><i class="fab fa-github fa-lg"></i>
</span></a><a href=https://discord.gg/jGQtyAYChJ class="hover-lift-light text-decoration-none mx-2"><span class="icon-circle footer-social-icon"><i class="fab fa-discord fa-lg"></i></span></a></div></div></footer><script src=https://lief.re//js/vendor.min.js></script><script src=https://lief.re//js/theme.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js></script><script>$("#copy").tooltip({trigger:"click",placement:"bottom"});function setTooltip(e){$("#copy").tooltip("hide").attr("data-original-title",e).tooltip("show")}function hideTooltip(){setTimeout(function(){$("#copy").tooltip("hide")},1e3)}var clipboard=new ClipboardJS("#copy");clipboard.on("success",function(){setTooltip("Copied!"),hideTooltip()}),clipboard.on("error",function(){setTooltip("Failed!"),hideTooltip()})</script></body></html>