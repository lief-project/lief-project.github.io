<!doctype html><html lang=en-us prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#"><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=description content><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=google-site-verification content="OcWjYs0PdsQZtqu1ms5QSr5FplDf_t5GEneU---wWzM"><meta name=description content="After spending months on refactoring the ELF builder, here are the improvements."><meta name=keywords content><meta property="og:type" content="article"><meta property="og:description" content="After spending months on refactoring the ELF builder, here are the improvements."><meta property="og:title" content="New ELF Builder"><meta property="og:site_name" content="LIEF"><meta property="og:image" content="https://lief.re/blog/2022-01-23-new-elf-builder/featured.png"><meta property="og:image:type" content="image/png"><meta property="og:image:width" content><meta property="og:image:height" content><meta property="og:url" content="https://lief.re/blog/2022-01-23-new-elf-builder/"><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2022-01-23
"><meta property="article:modified_time" content="2022-01-23
"><meta name=twitter:card content="summary"><meta name=twitter:site content="@lief_project"><meta name=twitter:creator content="@lief_project"><meta name=twitter:title content="New ELF Builder | LIEF"><meta name=twitter:description content="After spending months on refactoring the ELF builder, here are the improvements. | LIEF"><meta property="twitter:image:src" content="https://lief.re/blog/2022-01-23-new-elf-builder/featured.png"><meta name=twitter:domain content="https://lief.re/blog/2022-01-23-new-elf-builder/"><title>LIEF</title><link rel=canonical href=https://lief.re/blog/2022-01-23-new-elf-builder/><link rel=stylesheet type=text/css href=https://lief.re//css/theme.min.css><link rel=stylesheet type=text/css href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css><link rel=stylesheet type=text/css href=https://lief.re//css/vendor.min.css><link rel=stylesheet type=text/css href=https://lief.re//css/termynal.css><link rel=stylesheet type=text/css href=https://lief.re//css/animate.css><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap" rel=stylesheet type=text/css><link rel=apple-touch-icon href=https://lief.re//img/favicon.ico type=image/x-icon><link rel="shortcut icon" href=https://lief.re//img/favicon.ico type=image/x-icon><link rel=icon href=https://lief.re//img/favicon.ico type=image/x-icon><style></style></head><body class=bg-light><nav class="navbar navbar-expand-lg navbar-light bg-light position-absolute w-100 bg-white" role=navigation><div class="container position-relative"><a href=https://lief.re/ class=navbar-brand>LIEF</a>
<button class=navbar-toggler data-toggle=collapse data-target=#navbar-collapse>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse justify-content-end mt-2 mt-lg-0" id=navbar-collapse><ul class=navbar-nav><li class=nav-item><a class=nav-link href=https://lief.re/><i class="fa-solid fa-house mr-3"></i>
Home</a></li><li class=nav-item><a class=nav-link href=https://lief.re/blog><i class="fa-solid fa-rss mr-3"></i>
Blog</a></li><li class=nav-item><a class=nav-link href=https://lief.re/download><i class="fa-solid fa-download mr-3"></i>
Download</a></li><li class="nav-item dropdown"><a href=https://lief.re/doc/latest class="nav-link dropdown-toggle" data-toggle=dropdown><i class="fa-solid fa-book mr-3"></i>
Documentation</a><div class="dropdown-menu px-4" role=menu><a class="dropdown-item d-flex align-items-center border-bottom border-gray-100 p-2" href=https://lief.re/doc/latest/><span class="svg-icon text-purple mr-3"><svg width="512" height="512" viewBox="0 0 512 512"><title>ionicons-v5-m</title><path d="M160 389a20.91 20.91.0 01-13.82-5.2l-128-112a21 21 0 010-31.6l128-112a21 21 0 0127.66 31.61L63.89 256l109.94 96.19A21 21 0 01160 389z"/><path d="M352 389a21 21 0 01-13.84-36.81L448.11 256 338.17 159.81a21 21 0 0127.66-31.61l128 112a21 21 0 010 31.6l-128 112A20.89 20.89.0 01352 389z"/></svg>
</span><span><p class=mb-0>API
<span class="badge badge-pastel-success font-weight-bold pt-2 ml-1">Latest</span></p><span class=text-secondary>Sphinx & Doxygen API documentation</span>
</span></a><a class="dropdown-item d-flex align-items-center border-bottom border-gray-100 p-2" href=https://lief.re/doc/stable/><span class="svg-icon text-purple mr-3"><svg width="512" height="512" viewBox="0 0 512 512"><title>ionicons-v5-m</title><path d="M160 389a20.91 20.91.0 01-13.82-5.2l-128-112a21 21 0 010-31.6l128-112a21 21 0 0127.66 31.61L63.89 256l109.94 96.19A21 21 0 01160 389z"/><path d="M352 389a21 21 0 01-13.84-36.81L448.11 256 338.17 159.81a21 21 0 0127.66-31.61l128 112a21 21 0 010 31.6l-128 112A20.89 20.89.0 01352 389z"/></svg>
</span><span><p class=mb-0>API
<span class="badge badge-pastel-primary font-weight-bold pt-2 ml-1">Stable</span></p><span class=text-secondary>Sphinx & Doxygen API documentation</span>
</span></a><a class="dropdown-item d-flex align-items-center border-bottom border-gray-100 p-2" href=https://lief.re/doc/latest/changelog.html><span class="svg-icon text-purple mr-3"><svg width="512" height="512" viewBox="0 0 512 512"><title>ionicons-v5-j</title><path d="M256 256s-48-96-126-96c-54.12.0-98 43-98 96s43.88 96 98 96c30 0 56.45-13.18 78-32" style="fill:none;stroke:#000;stroke-linecap:round;stroke-miterlimit:10;stroke-width:48px"/><path d="M256 256s48 96 126 96c54.12.0 98-43 98-96s-43.88-96-98-96c-29.37.0-56.66 13.75-78 32" style="fill:none;stroke:#000;stroke-linecap:round;stroke-miterlimit:10;stroke-width:48px"/></svg>
</span><span><p class=mb-0>Changelog</p><span class=text-secondary>See all updates</span></span></a></div></li><li class=nav-item><a class=nav-link href=https://lief.re/about><i class="fa-solid fa-bars-staggered mr-3"></i>
About</a></li><li class="nav-item ml-lg-3 mt-3 mt-lg-0"><a class="hover-lift-light mt-1" href=https://github.com/lief-project/LIEF target=_blank><i class="fab fa-2x fa-github text-darkblue"></i></a></li><li class="nav-item ml-lg-3 mt-3 mt-lg-0"><a class="hover-lift-light mt-1" href=https://discord.gg/jGQtyAYChJ target=_blank><i class="fab fa-2x fa-discord text-darkblue mr-3"></i></a></li><li class="nav-item ml-lg-3 mt-3 mt-lg-0"><a href=https://github.com/sponsors/lief-project/ class="btn btn-outline-pink" target=_blank><i class="fa-solid fa-heart mr-3"></i> Sponsor</a></li></ul></div></div></nav><div class="h-200 h-md-250 bg-light"></div><section class="bg-light pb-8"><div class="container fx-fade-up"><div class="row justify-content-center"><div class="col-lg-12 bg-white shadow-light-lg rounded py-5 px-4 px-md-7 mt-n6"><div class="avatar d-block mx-auto mt-n6 relative-top--7"><a href=https://www.romainthomas.fr target=_blank><img src=https://lief.re/img/avatar/romain.png class="rounded-circle avatar-image shadow" alt=Avatar></a></div><h2 class="text-center font-weight-normal mt-4">New ELF Builder</h2><div class="text-center text-muted font-size-sm mt-3"><span class=mr-3><span class="svg-icon svg-icon-sm text-muted relative-top--1 mr-1"><svg width="512" height="512" viewBox="0 0 512 512"><title>ionicons-v5-k</title><polygon points="364.13 125.25 87 403 64 448 108.99 425 386.75 147.87 364.13 125.25" style="fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px"/><path d="M420.69 68.69 398.07 91.31l22.62 22.63 22.62-22.63a16 16 0 000-22.62h0a16 16 0 00-22.62.0z" style="fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px"/></svg>
</span><a href=https://www.romainthomas.fr target=_blank>Romain Thomas </a></span><span class=ml-3><i class="far fa-calendar fa-xs mr-1 relative-top--1"></i>
January 23, 2022</span></div><img src=https://lief.re//img/waves.png class="d-block mx-auto mt-4 mb-5" alt=Wave><div class=text-dark><h2 id=liefs-modification-process>LIEF&rsquo;s Modification Process</h2><p>Let&rsquo;s start with a small recap of the LIEF modification process.</p><p>To enable executable file formats modification, LIEF transforms the raw executable formats into an object representation.
This object can be manipulated with an API that is mainly exposed through the following interfaces:</p><table><thead><tr><th style=text-align:left>C++</th><th style=text-align:left>Python</th></tr></thead><tbody><tr><td style=text-align:left><a href=https://lief-project.github.io/doc/latest/api/cpp/elf.html#binary>LIEF::ELF::Binary</a></td><td style=text-align:left><a href=https://lief-project.github.io/doc/latest/api/python/elf.html#binary>lief.ELF.Binary</a></td></tr><tr><td style=text-align:left><a href=https://lief-project.github.io/doc/latest/api/cpp/pe.html#binary>LIEF::PE::Binary</a></td><td style=text-align:left><a href=https://lief-project.github.io/doc/latest/api/python/pe.html#binary>lief.PE.Binary</a></td></tr><tr><td style=text-align:left><a href=https://lief-project.github.io/doc/latest/api/cpp/macho.html#binary>LIEF::MachO::Binary</a></td><td style=text-align:left><a href=https://lief-project.github.io/doc/latest/api/python/macho.html#binary>lief.MachO.Binary</a></td></tr></tbody></table><p>Then, the LIEF&rsquo;s <em>builders</em> take the object representation and (<em>try to</em>) reconstruct an executable according
to the user&rsquo;s changes.</p><h2 id=challenges-in-modifying-elf-binaries>Challenges in Modifying ELF Binaries</h2><p>Compared to the PE and Mach-O formats, the ELF format is far the more trickier to handle for both: parsing and modifying.
First off, there is a strong relationship between the segment&rsquo;s virtual address and the file&rsquo;s offset associated with its content.
This relationship is ruled by the following property:</p><span>$$\text{\textcolor{red}{file\_offset}} \equiv \text{\textcolor{blue}{virtual\_address}} \mod{\textcolor{green}{\text{page\_size}}}$$</span><p>So basically, <strong>we can&rsquo;t</strong> insert a segment at an arbitrary virtual address.</p><p>The second difficulty is about the strings table optimization that is performed on the <code>.dynstr</code> section.
To understand how this optimization works, let&rsquo;s consider these two functions:</p><div class=highlight><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#cf222e>int</span> <span style=color:#6639ba>foo</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>  <span style=color:#cf222e>return</span> <span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#cf222e>int</span> <span style=color:#6639ba>call_foo</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>  <span style=color:#cf222e>return</span> foo<span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><p>When these functions are compiled, the compiler generates two symbols for which the names of the symbols are referenced
by the field <code>st_name</code>. Usually, this field points in the <code>.dynstr</code> section:</p><div class=highlight><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>Elf_Sym</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>  Elf_Word  st_name<span style=color:#1f2328>;</span> <span style=color:#57606a>// Offset of the symbol&#39;s name in the .dynstr section
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>  <span style=color:#1f2328>...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#1f2328>};</span>
</span></span></code></pre></div><p>Naively, we could imagine that the <code>.dynstr</code> section contains these two symbols names, one next to the other:</p><pre tabindex=0><code class=language-hex data-lang=hex>00000130  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000140  0d 00 00 00 12 00 01 00  00 00 00 00 00 00 00 00  |................|
00000150  0b 00 00 00 00 00 00 00  0a 00 00 00 12 00 01 00  |................|
00000160  0b 00 00 00 00 00 00 00  0b 00 00 00 00 00 00 00  |................|
00000170  00 74 6f 74 6f 2e 63 70  70 00 66 6f 6f 00 64 6f  |.test.cpp.foo.do|
00000180  5f 66 6f 6f 00 00 00 00  10 00 00 00 00 00 00 00  |_foo............|
00000
</code></pre><p>With such a layout, <code>Elf_Sym("foo").st_name</code> would point to the offset <strong>0x17A</strong> while
<code>Elf_Sym("do_foo").st_name</code> would point to the offset <strong>0x17E</strong>.</p><p>But the real layout of the <code>.dynstr</code> is a bit smaller:</p><pre tabindex=0><code class=language-hex data-lang=hex>00000130  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
00000140  0d 00 00 00 12 00 01 00  00 00 00 00 00 00 00 00  |................|
00000150  0b 00 00 00 00 00 00 00  0a 00 00 00 12 00 01 00  |................|
00000160  0b 00 00 00 00 00 00 00  0b 00 00 00 00 00 00 00  |................|
00000170  00 74 6f 74 6f 2e 63 70  70 00 64 6f 5f 66 6f 6f  |.test.cpp.do_foo|
00000180  00 00 00 00 00 00 00 00  10 00 00 00 00 00 00 00  |................|
00000190  04 00 00 00 03 00 00 00  fc ff ff ff ff ff ff ff  |................|
</code></pre><p>As we can see, it only contains the <code>do_foo</code> string. Since <code>foo</code> is <strong>a suffix</strong> of <code>do_foo</code>,
<code>st_name</code> can point to a different offset of the <strong>same string</strong>. In this layout <code>Elf_Sym("foo").st_name</code> points
to the offset <strong>0x17C</strong> and <code>Elf_Sym("foo").st_name</code> points to <strong>0x17A</strong>.</p><p>Consequently, instead of taking the space of <code>len(call_foo) + 1 + len(foo) + 1</code>, it only takes <code>len(call_foo) + 1</code>
The consequence of this optimization is that we can&rsquo;t naively push back the symbols names in the <code>.dynstr</code> section.
Instead, we have to sort the symbols names such as this optimization can take place.</p><p>In addition to this strings optimization, ELF object files (<code>.o</code>) generated by Clang share the same section for
the names of the sections and for the symbols&rsquo; names.</p><div class=highlight><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>$ readelf -hWS ./hello.o
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>ELF Header:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>  Magic:   7f <span style=color:#0550ae>45</span> 4c <span style=color:#0550ae>46</span> <span style=color:#0550ae>02</span> <span style=color:#0550ae>01</span> <span style=color:#0550ae>01</span> <span style=color:#0550ae>00</span> <span style=color:#0550ae>00</span> <span style=color:#0550ae>00</span> <span style=color:#0550ae>00</span> <span style=color:#0550ae>00</span> <span style=color:#0550ae>00</span> <span style=color:#0550ae>00</span> <span style=color:#0550ae>00</span> <span style=color:#0550ae>00</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>  <span style=color:#0550ae>[</span>...<span style=color:#0550ae>]</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>  Number of section headers:         <span style=color:#0550ae>11</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>  Section header string table index: <span style=color:#0550ae>1</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>Section Headers:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>  <span style=color:#0550ae>[</span>Nr<span style=color:#0550ae>]</span> Name       Type    Address          Off    Size   ES Flg Lk Inf Al
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>  <span style=color:#0550ae>[</span> 0<span style=color:#0550ae>]</span>            NULL    <span style=color:#0550ae>0000000000000000</span> <span style=color:#0550ae>000000</span> <span style=color:#0550ae>000000</span> <span style=color:#0550ae>00</span>      <span style=color:#0550ae>0</span>   <span style=color:#0550ae>0</span>  <span style=color:#0550ae>0</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>  <span style=color:#0550ae>[</span> 1<span style=color:#0550ae>]</span> .strtab    STRTAB  <span style=color:#0550ae>0000000000000000</span> <span style=color:#0550ae>000199</span> <span style=color:#0550ae>000078</span> <span style=color:#0550ae>00</span>      <span style=color:#0550ae>0</span>   <span style=color:#0550ae>0</span>  <span style=color:#0550ae>1</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>  <span style=color:#0550ae>[</span>..<span style=color:#0550ae>]</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>  <span style=color:#0550ae>[</span>10<span style=color:#0550ae>]</span> .symtab    SYMTAB  <span style=color:#0550ae>0000000000000000</span> 0000c0 <span style=color:#0550ae>000090</span> <span style=color:#0550ae>18</span>      <span style=color:#0550ae>1</span>   <span style=color:#0550ae>4</span>  <span style=color:#0550ae>8</span>
</span></span></code></pre></div><p>As we can notice, the <em>Section header string table index</em> of the ELF header indexes the <code>.strtab</code>
which is also the section associated with the symbols&rsquo; names (cf. the <em>link</em> attribute of the <code>.symtab</code>).</p><p>It results that we have to consider this kind of ELF file differently from regular libraries or executables.</p><p>There are other nasty tricks like the management of the ELF constructors between Linux and Android but this
will be covered in another blog post.</p><h2 id=the-new-elf-builder>The New ELF Builder</h2><p>For the historical context, I created LIEF during my internship at <a href=https://quarkslab.com/>Quarkslab</a>
with the supervision of <a href=http://serge.liyun.free.fr>Serge-Sans-Paille</a> and <a href=https://aguinet.github.io/>Adrien Guinet</a>
and the trust/boost from <a href=https://quarkslab.com/about/>Fred Raynal</a>.</p><p>Even though I had the chance to get valuable feedback and review from them, I clearly made poor design decisions in LIEF
and the implementation of the ELF builder is one of them.</p><p>Basically, the implementation is <strong>recursive</strong> such as in the extreme cases the builder re-computes the same
information several times.</p><p>In the new implementation, we added a new stage in the build process that pre-computes the offsets of the new sections
and the data that need to be relocated.
This pre-computation enables to know exactly which parts of the ELF structures need to be relocated according to the
user&rsquo;s changes.
This computation is managed by the <a href=https://github.com/lief-project/LIEF/blob/2ae5327e86f50fe87733d8641d4e7bc3774e3087/src/ELF/ExeLayout.hpp>Layout</a> class which has two implementations depending on
whether it is an ELF object or a library/executable.</p><p>Compared to the previous ELF builder, this new implementation produces smaller files (with fewer ELF segments)
as exposed in the following figure. This figure compares the number of segments between the former and the new implementation:</p><center><img src=bench_nb_segments.png alt="Comparison of the number of segments generated"><br><br></center><p>In addition, it supports larger binaries faster as a consequence of the new linear implementation of the ELF builder :)</p><center><img src=bench_time.png alt="Comparison of the number of segments generated"><br><br></center><p>To perform these benchmarks, we generated ELF binaries with the modifications described in the following script:</p><div class=highlight><pre tabindex=0 style=background-color:#f7f7f7;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-python data-lang=python><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#cf222e>import</span> <span style=color:#24292e>lief</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>elf<span style=color:#1f2328>:</span> lief<span style=color:#0550ae>.</span>ELF<span style=color:#0550ae>.</span>Binary <span style=color:#0550ae>=</span> lief<span style=color:#0550ae>.</span>parse<span style=color:#1f2328>(</span>file_path<span style=color:#0550ae>.</span>as_posix<span style=color:#1f2328>())</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#57606a># Force relocating the .dynamic/.dynstr</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>elf<span style=color:#0550ae>.</span>add_library<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;a_very_long_name.so&#34;</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#57606a># For relocating the interpreter</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>elf<span style=color:#0550ae>.</span>interpreter <span style=color:#0550ae>=</span> <span style=color:#0a3069>&#34;/a/very/longlonglong/interpreter-1.2.3.bin&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#57606a># Force relocating .dynsym / .gnu.hash table</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#cf222e>for</span> i <span style=color:#0550ae>in</span> <span style=color:#6639ba>range</span><span style=color:#1f2328>(</span><span style=color:#0550ae>10</span><span style=color:#1f2328>):</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    elf<span style=color:#0550ae>.</span>add_exported_function<span style=color:#1f2328>(</span><span style=color:#0550ae>0xdeadc0de</span> <span style=color:#0550ae>+</span> i<span style=color:#1f2328>,</span> <span style=color:#0a3069>f</span><span style=color:#0a3069>&#34;new_export_</span><span style=color:#0a3069>{</span>i<span style=color:#0a3069>}</span><span style=color:#0a3069>&#34;</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#57606a># Add a segment</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>segment         <span style=color:#0550ae>=</span> lief<span style=color:#0550ae>.</span>ELF<span style=color:#0550ae>.</span>Segment<span style=color:#1f2328>()</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>segment<span style=color:#0550ae>.</span>type    <span style=color:#0550ae>=</span> lief<span style=color:#0550ae>.</span>ELF<span style=color:#0550ae>.</span>SEGMENT_TYPES<span style=color:#0550ae>.</span>LOAD
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>segment<span style=color:#0550ae>.</span>content <span style=color:#0550ae>=</span> <span style=color:#1f2328>[</span><span style=color:#0550ae>0xcc</span><span style=color:#1f2328>]</span> <span style=color:#0550ae>*</span> <span style=color:#0550ae>0x23</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>elf<span style=color:#0550ae>.</span>add<span style=color:#1f2328>(</span>segment<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>elf<span style=color:#0550ae>.</span>write<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;/tmp/bench.bin&#34;</span><span style=color:#1f2328>)</span>
</span></span></code></pre></div><p>The raw results of the benchmark are also available <a href=benchmark.txt>here</a></p><h2 id=final-words>Final Words</h2><p>These new improvements introduce breaking changes in the ELF binaries generated by LIEF but:</p><ol><li>The final binary size should be smaller</li><li>The building time should be much faster</li></ol><p>We tried to cover most of the cases in the tests suite but some corner cases with exotic compilers or linkers might
break the final binaries.</p><p>Since this improvement aims at being in the next release, feel free to drop an email or to open an issue if
you find a bug with this new implementation.</p><hr><blockquote><small><i>Since September I continue maintaining LIEF exclusively in my spare so issues and new features are
addressed with more delay.</i></small></blockquote></div><div class="d-flex flex-column flex-sm-row align-items-center border-top border-gray-200 mt-6 py-5"><div class=media><div class="avatar mr-4"><img src=https://lief.re/img/avatar/romain.png class="avatar-image rounded-circle" alt=Avatar></div><div class=media-body><span class="text-darkblue text-uppercase-xs font-weight-bolder"><a href=https://www.romainthomas.fr target=_blank>Romain Thomas
</a></span><span class="text-muted font-size-sm d-block">Posted on January 23, 2022</span></div></div></div></div></div></div></section><footer class="footer footer-dark bg-dark"><div class="container text-center"><div class=row><div class="col-12 col-md"><h6 class="footer-header mb-4 pb-md-2">LIEF</h6><a href=https://github.com/lief-project/LIEF class=footer-link>Github
</a><a href=https://lief.re//download class="footer-link mt-2">Download
</a><a href=https://lief.re//doc/latest class="footer-link mt-2">Documentation</a></div><div class="col-12 col-md mt-5 mt-md-0"><h6 class="footer-header mb-4 pb-md-2">Quarkslab</h6><a href=https://blog.quarkslab.com/ class=footer-link>Blog
</a><a href=https://quarkslab.com/ class="footer-link mt-2">Website</a></div><div class="col-12 col-md mt-5 mt-md-0"><h6 class="footer-header mb-4 pb-md-2">Other Tools</h6><a href=https://qbdi.quarkslab.com/ class=footer-link>QBDI
</a><a href=https://triton.quarkslab.com/ class="footer-link mt-2">Triton</a></div></div><div class="d-flex justify-content-center mt-6"><a href=https://infosec.exchange/@rh0main class="hover-lift-light text-decoration-none mx-2"><span class="icon-circle footer-social-icon"><i class="fab fa-mastodon fa-lg"></i>
</span></a><a href=https://x.com/lief_project class="hover-lift-light text-decoration-none mx-2"><span class="icon-circle footer-social-icon"><i class="fab fa-x-twitter fa-lg"></i>
</span></a><a href=https://crates.io/crates/lief class="hover-lift-light text-decoration-none mx-2"><span class="icon-circle footer-social-icon"><i class="fab fa-rust fa-lg"></i>
</span></a><a href=https://pypi.org/project/lief/ class="hover-lift-light text-decoration-none mx-2"><span class="icon-circle footer-social-icon"><i class="fab fa-python fa-lg"></i>
</span></a><a href=https://github.com/lief-project/LIEF class="hover-lift-light text-decoration-none mx-2"><span class="icon-circle footer-social-icon"><i class="fab fa-github fa-lg"></i>
</span></a><a href=https://discord.gg/jGQtyAYChJ class="hover-lift-light text-decoration-none mx-2"><span class="icon-circle footer-social-icon"><i class="fab fa-discord fa-lg"></i></span></a></div></div></footer><script src=https://lief.re//js/vendor.min.js></script><script src=https://lief.re//js/theme.min.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css integrity=sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js integrity=sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4 crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js integrity=sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa crossorigin=anonymous onload=renderMathInElement(document.body)></script><script src=https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js></script><script>$("#copy").tooltip({trigger:"click",placement:"bottom"});function setTooltip(e){$("#copy").tooltip("hide").attr("data-original-title",e).tooltip("show")}function hideTooltip(){setTimeout(function(){$("#copy").tooltip("hide")},1e3)}var clipboard=new ClipboardJS("#copy");clipboard.on("success",function(){setTooltip("Copied!"),hideTooltip()}),clipboard.on("error",function(){setTooltip("Failed!"),hideTooltip()})</script></body></html>