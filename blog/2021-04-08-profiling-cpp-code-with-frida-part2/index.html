<!doctype html><html lang=en-us prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#"><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=description content><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=google-site-verification content="OcWjYs0PdsQZtqu1ms5QSr5FplDf_t5GEneU---wWzM"><meta name=description content="This blog post brings additional information about using Frida to hook function in a static library. It exposes the limits of the approach regarding the different C++ ABI"><meta name=keywords content><meta property="og:type" content="article"><meta property="og:description" content="This blog post brings additional information about using Frida to hook function in a static library. It exposes the limits of the approach regarding the different C++ ABI"><meta property="og:title" content="Profiling C++ code with Frida (2nd part)"><meta property="og:site_name" content="LIEF"><meta property="og:image" content="https://lief.re/blog/2021-04-08-profiling-cpp-code-with-frida-part2/featured.png"><meta property="og:image:type" content="image/png"><meta property="og:image:width" content><meta property="og:image:height" content><meta property="og:url" content="https://lief.re/blog/2021-04-08-profiling-cpp-code-with-frida-part2/"><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2021-04-08
"><meta property="article:modified_time" content="2021-04-08
"><meta name=twitter:card content="summary"><meta name=twitter:site content="@lief_project"><meta name=twitter:creator content="@lief_project"><meta name=twitter:title content="Profiling C++ code with Frida (2nd part) | LIEF"><meta name=twitter:description content="This blog post brings additional information about using Frida to hook function in a static library. It exposes the limits of the approach regarding the different C++ ABI | LIEF"><meta property="twitter:image:src" content="https://lief.re/blog/2021-04-08-profiling-cpp-code-with-frida-part2/featured.png"><meta name=twitter:domain content="https://lief.re/blog/2021-04-08-profiling-cpp-code-with-frida-part2/"><title>LIEF</title>
<link rel=canonical href=https://lief.re/blog/2021-04-08-profiling-cpp-code-with-frida-part2/><link rel=stylesheet type=text/css href=https://lief.re//css/theme.min.css><link rel=stylesheet type=text/css href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css><link rel=stylesheet type=text/css href=https://lief.re//css/vendor.min.css><link rel=stylesheet type=text/css href=https://lief.re//css/termynal.css><link rel=stylesheet type=text/css href=https://lief.re//css/animate.css><link rel=apple-touch-icon href=https://lief.re//img/favicon.ico type=image/x-icon><link rel="shortcut icon" href=https://lief.re//img/favicon.ico type=image/x-icon><link rel=icon href=https://lief.re//img/favicon.ico type=image/x-icon><style></style></head><body class=bg-light><nav class="navbar navbar-expand-lg navbar-light bg-light position-absolute w-100 bg-white" role=navigation><div class="container position-relative"><a href=https://lief.re/ class=navbar-brand>LIEF</a>
<button class=navbar-toggler data-toggle=collapse data-target=#navbar-collapse>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse justify-content-end mt-2 mt-lg-0" id=navbar-collapse><ul class=navbar-nav><li class=nav-item><a class=nav-link href=https://lief.re/><i class="fa-solid fa-house mr-3"></i>
Home</a></li><li class=nav-item><a class=nav-link href=https://lief.re/blog><i class="fa-solid fa-rss mr-3"></i>
Blog</a></li><li class=nav-item><a class=nav-link href=https://lief.re/download><i class="fa-solid fa-download mr-3"></i>
Download</a></li><li class="nav-item dropdown"><a href=https://lief.re/doc/latest class="nav-link dropdown-toggle" data-toggle=dropdown><i class="fa-solid fa-book mr-3"></i>
Documentation</a><div class="dropdown-menu px-4" role=menu><a class="dropdown-item d-flex align-items-center border-bottom border-gray-100 p-2" href=https://lief.re/doc/latest/><span class="svg-icon text-purple mr-3"><svg width="512" height="512" viewBox="0 0 512 512"><title>ionicons-v5-m</title><path d="M160 389a20.91 20.91.0 01-13.82-5.2l-128-112a21 21 0 010-31.6l128-112a21 21 0 0127.66 31.61L63.89 256l109.94 96.19A21 21 0 01160 389z"/><path d="M352 389a21 21 0 01-13.84-36.81L448.11 256 338.17 159.81a21 21 0 0127.66-31.61l128 112a21 21 0 010 31.6l-128 112A20.89 20.89.0 01352 389z"/></svg>
</span><span><p class=mb-0>API
<span class="badge badge-pastel-success font-weight-bold pt-2 ml-1">Latest</span></p><span class=text-secondary>Sphinx & Doxygen API documentation</span>
</span></a><a class="dropdown-item d-flex align-items-center border-bottom border-gray-100 p-2" href=https://lief.re/doc/stable/><span class="svg-icon text-purple mr-3"><svg width="512" height="512" viewBox="0 0 512 512"><title>ionicons-v5-m</title><path d="M160 389a20.91 20.91.0 01-13.82-5.2l-128-112a21 21 0 010-31.6l128-112a21 21 0 0127.66 31.61L63.89 256l109.94 96.19A21 21 0 01160 389z"/><path d="M352 389a21 21 0 01-13.84-36.81L448.11 256 338.17 159.81a21 21 0 0127.66-31.61l128 112a21 21 0 010 31.6l-128 112A20.89 20.89.0 01352 389z"/></svg>
</span><span><p class=mb-0>API
<span class="badge badge-pastel-primary font-weight-bold pt-2 ml-1">Stable</span></p><span class=text-secondary>Sphinx & Doxygen API documentation</span>
</span></a><a class="dropdown-item d-flex align-items-center border-bottom border-gray-100 p-2" href=https://lief.re/doc/latest/changelog.html><span class="svg-icon text-purple mr-3"><svg width="512" height="512" viewBox="0 0 512 512"><title>ionicons-v5-j</title><path d="M256 256s-48-96-126-96c-54.12.0-98 43-98 96s43.88 96 98 96c30 0 56.45-13.18 78-32" style="fill:none;stroke:#000;stroke-linecap:round;stroke-miterlimit:10;stroke-width:48px"/><path d="M256 256s48 96 126 96c54.12.0 98-43 98-96s-43.88-96-98-96c-29.37.0-56.66 13.75-78 32" style="fill:none;stroke:#000;stroke-linecap:round;stroke-miterlimit:10;stroke-width:48px"/></svg>
</span><span><p class=mb-0>Changelog</p><span class=text-secondary>See all updates</span></span></a></div></li><li class=nav-item><a class=nav-link href=https://lief.re/about><i class="fa-solid fa-bars-staggered mr-3"></i>
About</a></li><li class="nav-item ml-lg-3 mt-3 mt-lg-0"><a class="hover-lift-light mt-1" href=https://github.com/lief-project/LIEF target=_blank><i class="fab fa-2x fa-github text-darkblue"></i></a></li><li class="nav-item ml-lg-3 mt-3 mt-lg-0"><a class="hover-lift-light mt-1" href=https://discord.gg/jGQtyAYChJ target=_blank><i class="fab fa-2x fa-discord text-darkblue mr-3"></i></a></li><li class="nav-item ml-lg-3 mt-3 mt-lg-0"><a href=https://github.com/sponsors/lief-project/ class="btn btn-outline-pink" target=_blank><i class="fa-solid fa-heart mr-3"></i> Sponsor</a></li></ul></div></div></nav><div class="h-200 h-md-250 bg-light"></div><section class="bg-light pb-8"><div class="container fx-fade-up"><div class="row justify-content-center"><div class="col-lg-12 bg-white shadow-light-lg rounded py-5 px-4 px-md-7 mt-n6"><div class="avatar d-block mx-auto mt-n6 relative-top--7"><a href=https://www.romainthomas.fr target=_blank><img src=https://lief.re/img/avatar/romain.png class="rounded-circle avatar-image shadow" alt=Avatar></a></div><h2 class="text-center font-weight-normal mt-4">Profiling C++ code with Frida (2nd part)</h2><div class="text-center text-muted font-size-sm mt-3"><span class=mr-3><span class="svg-icon svg-icon-sm text-muted relative-top--1 mr-1"><svg width="512" height="512" viewBox="0 0 512 512"><title>ionicons-v5-k</title><polygon points="364.13 125.25 87 403 64 448 108.99 425 386.75 147.87 364.13 125.25" style="fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px"/><path d="M420.69 68.69 398.07 91.31l22.62 22.63 22.62-22.63a16 16 0 000-22.62h0a16 16 0 00-22.62.0z" style="fill:none;stroke:#000;stroke-linecap:round;stroke-linejoin:round;stroke-width:32px"/></svg>
</span><a href=https://www.romainthomas.fr target=_blank>Romain Thomas </a></span><span class=ml-3><i class="far fa-calendar fa-xs mr-1 relative-top--1"></i>
April 8, 2021</span></div><img src=https://lief.re//img/waves.png class="d-block mx-auto mt-4 mb-5" alt=Wave><div class=text-dark><div class="admonition abstract"><p class=admonition-title>Tl;DR</p>This blog post is not, strictly speaking, related to LIEF but it aims at completing
the previous blog about profiling code with Frida. In particular, it exposes the limits
of our approach regarding the Microsoft/Itanium ABI.<p>Long story short, the previous code <strong>does not work</strong> on Linux/OSX for virtual functions.</p></div><p>The previous blog post tried to show a use case of Frida to profile C++ functions.
In particular, it exposed what we called a <em>trick</em> to convert a C++ member function into a <code>void*</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> Func<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#cf222e>inline</span> <span style=color:#cf222e>void</span><span style=color:#0550ae>*</span> cast_func<span style=color:#1f2328>(</span>Func f<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>  <span style=color:#cf222e>union</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    Func func<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    <span style=color:#cf222e>void</span><span style=color:#0550ae>*</span> p<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>  <span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>  func <span style=color:#0550ae>=</span> f<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>  <span style=color:#cf222e>return</span> p<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><p>First, and as noticed by Julien Jorge, writing a union&rsquo;s field and accessing another field of this union is
<a href=https://en.cppreference.com/w/cpp/language/union#Explanation>undefined behavior</a>:</p><blockquote><p>It&rsquo;s undefined behavior to read from the member of the union that wasn&rsquo;t most recently written.
Many compilers implement, as a non-standard language extension, the ability to read inactive members of a union.</p></blockquote><p>Thanks also to the feedback from Julien Jorge, there is another issue when converting a C++ member function
into a raw pointer.</p><p>Basically, a member function pointer is not the same kind of pointer as a regular C function.
While the regular size of a C function pointer is the same as <code>sizeof(void*)</code>, the size of a
member function pointer is usually greater:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>Foo</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>  <span style=color:#cf222e>void</span> <span style=color:#6639ba>bar</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#cf222e>int</span> <span style=color:#6639ba>main</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>  printf<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;sizeof(&amp;Foo::bar): %d</span><span style=color:#0a3069>\n</span><span style=color:#0a3069>&#34;</span><span style=color:#1f2328>,</span> <span style=color:#cf222e>sizeof</span><span style=color:#1f2328>(</span><span style=color:#0550ae>&amp;</span>Foo<span style=color:#0550ae>::</span>bar<span style=color:#1f2328>));</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>  <span style=color:#cf222e>return</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>$ clang++ sizeof_member.cpp -o sizof_member
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>$ ./sizeof_member
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>sizeof<span style=color:#0550ae>(</span><span style=color:#1f2328>&amp;</span>Foo::bar<span style=color:#0550ae>)</span>: <span style=color:#0550ae>16</span>
</span></span></code></pre></div><p>The layout of a member function pointer is ABI specific but according to LLVM&rsquo;s source code
we can distinguish two ABI that describe this layout:</p><ol><li><a href=https://itanium-cxx-abi.github.io/cxx-abi/>Itanium CXX ABI</a> which is used on Linux, iOS, OSX, Android, &mldr;</li><li>Microsoft</li></ol><h2 id=itanium-abi>Itanium ABI</h2><p>For the Itanium CXX ABI and according to the official documentation, <strong>non-virtual</strong> functions have the following structure:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>  uintptr_t ptr<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>  ptrdiff_t adj<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#1f2328>};</span>
</span></span></code></pre></div><p>Where, <code>ptr</code> is the address of the function and <code>adj</code> is an offset applied on <code>this</code> in the case
of multi-inheritance.</p><p>So in our <em>bad-coded</em> casting function <code>cast_func()</code>, it works as expected for non-virtual functions since we access
the first field <code>ptr</code> which is the function pointer.
We can observe these two fields with the following piece of code <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> Func<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#cf222e>void</span> print<span style=color:#1f2328>(</span>Func f<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>  <span style=color:#cf222e>union</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    Func fcn<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#cf222e>struct</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>      uintptr_t ptr<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>      ptrdiff_t adj<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    <span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>  <span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>  fcn <span style=color:#0550ae>=</span> f<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>  printf<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;%016lx | %016lx</span><span style=color:#0a3069>\n</span><span style=color:#0a3069>&#34;</span><span style=color:#1f2328>,</span> ptr<span style=color:#1f2328>,</span> adj<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><p>that outputs this kind of values:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>Foo</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>  <span style=color:#cf222e>void</span> <span style=color:#6639ba>bar</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span><span style=color:#cf222e>int</span> <span style=color:#6639ba>main</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>  print<span style=color:#1f2328>(</span><span style=color:#0550ae>&amp;</span>Foo<span style=color:#0550ae>::</span>bar<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>  <span style=color:#cf222e>return</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><pre tabindex=0><code>$ ./show_fields
00005568e19021e0 | 0000000000000000
</code></pre><p>If <code>bar()</code> were a <strong>virtual function</strong>, the meaning of the <code>ptr</code> field
would be different. Still according to the Itanium CXX ABI, the value of <code>ptr</code> in the case of
a virtual function is 1 plus the offset of the function within the v-table.
In particular, we can&rsquo;t access the address of the function without <code>this</code> since
the vtable is embedded in the layout of the object. <sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup></p><p><img src=cxxabi.png alt="Itanium CXX ABI"></p><h2 id=microsoft-abi>Microsoft ABI</h2><p>Regarding the Microsoft ABI, there is not as much documentation compared to the &ldquo;Linux/OSX&rdquo; ABI.
LLVM supports this ABI as described in <a href=https://github.com/llvm/llvm-project/blob/a59665930b87d7510002dcf1f292b290673a47d3/clang/lib/CodeGen/MicrosoftCXXABI.cpp>clang/lib/CodeGen/MicrosoftCXXABI.cpp</a>
but I was still curious to know how (without LLVM) the layout of a function member pointer looks like.
One could look at <code>c1xx.dll/c2.dll</code> located in the Visual Studio directory but these libraries
are not straightforward to reverse.</p><p>Alternately, we can try to infer the layout from the assembly code output.
First of all, the result of <code>sizeof()</code> applied to a function member pointer is 16.
16 being twice a pointer&rsquo;s size on an 64-bits architecture,
we can start following the Itanium ABI and confirm or infirm our choices:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>FuncMemPtr</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>  uintptr_t unknown1<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>  uintptr_t unknown2<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#1f2328>};</span>
</span></span></code></pre></div><p>Then we can <em>unpack</em> the fields of the function member pointer with the union trick:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>Base1</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>  <span style=color:#cf222e>virtual</span> <span style=color:#cf222e>void</span> <span style=color:#6639ba>f</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span> <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>Base2</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>  <span style=color:#cf222e>virtual</span> <span style=color:#cf222e>void</span> <span style=color:#6639ba>g</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>Derived2</span> <span style=color:#0550ae>:</span> Base2<span style=color:#1f2328>,</span> Base1 <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>  <span style=color:#cf222e>virtual</span> <span style=color:#cf222e>void</span> <span style=color:#6639ba>f</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>  <span style=color:#cf222e>virtual</span> <span style=color:#cf222e>void</span> <span style=color:#6639ba>g</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>  <span style=color:#cf222e>virtual</span> <span style=color:#6639ba>h</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#cf222e>template</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>typename</span> Func<span style=color:#0550ae>&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#cf222e>void</span> info<span style=color:#1f2328>(</span>Func f<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>  <span style=color:#cf222e>union</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>    Func fcn<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    <span style=color:#cf222e>struct</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>      uintptr_t unknown1<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>      uintptr_t unknown2<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    <span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>  <span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>  fcn <span style=color:#0550ae>=</span> f<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#cf222e>int</span> <span style=color:#6639ba>main</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>  info<span style=color:#1f2328>(</span><span style=color:#0550ae>&amp;</span>Derived2<span style=color:#0550ae>::</span>h<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>  info<span style=color:#1f2328>(</span><span style=color:#0550ae>&amp;</span>Derived2<span style=color:#0550ae>::</span>f<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>  <span style=color:#cf222e>return</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><p>The layout of the non-virtual function <code>Derived2::h()</code> seems to follow the same layout as the Itanium ABI
where we find the function pointer in the first field.</p><p><img src=msvc_non_virtual.png alt="Non virtual function layout"></p><p>For the <strong>virtual function</strong> <code>Derived2::f</code>,
we can notice a first memory write that fills the first field with a pointer to a thunk <sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup> function
while the second field contains a constant which matches the value of <em>this adjustor</em>.
For the second field (<em>this adjustor</em>), we can switch from <code>&amp;Derived2::f</code> to <code>&amp;Derived2::g</code>
to confirm that it changes accordingly to the output of <code>/d1reportAllClassLayout</code></p><p><img src=msvc_virtual.png alt="Virtual function layout"></p><p>This leads to the following guessing:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>MsvcCXXFuncMember</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>  uintptr_t fnc_ptr<span style=color:#1f2328>;</span> <span style=color:#57606a>// That can be a thunk for virtual function
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#57606a></span>  <span style=color:#cf222e>int</span> adjustor<span style=color:#1f2328>;</span> <span style=color:#57606a>// int because of mov DWORD and not mov QWORD in this assembly output
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#57606a></span><span style=color:#1f2328>};</span>
</span></span></code></pre></div><p>These two fields follow the <a href=https://github.com/llvm/llvm-project/blob/4708a05da03038271a1a2c1cbdfe78aebfaa7afc/clang/lib/AST/MicrosoftCXXABI.cpp#L223-L234>LLVM implementation</a>:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>  <span style=color:#57606a>// A pointer to the member function to call.  If the member function is
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#57606a></span>  <span style=color:#57606a>// virtual, this will be a thunk that forwards to the appropriate vftable
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#57606a></span>  <span style=color:#57606a>// slot.
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#57606a></span>  <span style=color:#cf222e>void</span> <span style=color:#0550ae>*</span>FunctionPointerOrVirtualThunk<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>  <span style=color:#57606a>// An offset to add to the address of the vbtable pointer after
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#57606a></span>  <span style=color:#57606a>// (possibly) selecting the virtual base but before resolving and calling
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#57606a></span>  <span style=color:#57606a>// the function.
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#57606a></span>  <span style=color:#57606a>// Only needed if the class has any virtual bases or bases at a non-zero
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#57606a></span>  <span style=color:#57606a>// offset.
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#57606a></span>  <span style=color:#cf222e>int</span> NonVirtualBaseAdjustment<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>  <span style=color:#57606a>// The offset of the vb-table pointer within the object. Only needed for
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span><span style=color:#57606a></span>  <span style=color:#57606a>// incomplete types.
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#57606a></span>  <span style=color:#cf222e>int</span> VBPtrOffset<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>  <span style=color:#57606a>// An offset within the vb-table that selects the virtual base containing
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#57606a></span>  <span style=color:#57606a>// the member.  Loading from this offset produces a new offset that is
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#57606a></span>  <span style=color:#57606a>// added to the address of the vb-table pointer to produce the base.
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#57606a></span>  <span style=color:#cf222e>int</span> VirtualBaseAdjustmentOffset<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#1f2328>};</span>
</span></span></code></pre></div><p>From LLVM, we also learn that the full layout can contain up to <em>four fields</em>. We can trigger the third field with
the following change:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>@@ -11,3 +11,3 @@
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#82071e;background-color:#ffebe9>-struct Derived2 : Base2, Base1 {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#82071e;background-color:#ffebe9></span><span style=color:#116329;background-color:#dafbe1>+struct Derived2 : Base2, virtual Base1 {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#116329;background-color:#dafbe1></span>   virtual void f() {}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>@@ -32 +32,2 @@
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span> }
</span></span></code></pre></div><p><img src=msvc_third_field.png alt=VBPtrOffset></p><p>The fourth field is a bit more tricky to trigger and the following code comes from the <a href=https://github.com/llvm/llvm-project/blob/4fffbc150cca1638051b8ad2a20f4b8240df0869/clang/test/CodeGenCXX/microsoft-abi-member-pointers.cpp>LLVM test suite</a>
<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>B1</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>  <span style=color:#cf222e>void</span> <span style=color:#6639ba>foo</span><span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>  <span style=color:#cf222e>int</span> b<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>B2</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>  <span style=color:#cf222e>int</span> b2<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>  <span style=color:#cf222e>int</span> v<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>  <span style=color:#cf222e>void</span> <span style=color:#6639ba>foo</span><span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>UnspecWithVBPtr</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#cf222e>int</span> UnspecWithVBPtr<span style=color:#0550ae>::*</span>forceUnspecWithVBPtr<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>UnspecWithVBPtr</span> <span style=color:#0550ae>:</span> B1<span style=color:#1f2328>,</span> <span style=color:#cf222e>virtual</span> B2 <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>  <span style=color:#cf222e>int</span> u<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>  <span style=color:#cf222e>void</span> <span style=color:#6639ba>foo</span><span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#1f2328>};</span>
</span></span></code></pre></div><p><img src=msvc_fourth_field_e.png alt=VBPtrOffset></p><p>We can notice that the result of <code>sizeof()</code> applied to <code>UnspecWithVBPtr::foo</code> is <strong>24</strong>:
<code>sizeof(uintptr_t) + 3 * sizeof(int) + padding</code></p><h2 id=conclusion>Conclusion</h2><p>The profiler described in the first blog post works as expected for <strong>non-virtual</strong> but
does not work with virtual functions that follow the Itanium ABI. To work with virtual functions, we would need
to pass an extra parameter to the object that implements the virtual functions. By assuming that the vtable is
placed at the beginning of the object&rsquo;s layout, we can support such functions with the following modifications:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>diff --git a/main.cpp b/main.cpp
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>index d30a0c1..65d18eb 100644
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#82071e;background-color:#ffebe9>--- a/main.cpp
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#82071e;background-color:#ffebe9></span><span style=color:#116329;background-color:#dafbe1>+++ b/main.cpp
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#116329;background-color:#dafbe1></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#116329;background-color:#dafbe1>+struct Foo {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#116329;background-color:#dafbe1>+  virtual void bar() {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#116329;background-color:#dafbe1>+    std::cout &lt;&lt; &#34;In bar&#34; &lt;&lt; std::endl;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#116329;background-color:#dafbe1>+  }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#116329;background-color:#dafbe1>+  uint8_t x = 1;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#116329;background-color:#dafbe1>+};
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#116329;background-color:#dafbe1>+
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span><span style=color:#116329;background-color:#dafbe1></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>@@ -88,9 +95,10 @@ struct Profiler {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#82071e;background-color:#ffebe9>-  void setup() {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#82071e;background-color:#ffebe9>-    PROFILE(LIEF::ELF::Parser::init);
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span><span style=color:#82071e;background-color:#ffebe9>-    PROFILE(LIEF::ELF::Parser::parse_segments&lt;LIEF::ELF::ELF64&gt;);
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#82071e;background-color:#ffebe9></span><span style=color:#116329;background-color:#dafbe1>+  template&lt;class T&gt;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#116329;background-color:#dafbe1>+  void setup(const T&amp; obj) {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#116329;background-color:#dafbe1>+    const uintptr_t vtable = *reinterpret_cast&lt;const uintptr_t*&gt;(&amp;obj);
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#116329;background-color:#dafbe1>+    profile_func(&amp;Foo::bar, &#34;Foo:bar&#34;, vtable);
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#116329;background-color:#dafbe1></span>   }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>@@ -98,8 +106,13 @@ struct Profiler {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>   template&lt;typename Func&gt;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#82071e;background-color:#ffebe9>-  void profile_func(Func func, std::string name) {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#82071e;background-color:#ffebe9></span><span style=color:#116329;background-color:#dafbe1>+  void profile_func(Func func, std::string name, uintptr_t vtable = 0) {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:#116329;background-color:#dafbe1></span>     void* addr = cast_func(func);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span><span style=color:#116329;background-color:#dafbe1>+
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span><span style=color:#116329;background-color:#dafbe1>+    if (vtable &gt; 0) {
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span><span style=color:#116329;background-color:#dafbe1>+      const uintptr_t voff = reinterpret_cast&lt;uintptr_t&gt;(addr) - 1;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span><span style=color:#116329;background-color:#dafbe1>+      addr = *reinterpret_cast&lt;void**&gt;(vtable + voff);
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span><span style=color:#116329;background-color:#dafbe1>+    }
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span><span style=color:#116329;background-color:#dafbe1></span>     funcs[reinterpret_cast&lt;uintptr_t&gt;(addr)] = std::move(name);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>     gum_interceptor_begin_transaction (ctx_-&gt;interceptor);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>     gum_interceptor_attach (ctx_-&gt;interceptor,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>@@ -130,8 +143,9 @@ int main(int argc, const char** argv) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>     return 1;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>   }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span><span style=color:#116329;background-color:#dafbe1>+  Foo f;
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span><span style=color:#116329;background-color:#dafbe1></span>   Profiler&amp; prof = Profiler::get();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span><span style=color:#82071e;background-color:#ffebe9>-  prof.setup();
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span><span style=color:#82071e;background-color:#ffebe9>-  LIEF::ELF::Parser::parse(argv[1]);
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span><span style=color:#82071e;background-color:#ffebe9></span><span style=color:#116329;background-color:#dafbe1>+  prof.setup(f);
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span><span style=color:#116329;background-color:#dafbe1>+  f.bar();
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span><span style=color:#116329;background-color:#dafbe1></span>   return 0;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span> }
</span></span></code></pre></div><p>The Microsoft C++ ABI is poorly documented but the LLVM project is a good reference for that.
One might also be interested in this presentation (<a href=https://llvm.org/devmtg/2013-11/slides/Kleckner-ClangVisualC++.pdf>Bringing Clang and LLVM to Visual C++ users</a>)
that outlines the challenges for LLVM developers to support this ABI.</p><h2 id=acknowledgment>Acknowledgment</h2><p>Thanks to Julien Jorge for proofreading this post and his valuable feedback.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Which is still UB&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>There is an exception for the ARM architecture:</p><blockquote><p>In the 32-bit ARM representation, the this-adjustment stored in adj is left-shifted by one, and
the low bit of adj indicates whether ptr is a function pointer (including null) or the offset of a v-table entry.
A virtual member function pointer sets ptr to the v-table entry offset as if by <code>reinterpret_cast&lt;fnptr_t>(uintfnptr_t(offset))</code>.
A null member function pointer sets ptr to a null function pointer and must ensure that the low bit of adj is clear;
the upper bits of adj remain unspecified.</p></blockquote>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></li><li id=fn:3><p>A thunk function is generated by the compiler as a <em>trampoline</em> to the right virtual function. This
trampoline can also be used to fix <code>this</code> pointer with the given adjustor.&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p>The layout of this code goes beyond my understanding&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><div class="d-flex flex-column flex-sm-row align-items-center border-top border-gray-200 mt-6 py-5"><div class=media><div class="avatar mr-4"><img src=https://lief.re/img/avatar/romain.png class="avatar-image rounded-circle" alt=Avatar></div><div class=media-body><span class="text-darkblue text-uppercase-xs font-weight-bolder"><a href=https://www.romainthomas.fr target=_blank>Romain Thomas
</a></span><span class="text-muted font-size-sm d-block">Posted on April 8, 2021</span></div></div></div></div></div></div></section><footer class="footer footer-dark bg-dark"><div class="container text-center"><div class=row><div class="col-12 col-md"><h6 class="footer-header mb-4 pb-md-2">LIEF</h6><a href=https://github.com/lief-project/LIEF class=footer-link>Github
</a><a href=https://lief.re//download class="footer-link mt-2">Download
</a><a href=https://lief.re//doc/latest class="footer-link mt-2">Documentation</a></div><div class="col-12 col-md mt-5 mt-md-0"><h6 class="footer-header mb-4 pb-md-2">Quarkslab</h6><a href=https://blog.quarkslab.com/ class=footer-link>Blog
</a><a href=https://quarkslab.com/ class="footer-link mt-2">Website</a></div><div class="col-12 col-md mt-5 mt-md-0"><h6 class="footer-header mb-4 pb-md-2">Other Tools</h6><a href=https://qbdi.quarkslab.com/ class=footer-link>QBDI
</a><a href=https://triton.quarkslab.com/ class="footer-link mt-2">Triton</a></div></div><div class="d-flex justify-content-center mt-6"><a href=https://infosec.exchange/@rh0main class="hover-lift-light text-decoration-none mx-2"><span class="icon-circle footer-social-icon"><i class="fab fa-mastodon fa-lg"></i>
</span></a><a href=https://x.com/lief_project class="hover-lift-light text-decoration-none mx-2"><span class="icon-circle footer-social-icon"><i class="fab fa-x-twitter fa-lg"></i>
</span></a><a href=https://crates.io/crates/lief class="hover-lift-light text-decoration-none mx-2"><span class="icon-circle footer-social-icon"><i class="fab fa-rust fa-lg"></i>
</span></a><a href=https://pypi.org/project/lief/ class="hover-lift-light text-decoration-none mx-2"><span class="icon-circle footer-social-icon"><i class="fab fa-python fa-lg"></i>
</span></a><a href=https://github.com/lief-project/LIEF class="hover-lift-light text-decoration-none mx-2"><span class="icon-circle footer-social-icon"><i class="fab fa-github fa-lg"></i>
</span></a><a href=https://discord.gg/jGQtyAYChJ class="hover-lift-light text-decoration-none mx-2"><span class="icon-circle footer-social-icon"><i class="fab fa-discord fa-lg"></i></span></a></div></div></footer><script src=https://lief.re//js/vendor.min.js></script><script src=https://lief.re//js/theme.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js></script><script>$("#copy").tooltip({trigger:"click",placement:"bottom"});function setTooltip(e){$("#copy").tooltip("hide").attr("data-original-title",e).tooltip("show")}function hideTooltip(){setTimeout(function(){$("#copy").tooltip("hide")},1e3)}var clipboard=new ClipboardJS("#copy");clipboard.on("success",function(){setTooltip("Copied!"),hideTooltip()}),clipboard.on("error",function(){setTooltip("Failed!"),hideTooltip()})</script></body></html>